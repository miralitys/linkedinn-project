{% extends "base.html" %}
{% block title %}{{ tr.reddit_title }} — MyVOICE's{% endblock %}
{% block content %}
<div class="news-page-wrap reddit-premium-shell">
<header class="news-page-header">
  <div class="news-header-top">
    <h1 class="news-page-title">{{ tr.reddit_title }}</h1>
    <button type="button" id="reddit-refresh-btn" class="btn secondary btn-icon-text news-refresh-btn" aria-label="{{ tr.reddit_refresh }}" title="{{ tr.reddit_refresh }}">
      <span class="refresh-icon" aria-hidden="true">↻</span>
      <span class="refresh-text">{{ tr.reddit_refresh }}</span>
    </button>
  </div>
  <p class="news-header-desc">{{ tr.reddit_lead }}</p>
  <div class="news-toolbar-row news-toolbar-row-reddit">
    <div class="reddit-subreddit-block">
      <label class="news-toolbar-label" for="reddit-subreddit-search">{{ tr.reddit_subreddit|default('Subreddit' if locale == 'en' else 'Сабреддит', true) }}</label>
      <div class="reddit-subreddit-search-wrap">
        <input type="text" id="reddit-subreddit-search" class="reddit-subreddit-search" placeholder="{{ tr.reddit_subreddit_placeholder }}" aria-label="{{ tr.reddit_subreddit }}" autocomplete="off" aria-autocomplete="list" aria-expanded="false" aria-controls="reddit-subreddit-autocomplete">
        <span class="reddit-subreddit-search-chevron" aria-hidden="true">▼</span>
        <div id="reddit-subreddit-autocomplete" class="reddit-subreddit-autocomplete" role="listbox" aria-hidden="true"></div>
      </div>
      <div id="reddit-subreddit-tags" class="reddit-subreddit-tags"></div>
    </div>
    <div class="news-toolbar-field">
      <label class="news-toolbar-label" for="reddit-score-filter">{{ tr.reddit_score|default('Score', true) }}</label>
      <select id="reddit-score-filter" class="news-toolbar-select" aria-label="{{ tr.reddit_score }}">
        <option value="">{{ tr.reddit_score_all }}</option>
        <option value="blue">{{ tr.reddit_score_blue }}</option>
        <option value="green">{{ tr.reddit_score_green }}</option>
        <option value="yellow">{{ tr.reddit_score_yellow }}</option>
        <option value="red">{{ tr.reddit_score_red }}</option>
      </select>
    </div>
    <div class="news-toolbar-field">
      <label class="news-toolbar-label" for="reddit-sort">{{ tr.reddit_sort|default('Sort' if locale == 'en' else 'Сортировка', true) }}</label>
      <select id="reddit-sort" class="news-toolbar-select" aria-label="{{ tr.reddit_sort }}">
        <option value="desc">{{ tr.posts_newest_first }}</option>
        <option value="asc">{{ tr.posts_oldest_first }}</option>
      </select>
    </div>
    <div class="news-toolbar-field">
      <label class="news-toolbar-label" for="reddit-period">{{ tr.reddit_period|default('Period' if locale == 'en' else 'Период', true) }}</label>
      <select id="reddit-period" class="news-toolbar-select" aria-label="{{ tr.reddit_period }}">
        <option value="">{{ tr.posts_all_time }}</option>
        <option value="week">{{ tr.posts_week }}</option>
        <option value="month">{{ tr.posts_month }}</option>
      </select>
    </div>
  </div>
</header>

<div id="reddit-feed" class="news-feed">
  <div id="reddit-loading" class="news-loading-skeleton" style="display: none;" aria-live="polite">
    <div class="news-skeleton-card"></div>
    <div class="news-skeleton-card"></div>
    <div class="news-skeleton-card"></div>
    <div class="news-skeleton-card"></div>
    <div class="news-skeleton-card"></div>
    <div class="news-skeleton-card"></div>
  </div>
  <div id="reddit-list"></div>
  <div id="reddit-empty" class="news-empty-state" style="display: none;">
    <div class="news-empty-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3.5" y="4.5" width="17" height="15" rx="2"/><path d="M7 9h10M7 13h6"/></svg>
    </div>
    <p class="news-empty-title">{{ tr.reddit_empty_title }}</p>
    <p class="news-empty-desc" id="reddit-empty-desc">{{ tr.reddit_empty_desc }}</p>
    <button type="button" id="reddit-empty-retry" class="btn secondary">{{ tr.reddit_refresh }}</button>
  </div>
  <div id="reddit-error" class="news-error-state" style="display: none;">
    <p class="news-error-text">{{ tr.reddit_error }}</p>
    <p id="reddit-error-detail" class="news-error-detail"></p>
    <button type="button" id="reddit-error-retry" class="btn secondary">{{ tr.reddit_retry }}</button>
  </div>
</div>
</div>

<div id="view-reddit-modal" class="news-view-drawer" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="view-reddit-modal-title">
  <div class="news-view-backdrop" id="view-reddit-backdrop"></div>
  <div class="news-view-panel" id="view-reddit-drawer-panel">
    <div class="news-view-header">
      <div class="news-view-header-top">
        <span class="news-view-header-label" aria-hidden="true">Reddit</span>
        <div class="news-view-header-actions">
          <a id="view-reddit-link-header" href="#" target="_blank" rel="noopener" class="news-view-open-link link-tertiary" title="{{ tr.open_original }}" aria-label="{{ tr.open_original }}" style="display: none;">{{ tr.open_original }} <span aria-hidden="true">↗</span></a>
          <button type="button" class="news-view-close" id="view-reddit-drawer-close" aria-label="{{ tr.common_close }}">×</button>
        </div>
      </div>
      <h2 id="view-reddit-modal-title" class="news-view-title"></h2>
    </div>
    <div class="news-view-meta" id="view-reddit-meta-row">
      <span id="view-reddit-score-wrap" style="display: none; margin-left: var(--space-3);">
        <span id="view-reddit-score" class="news-card-score-loading" title="{{ tr.news_relevance_loading }}">—</span>
        <button type="button" id="view-reddit-score-refresh" class="news-score-refresh-btn" title="{{ tr.news_refresh_score }}" style="display: none; margin-left: var(--space-2);" aria-label="{{ tr.news_refresh_score }}">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
        </button>
      </span>
    </div>
    <div class="news-view-source" id="view-reddit-source-row" style="display: none;"></div>
    <div class="news-view-scroll-wrap">
      <div id="view-reddit-content" class="news-view-body"></div>
      <div class="view-post-rewrite-block">
      <div class="view-post-rewrite-header">
        <h3 class="view-post-rewrite-title">{{ tr.reddit_rewrite_title }}</h3>
        <p class="view-post-rewrite-desc">{{ tr.reddit_rewrite_desc }}</p>
      </div>
      <div class="view-post-rewrite-form">
        <div class="view-post-rewrite-fields">
          <div class="view-post-rewrite-field">
            <label for="view-reddit-author-select">{{ tr.reddit_as_author }}</label>
            <select id="view-reddit-author-select" aria-label="{{ tr.reddit_author }}"><option value="">{{ tr.reddit_loading }}</option></select>
          </div>
          <div class="view-post-rewrite-field">
            <label for="view-reddit-goal">{{ tr.reddit_goal }}</label>
            <select id="view-reddit-goal" aria-label="{{ tr.reddit_goal }}"><option value="network">Network</option><option value="native_ads">{{ tr.reddit_goal_native }}</option><option value="full_ads">{{ tr.reddit_goal_full }}</option></select>
          </div>
          <div class="view-post-rewrite-field view-post-rewrite-field-length">
            <label for="view-reddit-length">{{ tr.reddit_length }}</label>
            <select id="view-reddit-length" aria-label="{{ tr.reddit_length }}"><option value="short">{{ tr.reddit_length_short }}</option><option value="medium" selected>{{ tr.reddit_length_medium }}</option><option value="long">{{ tr.reddit_length_long }}</option></select>
          </div>
          <button type="button" id="view-reddit-rewrite-btn" class="btn primary view-post-rewrite-btn" aria-label="{{ tr.reddit_rewrite_btn }}">{{ tr.reddit_rewrite_btn }}</button>
          <button type="button" id="view-reddit-copy-btn" class="btn secondary btn-sm view-post-copy-btn view-post-rewrite-btn">{{ tr.reddit_copy }}</button>
        </div>
        <div id="view-reddit-generate-progress" class="generate-progress" style="display: none;" aria-live="off">
          <div class="generate-progress-head">
            <span class="generate-progress-title">{{ tr.posts_gen_progress_title }}</span>
            <span id="view-reddit-generate-progress-time" class="generate-progress-time">0:00</span>
          </div>
          <div id="view-reddit-generate-progress-track" class="generate-progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="{{ tr.posts_gen_progress_title }}">
            <span id="view-reddit-generate-progress-fill" class="generate-progress-fill" style="width: 0%;"></span>
          </div>
          <ul id="view-reddit-generate-progress-steps" class="generate-progress-steps"></ul>
          <p id="view-reddit-generate-progress-note" class="generate-progress-note"></p>
        </div>
        <div class="view-post-rewrite-output">
          <div class="view-post-rewrite-output-header">
            <span class="view-post-rewrite-result-label">{{ tr.reddit_result }}</span>
            <span id="view-reddit-char-count" class="view-post-char-count" style="font-size: var(--text-12); color: var(--text-muted);"></span>
          </div>
          <textarea id="view-reddit-write-textarea" rows="4" placeholder="{{ tr.reddit_result_placeholder }}"></textarea>
        </div>
      </div>
    </div>
    </div>
  </div>
</div>

<style>
  /* Shared News/Reddit design */
  .news-page-wrap { margin-top: 0; }
  .news-page-header { margin-bottom: var(--space-6); }
  .news-header-top { display: flex; align-items: center; justify-content: space-between; gap: var(--space-4); margin-bottom: var(--space-2); }
  .news-page-title { font-size: 1.375rem; font-weight: 700; margin: 0; color: var(--text); letter-spacing: -0.02em; }
  .news-header-desc { margin: 0 0 var(--space-4); font-size: var(--text-14); color: var(--text-muted); line-height: 1.55; max-width: 48rem; }
  .news-toolbar-row { display: flex; align-items: flex-start; gap: var(--space-4); row-gap: var(--space-3); flex-wrap: wrap; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space-3) var(--space-4); }
  .news-toolbar-row-reddit { align-items: flex-start; }
  .news-toolbar-row-reddit .news-toolbar-field { gap: var(--space-2); flex: 0 0 auto; min-width: 180px; }
  .news-toolbar-row-reddit .reddit-subreddit-block { gap: var(--space-2); }
  .news-toolbar-field { display: flex; flex-direction: column; gap: var(--space-1); min-width: 180px; }
  .news-toolbar-label { font-size: 0.8125rem; font-weight: 500; color: var(--text-muted); margin: 0; text-transform: none; letter-spacing: 0; line-height: 1.2; }
  .news-toolbar-select { min-width: 160px; height: 2.25rem; padding: 0 var(--space-3); font-size: var(--text-14); border: 1px solid var(--border); border-radius: var(--radius-sm); background: #fff; color: var(--text); box-sizing: border-box; margin-bottom: 0; }
  .news-toolbar-select:focus { outline: none; border-color: var(--primary); box-shadow: var(--focus-ring); }
  .btn-icon-text { display: inline-flex; align-items: center; gap: var(--space-2); }
  .news-refresh-btn { height: 2.25rem; padding: 0 var(--space-4); }
  .news-header-top .btn { margin: 0; border-radius: 10px; box-shadow: none; }
  .news-header-top .btn.secondary { border: 1px solid var(--border); background: var(--surface); color: var(--text); }
  .news-header-top .btn.secondary:hover { background: #f8fafc; box-shadow: none; }
  .news-feed { margin-top: 0; }
  .news-loading-skeleton { display: flex; flex-direction: column; gap: var(--space-4); padding: var(--space-4) 0; }
  .news-skeleton-card { height: 160px; border-radius: var(--radius-lg); background: linear-gradient(90deg, var(--border) 25%, var(--surface) 50%, var(--border) 75%); background-size: 200% 100%; animation: news-skeleton-shine 1.2s ease-in-out infinite; }
  @keyframes news-skeleton-shine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  .news-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 18px 18px 16px; margin-bottom: 12px; cursor: pointer; transition: box-shadow var(--motion-normal), border-color var(--motion-fast), transform var(--motion-fast); box-shadow: 0 1px 2px rgba(15,23,42,0.04); position: relative; overflow: hidden; }
  .news-card::before { content: none; }
  .news-card:hover { box-shadow: 0 5px 14px rgba(15,23,42,0.08); border-color: #cfd8e6; transform: translateY(-1px); }
  .news-card-title { font-size: 1.015rem; font-weight: 650; margin: 0 0 8px; line-height: 1.35; color: var(--text); letter-spacing: -0.01em; }
  .news-card-title a { color: inherit; text-decoration: none; }
  .news-card-title a:hover { color: var(--primary); }
  .news-card-top { display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); margin-bottom: 10px; }
  .news-card-meta { font-size: 0.8125rem; color: var(--text-muted); }
  .news-card-meta a { color: inherit; text-decoration: none; }
  .news-card-meta a:hover { color: var(--primary); }
  .news-card-open-reddit { display: inline-flex; align-items: center; gap: var(--space-1); font-size: 0.8125rem; color: var(--text-muted); text-decoration: none; padding: 2px 8px; border-radius: 8px; transition: color var(--motion-fast), background var(--motion-fast); }
  .news-card-open-reddit:hover { color: var(--primary); background: #f8fafc; text-decoration: none; }
  .news-card-open-reddit:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .news-card-body { margin-bottom: 8px; }
  .news-card-title { font-size: 1.015rem; font-weight: 650; margin: 0 0 8px; line-height: 1.35; color: var(--text); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .news-card-title a { color: inherit; text-decoration: none; }
  .news-card-title a:hover { color: var(--primary); }
  .news-card-summary { font-size: 0.92rem; line-height: 1.58; color: var(--text-secondary); margin: 0; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  .news-card-footer { display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); flex-wrap: wrap; margin-top: 10px; padding-top: 10px; border-top: 1px solid #edf2f7; }
  .news-card-footer-left { display: flex; align-items: center; gap: var(--space-3); font-size: 0.78rem; color: var(--text-muted); }
  .news-card-footer-left button { background: none; border: none; padding: 0; font-size: 0.78rem; color: #1d4ed8; cursor: pointer; font-weight: 600; margin: 0; }
  .news-card-footer-left button:hover { text-decoration: underline; }
  .news-card-footer-left button:focus-visible { outline: none; border-radius: var(--radius-sm); box-shadow: var(--focus-ring); }
  .news-card-actions { display: flex; align-items: center; gap: var(--space-2); flex-shrink: 0; }
  .news-card-actions .btn { margin: 0; border-radius: 10px; box-shadow: none; height: 36px; padding: 0 12px; line-height: 36px; font-size: 0.75rem; font-weight: 600; }
  .news-card-actions .btn.primary:hover { box-shadow: none; }
  .news-card-actions .news-card-score,
  .news-card-actions .news-card-score-loading { margin-right: 0; }
  .news-card-link-icon { flex-shrink: 0; color: var(--text-muted); }
  .news-card-link-icon:hover { color: var(--primary); }
  .news-card-link-corner { flex-shrink: 0; min-width: 28px; min-height: 28px; padding: 0; border: none; background: transparent; color: var(--text-muted); border-radius: 0; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; transition: color var(--motion-fast); font-size: 1.1rem; line-height: 1; }
  .news-card-link-corner:hover { background: transparent; color: var(--primary); text-decoration: none; }
  .news-card-link-corner:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .news-card-top-right-wrap { display: flex; align-items: center; gap: var(--space-2); flex-shrink: 0; }
  .news-empty-state, .news-error-state { text-align: center; padding: var(--space-10); background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
  .news-empty-title, .news-error-text { margin: 0 0 var(--space-2); font-weight: 600; font-size: var(--text-16); color: var(--text); }
  .news-empty-desc, .news-error-detail { margin: 0 0 var(--space-4); color: var(--text-muted); font-size: var(--text-14); line-height: 1.5; }
  .news-view-drawer { position: fixed; inset: 0; z-index: 100; display: none; pointer-events: none; }
  .news-view-drawer.is-open { display: block; pointer-events: auto; }
  .news-view-backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.45); backdrop-filter: blur(6px); opacity: 0; transition: opacity 0.3s ease; }
  .news-view-drawer.is-open .news-view-backdrop { opacity: 1; }
  .news-view-panel { position: absolute; top: 0; right: 0; width: 65vw; max-width: 1200px; height: 100%; background: var(--surface); transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: -12px 0 48px rgba(0,0,0,0.12), -4px 0 16px rgba(0,0,0,0.06); overflow: hidden; }
  .news-view-drawer.is-open .news-view-panel { transform: translateX(0); }
  .news-view-header { padding: var(--space-4) var(--space-6) var(--space-5); border-bottom: 1px solid var(--border); flex-shrink: 0; background: var(--surface); }
  .news-view-header-top { display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); margin-bottom: var(--space-3); }
  .news-view-header-label { font-size: var(--text-12); font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
  .news-view-header-actions { display: flex; align-items: center; gap: var(--space-2); flex-shrink: 0; }
  .news-view-title { margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text); line-height: 1.35; letter-spacing: -0.02em; }
  .news-view-link-icon { flex-shrink: 0; color: var(--text-muted); }
  .news-view-link-icon:hover { color: var(--primary); }
  .news-view-open-link { font-size: var(--text-14); font-weight: 500; white-space: nowrap; }
  .news-view-open-link.link-tertiary { color: var(--primary); background: none; border: none; padding: 0; text-decoration: none; cursor: pointer; }
  .news-view-open-link.link-tertiary:hover { text-decoration: underline; }
  .news-view-open-link.link-tertiary:focus-visible { outline: none; border-radius: var(--radius-sm); box-shadow: var(--focus-ring); }
  .news-view-close { min-width: 32px; min-height: 32px; padding: 0; border: none; background: transparent; color: var(--text-muted); font-size: 1.25rem; line-height: 1; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: color var(--motion-fast), background var(--motion-fast); }
  .news-view-close:hover { background: var(--bg); color: var(--text); }
  .news-view-close:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .news-view-meta { padding: var(--space-2) var(--space-6); font-size: var(--text-14); color: var(--text-muted); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .news-view-source { padding: var(--space-2) var(--space-6); font-size: var(--text-14); color: var(--text-muted); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .news-view-source a { color: var(--primary); font-weight: 500; }
  .news-view-source a:hover { text-decoration: underline; }
  .news-view-scroll-wrap { flex: 1; min-height: 0; overflow-y: auto; }
  .news-view-body { padding: var(--space-6); font-size: var(--text-16); line-height: 1.7; color: var(--text); }
  .news-view-body p { margin: 0 0 var(--space-4); }
  .news-view-body p:last-child { margin-bottom: 0; }
  .reddit-subreddit-block { display: flex; flex-direction: column; gap: var(--space-2); min-width: 260px; flex: 0 1 360px; max-width: 360px; }
  .reddit-subreddit-search-wrap { position: relative; display: flex; align-items: center; }
  .reddit-subreddit-search { width: 100%; height: 2.25rem; padding: 0 var(--space-3); padding-right: 2rem; font-size: var(--text-14); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface); color: var(--text); box-sizing: border-box; }
  .reddit-subreddit-search:focus { outline: none; border-color: var(--primary); box-shadow: var(--focus-ring); }
  .reddit-subreddit-search::placeholder { color: var(--text-muted); }
  .reddit-subreddit-search-chevron { position: absolute; right: var(--space-2); top: 50%; transform: translateY(-50%); font-size: 0.65rem; color: var(--text-muted); pointer-events: none; }
  .reddit-subreddit-search-wrap:has(.reddit-subreddit-autocomplete.is-open) .reddit-subreddit-search-chevron { transform: translateY(-50%) rotate(180deg); }
  .reddit-subreddit-autocomplete { position: absolute; top: 100%; left: 0; right: 0; margin-top: 2px; z-index: 50; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto; display: none; }
  .reddit-subreddit-autocomplete.is-open { display: block; }
  .reddit-subreddit-autocomplete [role="option"] { padding: 8px 12px; font-size: var(--text-14); cursor: pointer; color: var(--text); display: flex; align-items: center; gap: var(--space-2); }
  .reddit-subreddit-autocomplete [role="option"]:hover, .reddit-subreddit-autocomplete [role="option"][aria-selected="true"] { background: var(--bg); }
  .reddit-subreddit-autocomplete [role="option"].reddit-ac-no-results { color: var(--text-muted); cursor: default; }
  .reddit-subreddit-autocomplete [role="option"] .reddit-ac-checkbox { width: 1rem; height: 1rem; flex-shrink: 0; accent-color: var(--primary); cursor: pointer; pointer-events: none; }
  .reddit-subreddit-autocomplete [role="option"] .reddit-ac-label { flex: 1; }
  .reddit-subreddit-tags { display: flex; flex-wrap: wrap; gap: var(--space-1); margin-top: var(--space-1); }
  .reddit-subreddit-tag { display: inline-flex; align-items: center; gap: var(--space-1); font-size: var(--text-12); line-height: 1.25; padding: 2px 8px; border-radius: 999px; border: 1px solid #bfdbfe; background: #ebf3ff; color: #1d4ed8; font-weight: 600; }
  .reddit-subreddit-tag button { padding: 0; width: 14px; height: 14px; border: none; background: transparent; color: inherit; cursor: pointer; border-radius: 2px; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; line-height: 0; flex-shrink: 0; opacity: 0.8; }
  .reddit-subreddit-tag button:hover { opacity: 1; background: rgba(0,0,0,0.1); }
  .view-post-rewrite-block { flex-shrink: 0; margin: var(--space-3) var(--space-4) var(--space-4); padding: var(--space-4); background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
  .view-post-rewrite-header { margin-bottom: var(--space-2); padding-bottom: var(--space-2); border-bottom: 1px solid var(--border); }
  .view-post-rewrite-title { margin: 0 0 var(--space-1); font-size: var(--text-14); font-weight: 600; color: var(--text); }
  .view-post-rewrite-desc { margin: 0; font-size: var(--text-12); color: var(--text-muted); line-height: 1.45; }
  .view-post-rewrite-form { display: flex; flex-direction: column; gap: var(--space-2); }
  .view-post-rewrite-fields { display: flex; flex-wrap: wrap; align-items: center; gap: var(--space-2); }
  .view-post-rewrite-field { flex: 1 1 0; min-width: 95px; max-width: 170px; display: flex; flex-direction: column; gap: 2px; }
  .view-post-rewrite-field-length { max-width: 210px; }
  .view-post-rewrite-field label { font-size: var(--text-12); font-weight: 500; color: var(--text-muted); margin: 0; }
  .view-post-rewrite-field select { height: 2.25rem; padding: 0 var(--space-2); font-size: var(--text-14); border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); color: var(--text); box-sizing: border-box; max-width: 100%; transition: border-color var(--motion-fast), box-shadow var(--motion-fast); }
  .view-post-rewrite-field select:hover { border-color: var(--text-muted); }
  .view-post-rewrite-field select:focus { outline: none; border-color: var(--primary); box-shadow: var(--focus-ring); }
  .view-post-rewrite-btn { height: 2.25rem; padding: 0 var(--space-4); font-weight: 600; flex-shrink: 0; }
  .view-post-rewrite-btn.view-post-copy-btn { height: 2.25rem; padding: 0 var(--space-3); }
  #view-reddit-rewrite-btn { margin-left: auto; }
  .view-post-rewrite-output { display: flex; flex-direction: column; gap: var(--space-1); }
  .view-post-rewrite-output-header { display: flex; align-items: center; justify-content: space-between; gap: var(--space-2); }
  .view-post-rewrite-result-label { font-size: var(--text-12); font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
  .view-post-rewrite-block textarea { width: 100%; min-height: 3.5rem; padding: var(--space-2) var(--space-3); font-family: inherit; font-size: var(--text-14); line-height: 1.55; color: var(--text); border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg); resize: vertical; box-sizing: border-box; display: block; transition: border-color var(--motion-fast), box-shadow var(--motion-fast); }
  .view-post-rewrite-block textarea:hover { border-color: var(--text-muted); }
  .view-post-rewrite-block textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
  .view-post-rewrite-block textarea::placeholder { color: var(--text-muted); }
  .view-post-copy-btn { flex-shrink: 0; }
  .view-post-char-count {
    font-size: var(--text-12);
    color: var(--text-muted);
    white-space: nowrap;
  }
  .view-post-char-count-valid {
    color: var(--success, #10b981);
  }
  .view-post-char-count-too-short,
  .view-post-char-count-too-long {
    color: var(--error, #ef4444);
    font-weight: 500;
  }
  .generate-progress {
    margin-top: var(--space-2);
    padding: var(--space-3);
    border: 1px solid #dbe3f1;
    border-radius: var(--radius);
    background: #f8fafc;
  }
  .generate-progress.is-done {
    border-color: #bbf7d0;
    background: #f0fdf4;
  }
  .generate-progress.is-error {
    border-color: #fecaca;
    background: #fef2f2;
  }
  .generate-progress-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
  }
  .generate-progress-title {
    font-size: var(--text-12);
    font-weight: 600;
    color: var(--text);
  }
  .generate-progress-time {
    font-size: var(--text-12);
    color: var(--text-muted);
    font-variant-numeric: tabular-nums;
  }
  .generate-progress-track {
    position: relative;
    height: 6px;
    border-radius: 999px;
    background: #e2e8f0;
    overflow: hidden;
  }
  .generate-progress-fill {
    display: block;
    height: 100%;
    width: 0;
    border-radius: inherit;
    background: linear-gradient(90deg, #6366f1, #818cf8);
    transition: width 0.35s ease;
  }
  .generate-progress-steps {
    margin: var(--space-3) 0 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: var(--space-1);
  }
  .generate-progress-step {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-12);
    color: var(--text-muted);
    line-height: 1.35;
  }
  .generate-progress-step-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #cbd5e1;
    flex-shrink: 0;
  }
  .generate-progress-step.is-active {
    color: var(--primary);
    font-weight: 600;
  }
  .generate-progress-step.is-active .generate-progress-step-dot {
    background: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.16);
  }
  .generate-progress-step.is-done {
    color: var(--success, #10b981);
  }
  .generate-progress-step.is-done .generate-progress-step-dot {
    background: var(--success, #10b981);
  }
  .generate-progress-step.is-error {
    color: var(--error, #ef4444);
  }
  .generate-progress-step.is-error .generate-progress-step-dot {
    background: var(--error, #ef4444);
  }
  .generate-progress-note {
    margin: var(--space-2) 0 0;
    font-size: 0.72rem;
    line-height: 1.4;
    color: var(--text-muted);
  }
  .generate-progress.is-done .generate-progress-note {
    color: var(--success, #10b981);
    font-weight: 600;
  }
  .generate-progress.is-error .generate-progress-note {
    color: var(--error, #ef4444);
    font-weight: 500;
  }
  .news-card-score {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 3.2rem;
    height: 1.6rem;
    padding: 0 10px;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 999px;
    border: 1px solid;
  }
  /* 0-30: красный */
  .news-card-score.score-red {
    background: #fee2e2;
    color: #dc2626;
    border-color: #dc2626;
  }
  /* 31-60: желтый */
  .news-card-score.score-yellow {
    background: #fef3c7;
    color: #d97706;
    border-color: #d97706;
  }
  /* 61-80: зеленый */
  .news-card-score.score-green {
    background: #d1fae5;
    color: #10b981;
    border-color: #10b981;
  }
  /* 81+: синий */
  .news-card-score.score-blue {
    background: #dbeafe;
    color: #2563eb;
    border-color: #2563eb;
  }
  .news-card-score-loading {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2.5rem;
    height: 1.6rem;
    padding: 0 10px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    border-radius: 999px;
    background: #f8fafc;
    border: 1px solid var(--border);
  }
  .news-score-refresh-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    padding: 0;
    border: none;
    background: var(--bg);
    color: var(--text-muted);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background var(--motion-fast), color var(--motion-fast);
  }
  .news-score-refresh-btn:hover:not(:disabled) {
    background: var(--primary-soft);
    color: var(--primary);
  }
  .news-score-refresh-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .news-score-refresh-btn:focus-visible {
    outline: none;
    box-shadow: var(--focus-ring);
  }
  .reddit-status-badge { font-size: 0.6875rem; font-weight: 600; padding: 4px 10px; border-radius: 999px; line-height: 1.2; cursor: pointer; position: relative; border: 1px solid transparent; }
  .reddit-status-badge.status-new { background: #f8fafc; border-color: #e2e8f0; color: #64748b; }
  .reddit-status-badge.status-in_progress { background: #ebf3ff; border-color: #bfdbfe; color: #1d4ed8; }
  .reddit-status-badge.status-done { background: #e9f9f0; border-color: #bbf7d0; color: #047857; }
  .reddit-status-badge.status-hidden { background: #f8fafc; border-color: #e2e8f0; color: #64748b; }
  .reddit-status-dropdown { position: absolute; top: 100%; left: 0; margin-top: 4px; z-index: 20; min-width: 132px; background: #fff; border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: 0 8px 20px rgba(15,23,42,0.10); padding: 4px 0; display: none; }
  .reddit-status-dropdown.is-open { display: block; }
  .reddit-status-dropdown button { display: block; width: 100%; padding: 6px 10px; text-align: left; font-size: var(--text-12); background: none; border: none; cursor: pointer; color: var(--text); }
  .reddit-status-dropdown button:hover { background: #f8fafc; }
  .reddit-status-wrap { position: relative; display: inline-block; }

  /* Premium system overrides */
  .main-wrap { padding: 32px !important; background: #f9fafb; }
  .reddit-premium-shell { max-width: 1160px; margin: 0 auto; }
  .news-page-title { font-size: 28px; line-height: 32px; font-weight: 700; color: #111827; }
  .news-header-desc { font-size: 14px; line-height: 20px; color: #4b5563; max-width: 760px; }
  .news-header-top { margin-bottom: 8px; }
  .news-header-top .btn { margin: 0; height: 40px; border-radius: 12px; box-shadow: none; }
  .news-header-top .btn.secondary {
    border: 1px solid #d1d5db;
    background: #ffffff;
    color: #111827;
    transition: background 200ms ease-out, border-color 200ms ease-out, transform 120ms ease-out;
  }
  .news-header-top .btn.secondary:hover { background: #f9fafb; border-color: #cbd5e1; }
  .news-header-top .btn.secondary:active { transform: scale(0.98); }
  .news-refresh-btn.is-loading .refresh-icon { animation: premium-refresh-spin 0.9s linear infinite; }
  @keyframes premium-refresh-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  .news-toolbar-row {
    min-height: 48px;
    padding: 12px 16px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    box-shadow: none;
    display: grid;
    grid-template-columns: minmax(320px, 1.4fr) repeat(3, minmax(180px, 1fr));
    gap: 12px;
    align-items: start;
  }
  .news-toolbar-field { min-width: 0; display: flex; flex-direction: column; gap: 6px; }
  .news-toolbar-label {
    font-size: 12px;
    font-weight: 500;
    line-height: 1.2;
    text-transform: none;
    letter-spacing: 0;
    color: #6b7280;
  }
  .news-toolbar-select,
  .reddit-subreddit-search {
    height: 40px;
    border-radius: 12px;
    border: 1px solid #d1d5db;
    background: #ffffff;
    color: #111827;
    font-size: 14px;
    box-sizing: border-box;
    margin: 0;
    box-shadow: none;
  }
  .news-toolbar-select,
  .reddit-subreddit-search { padding: 0 14px; }
  .reddit-subreddit-search { padding-right: 34px; }
  .news-toolbar-select { width: 100%; min-width: 0; }
  .reddit-subreddit-search::placeholder { color: #9ca3af; }
  .news-toolbar-select:focus,
  .reddit-subreddit-search:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.18);
    outline: none;
  }
  .news-toolbar-row-reddit .news-toolbar-field { width: 100%; min-width: 0; }
  .reddit-subreddit-block { min-width: 0; max-width: none; width: 100%; flex: 1 1 auto; gap: 6px; }
  .reddit-subreddit-tags { min-height: 0; margin-top: 4px; }
  .reddit-subreddit-tags:empty { display: none; margin-top: 0; }
  .reddit-subreddit-search-chevron { right: 12px; font-size: 0.65rem; color: #6b7280; }
  .reddit-subreddit-autocomplete {
    top: auto;
    bottom: calc(100% + 8px);
    margin-top: 0;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    z-index: 60;
  }
  .reddit-subreddit-autocomplete [role="option"] { padding: 8px 12px; font-size: 13px; font-weight: 500; }

  .news-loading-skeleton { gap: 16px; padding: 12px 0; }
  .news-skeleton-card {
    height: 164px;
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    background: linear-gradient(90deg, #f3f4f6 20%, #ffffff 50%, #f3f4f6 80%);
    background-size: 220% 100%;
    box-shadow: none;
  }
  .news-card {
    position: relative;
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    padding: 20px 24px;
    margin-bottom: 16px;
    box-shadow: none;
    cursor: pointer;
    overflow: visible;
    transition: border-color 200ms ease-out, transform 200ms ease-out, box-shadow 200ms ease-out;
  }
  .news-card:hover { border-color: #cbd5e1; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.04); }
  .news-card-top { margin-bottom: 12px; }
  .news-card-meta { font-size: 13px; line-height: 18px; font-weight: 500; color: #6b7280; }
  .news-card-open-reddit { font-size: 12px; line-height: 16px; font-weight: 500; color: #6b7280; border-radius: 10px; padding: 4px 8px; }
  .news-card-open-reddit:hover { color: #111827; background: #f9fafb; }
  .news-card-title {
    margin: 0 0 8px;
    font-size: 17px;
    line-height: 1.25;
    font-weight: 600;
    color: #111827;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
  }
  .news-card-summary {
    margin: 0;
    font-size: 14px;
    line-height: 20px;
    font-weight: 400;
    color: #4b5563;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 4;
    overflow: hidden;
  }
  .news-card-summary-wrap { position: relative; }
  .news-card-summary-wrap::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    height: 18px;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0), #ffffff 88%);
    pointer-events: none;
  }
  .news-card-footer {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid #e5e7eb;
    min-height: 46px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
  }
  .news-card-footer-left { display: flex; align-items: center; gap: 12px; min-height: 40px; }
  .reddit-metrics { display: inline-flex; align-items: center; gap: 12px; }
  .reddit-metric {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    line-height: 16px;
    font-weight: 500;
    color: #6b7280;
  }
  .reddit-metric svg { width: 16px; height: 16px; stroke: currentColor; stroke-width: 1.5; fill: none; }
  .news-card-read-more {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    line-height: 16px;
    font-weight: 500;
    color: #4f46e5;
    background: none;
    border: none;
    margin: 0;
    padding: 0;
    cursor: pointer;
  }
  .news-card-read-more svg { width: 14px; height: 14px; stroke: currentColor; stroke-width: 1.5; fill: none; }
  .news-card-actions { display: flex; align-items: center; gap: 8px; }
  .news-card-actions .btn {
    height: 40px;
    line-height: 40px;
    border-radius: 12px;
    padding: 0 14px;
    margin: 0;
    box-shadow: none;
    font-size: 13px;
    font-weight: 600;
    transition: background 200ms ease-out, border-color 200ms ease-out, transform 120ms ease-out;
  }
  .news-card-actions .btn:active { transform: scale(0.98); }
  .news-card-actions .btn.primary { background: #4f46e5; border: 1px solid #4f46e5; color: #ffffff; }
  .news-card-actions .btn.primary:hover { background: #4338ca; }
  .news-card-actions .btn.secondary { background: #ffffff; border: 1px solid #d1d5db; color: #111827; }
  .news-card-actions .btn.secondary:hover { background: #f9fafb; }
  .news-card-score,
  .news-card-score-loading {
    height: 30px;
    font-size: 12px;
    line-height: 1;
    font-weight: 600;
    border-radius: 999px;
  }
  .news-card-score { min-width: 58px; }
  .news-card-score-loading { min-width: 52px; }

  .reddit-status-wrap { position: relative; z-index: 2; }
  .reddit-status-badge {
    height: 30px;
    border-radius: 999px;
    font-size: 12px;
    line-height: 1;
    font-weight: 500;
    padding: 0 10px;
    border: 1px solid transparent;
    background: #ffffff;
    transition: color 150ms ease, border-color 150ms ease, background 150ms ease;
  }
  .reddit-status-dropdown {
    top: auto;
    bottom: calc(100% + 8px);
    left: auto;
    right: 0;
    margin-top: 0;
    border-radius: 12px;
    border-color: #e5e7eb;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    z-index: 70;
  }
  .reddit-status-dropdown button { font-size: 13px; font-weight: 500; padding: 8px 12px; }

  .news-empty-state,
  .news-error-state {
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    box-shadow: none;
    padding: 40px 24px;
    text-align: center;
  }
  .news-empty-icon {
    width: 52px;
    height: 52px;
    margin: 0 auto 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    background: #f8fafc;
    color: #64748b;
  }
  .news-empty-icon svg { width: 22px; height: 22px; }
  .news-empty-title,
  .news-error-text { font-size: 18px; line-height: 24px; font-weight: 600; color: #111827; }
  .news-empty-desc,
  .news-error-detail { max-width: 560px; margin-left: auto; margin-right: auto; font-size: 14px; line-height: 20px; color: #4b5563; }

  @media (max-width: 1024px) {
    .main-wrap { padding: 24px !important; }
    .news-toolbar-row { grid-template-columns: 1fr; }
    .news-toolbar-field,
    .reddit-subreddit-block { min-width: 0; max-width: none; width: 100%; justify-self: stretch; }
    .news-toolbar-select { min-width: 0; width: 100%; }
    .news-card { padding: 20px; }
  }
  @media (max-width: 768px) {
    .main-wrap { padding: 16px !important; }
    .news-header-top { flex-direction: column; align-items: stretch; }
    .news-header-top .btn { width: 100%; }
    .news-page-title { font-size: 24px; line-height: 30px; }
    .news-card-footer { align-items: flex-start; }
    .news-card-actions { width: 100%; }
    .news-card-actions .btn { flex: 1; }
  }
</style>
<script>
(function() {
  const tr = window.__tr || {};
  const isEnglishUiLocale = String(window.__locale || '').toLowerCase() === 'en';
  function uiText(value, enFallback, ruFallback) {
    if (typeof value === 'string' && value.trim()) return value;
    return isEnglishUiLocale ? enFallback : ruFallback;
  }
  const DISPLAY_TZ = {{ display_timezone|tojson|safe }};
  function formatDate(d) {
    if (!d) return '—';
    const s = typeof d === 'string' ? d : (d.toISOString && d.toISOString());
    const dt = new Date(s && !/Z|[+-]\d{2}:?\d{2}$/.test(s) ? s.replace(/\.\d{3}$/, '') + 'Z' : s);
    if (isNaN(dt.getTime())) return '—';
    const opts = { timeZone: DISPLAY_TZ, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
    const parts = new Intl.DateTimeFormat('en-CA', opts).formatToParts(dt);
    const y = parts.find(p => p.type === 'year').value, m = parts.find(p => p.type === 'month').value, day = parts.find(p => p.type === 'day').value;
    const h = parts.find(p => p.type === 'hour').value, min = parts.find(p => p.type === 'minute').value, s2 = parts.find(p => p.type === 'second').value;
    return y + '-' + m + '-' + day + ' ' + h + ':' + min + ':' + s2;
  }
  function relativeTime(d) {
    if (!d) return '—';
    const s = typeof d === 'string' ? d : (d.toISOString && d.toISOString());
    const dt = new Date(s && !/Z|[+-]\d{2}:?\d{2}$/.test(s) ? s.replace(/\.\d{3}$/, '') + 'Z' : s);
    if (isNaN(dt.getTime())) return '—';
    const now = new Date();
    const sec = Math.floor((now - dt) / 1000);
    if (sec < 60) return uiText(tr.reddit_time_just_now, 'just now', 'только что');
    const min = Math.floor(sec / 60);
    if (min < 60) return min === 1
      ? uiText(tr.reddit_time_1_min_ago, '1 min ago', '1 мин назад')
      : uiText(tr.reddit_time_min_ago, '{} min ago', '{} мин назад').replace('{}', min);
    const hr = Math.floor(min / 60);
    if (hr < 24) return hr === 1
      ? uiText(tr.reddit_time_1_hr_ago, '1 hour ago', '1 час назад')
      : uiText(tr.reddit_time_hr_ago, '{} hours ago', '{} часов назад').replace('{}', hr);
    const day = Math.floor(hr / 24);
    if (day === 1) return uiText(tr.reddit_time_yesterday, 'yesterday', 'вчера');
    if (day < 7) return uiText(tr.reddit_time_days_ago, '{} days ago', '{} дн. назад').replace('{}', day);
    if (day < 30) return Math.floor(day / 7) === 1
      ? uiText(tr.reddit_time_week_ago, '1 week ago', 'неделю назад')
      : uiText(tr.reddit_time_weeks_ago, '{} weeks ago', '{} нед. назад').replace('{}', Math.floor(day / 7));
    return formatDate(d);
  }
  function escapeHtml(s) {
    if (s == null || s === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(s);
    return div.innerHTML;
  }
  function getReadMoreIconSvg() {
    return '<svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 9l6 6 6-6"/></svg>';
  }
  function metricIconSvg(type) {
    if (type === 'upvotes') return '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 4l7 8h-5v8H10v-8H5z"/></svg>';
    if (type === 'comments') return '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12a8 8 0 0 1-8 8H7l-4 3V12a8 8 0 1 1 18 0z"/></svg>';
    return '';
  }
  function buildMetricHtml(type, value) {
    if (value === null || value === undefined || value === '—') return '';
    return '<span class="reddit-metric">' + metricIconSvg(type) + '<span>' + escapeHtml(String(value)) + '</span></span>';
  }
  const redditList = document.getElementById('reddit-list');
  const redditLoading = document.getElementById('reddit-loading');
  const redditEmpty = document.getElementById('reddit-empty');
  const periodSelect = document.getElementById('reddit-period');
  const sortSelect = document.getElementById('reddit-sort');
  const subredditSearch = document.getElementById('reddit-subreddit-search');
  const subredditAutocomplete = document.getElementById('reddit-subreddit-autocomplete');
  const subredditTags = document.getElementById('reddit-subreddit-tags');
  const scoreFilterSelect = document.getElementById('reddit-score-filter');
  const refreshBtn = document.getElementById('reddit-refresh-btn');
  const refreshTextEl = refreshBtn ? refreshBtn.querySelector('.refresh-text') : null;
  const refreshDefaultText = refreshTextEl ? refreshTextEl.textContent : uiText(tr.reddit_refresh, 'Refresh', 'Обновить');
  let isRefreshInFlight = false;
  const redditQueryParams = new URLSearchParams(window.location.search || '');
  const composeRedditIdRaw = redditQueryParams.get('compose_reddit_id') || redditQueryParams.get('open_reddit_id') || '';
  let composeRedditId = parseInt(composeRedditIdRaw, 10);
  let composeRedditAutoOpened = false;
  redditLoading.style.display = 'block';

  const REDDIT_STATUS_LABELS = {
    new: uiText(tr.reddit_status_new, 'New', 'Новый'),
    in_progress: uiText(tr.reddit_status_in_progress, 'In progress', 'В работе'),
    done: uiText(tr.reddit_status_done, 'Done', 'Готово'),
    hidden: uiText(tr.reddit_status_hidden, 'Hidden', 'Скрыт')
  };
  function setRefreshLoading(isLoading) {
    if (!refreshBtn) return;
    refreshBtn.classList.toggle('is-loading', !!isLoading);
    refreshBtn.setAttribute('aria-busy', isLoading ? 'true' : 'false');
    if (refreshTextEl) refreshTextEl.textContent = isLoading
      ? uiText(tr.reddit_updating, 'Updating…', 'Обновление…')
      : refreshDefaultText;
  }

  function clearComposeRedditQuery() {
    if (!history.replaceState) return;
    var cleanUrl = window.location.pathname + (window.location.hash || '');
    history.replaceState({}, document.title, cleanUrl);
  }

  function tryOpenComposeRedditFromQuery() {
    if (composeRedditAutoOpened) return;
    if (!composeRedditId || composeRedditId <= 0) return;
    composeRedditAutoOpened = true;
    openViewRedditModal(composeRedditId, { focusGenerate: true });
    clearComposeRedditQuery();
  }

  let savedSubredditNames = [];
  let selectedSubreddits = [];
  let autocompleteHighlightIndex = -1;

  function addSubreddit(name) {
    const n = (name || '').trim().toLowerCase();
    if (!n || selectedSubreddits.indexOf(n) >= 0) return;
    selectedSubreddits.push(n);
    renderSubredditTags();
    loadRedditPosts();
  }
  function removeSubreddit(name) {
    const n = (name || '').trim().toLowerCase();
    selectedSubreddits = selectedSubreddits.filter(s => s !== n);
    renderSubredditTags();
    loadRedditPosts();
  }
  function renderSubredditTags() {
    if (!subredditTags) return;
    subredditTags.innerHTML = selectedSubreddits.map(function(n) {
      return '<span class="reddit-subreddit-tag">r/' + escapeHtml(n) + '<button type="button" aria-label="' + uiText(tr.reddit_remove_tag, 'Remove r/{}', 'Убрать r/{}').replace('{}', n) + '" data-name="' + escapeHtml(n) + '">×</button></span>';
    }).join('');
    subredditTags.querySelectorAll('.reddit-subreddit-tag button').forEach(function(btn) {
      btn.addEventListener('click', function() {
        removeSubreddit(btn.dataset.name);
      });
    });
  }

  function loadSavedSubreddits() {
    fetch('/reddit/subreddits').then(r => r.json()).then(names => {
      savedSubredditNames = Array.isArray(names) ? names : [];
      var emptyDesc = document.getElementById('reddit-empty-desc');
      if (emptyDesc && savedSubredditNames.length === 0) {
        emptyDesc.innerHTML = uiText(tr.reddit_empty_add_first, 'Add subreddits in <a href="/ui/setup">Settings</a> first, then click Refresh.', 'Сначала добавьте сабреддиты в <a href="/ui/setup">Settings</a>, затем нажмите «Обновить».');
      }
    }).catch(function() { savedSubredditNames = []; });
  }

  function toggleSubreddit(name) {
    const n = (name || '').trim().toLowerCase();
    if (!n) return;
    if (selectedSubreddits.indexOf(n) >= 0) {
      removeSubreddit(n);
    } else {
      addSubreddit(n);
    }
  }
  function showAutocomplete(query) {
    if (!subredditAutocomplete) return;
    const q = (query || '').trim().toLowerCase();
    const matches = q ? savedSubredditNames.filter(function(n) { return n.toLowerCase().indexOf(q) >= 0; }) : savedSubredditNames.slice();
    if (!matches.length) {
      subredditAutocomplete.innerHTML = '<div role="option" class="reddit-ac-no-results" aria-selected="false">' + uiText(tr.reddit_no_matches, 'No matches', 'Нет совпадений') + '</div>';
    } else {
      subredditAutocomplete.innerHTML = matches.slice(0, 15).map(function(name) {
        var checked = selectedSubreddits.indexOf(name.toLowerCase()) >= 0;
        return '<div role="option" data-name="' + escapeHtml(name) + '" tabindex="-1" aria-checked="' + (checked ? 'true' : 'false') + '">' +
          '<input type="checkbox" class="reddit-ac-checkbox" ' + (checked ? 'checked' : '') + ' aria-hidden="true" tabindex="-1">' +
          '<span class="reddit-ac-label">r/' + escapeHtml(name) + '</span></div>';
      }).join('');
      subredditAutocomplete.querySelectorAll('[role="option"]:not(.reddit-ac-no-results)').forEach(function(opt, i) {
        opt.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          toggleSubreddit(opt.dataset.name);
          showAutocomplete(subredditSearch.value);
        });
      });
    }
    subredditAutocomplete.classList.add('is-open');
    subredditAutocomplete.setAttribute('aria-hidden', 'false');
    autocompleteHighlightIndex = matches.length ? 0 : -1;
    updateAutocompleteHighlight();
  }
  function closeAutocomplete() {
    if (subredditAutocomplete) {
      subredditAutocomplete.classList.remove('is-open');
      subredditAutocomplete.setAttribute('aria-hidden', 'true');
      autocompleteHighlightIndex = -1;
    }
  }
  function updateAutocompleteHighlight() {
    if (!subredditAutocomplete) return;
    const opts = subredditAutocomplete.querySelectorAll('[role="option"]:not(.reddit-ac-no-results)');
    opts.forEach(function(o, i) { o.setAttribute('aria-selected', i === autocompleteHighlightIndex ? 'true' : 'false'); });
    if (autocompleteHighlightIndex >= 0 && opts[autocompleteHighlightIndex]) opts[autocompleteHighlightIndex].scrollIntoView({ block: 'nearest' });
  }

  if (subredditSearch && subredditAutocomplete) {
    subredditSearch.addEventListener('input', function() {
      showAutocomplete(subredditSearch.value);
    });
    subredditSearch.addEventListener('focus', function() {
      if (subredditSearch.value.trim() || savedSubredditNames.length) showAutocomplete(subredditSearch.value);
    });
    subredditSearch.addEventListener('keydown', function(e) {
      const opts = subredditAutocomplete.querySelectorAll('[role="option"]:not(.reddit-ac-no-results)');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        autocompleteHighlightIndex = opts.length ? (autocompleteHighlightIndex + 1) % opts.length : -1;
        updateAutocompleteHighlight();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        autocompleteHighlightIndex = opts.length ? (autocompleteHighlightIndex <= 0 ? opts.length - 1 : autocompleteHighlightIndex - 1) : -1;
        updateAutocompleteHighlight();
      } else if (e.key === 'Enter' && autocompleteHighlightIndex >= 0 && opts[autocompleteHighlightIndex]) {
        e.preventDefault();
        toggleSubreddit(opts[autocompleteHighlightIndex].dataset.name);
        showAutocomplete(subredditSearch.value);
      } else if (e.key === 'Escape') {
        closeAutocomplete();
        subredditSearch.blur();
      }
    });
    document.addEventListener('click', function(e) {
      if (!subredditAutocomplete || !subredditAutocomplete.classList.contains('is-open')) return;
      var wrap = subredditSearch && subredditSearch.closest('.reddit-subreddit-search-wrap');
      if (wrap && wrap.contains(e.target)) return;
      closeAutocomplete();
    });
  }

  function loadRedditPosts() {
    redditLoading.style.display = 'block';
    redditEmpty.style.display = 'none';
    document.getElementById('reddit-error').style.display = 'none';
    const params = new URLSearchParams();
    params.set('sort', sortSelect.value || 'desc');
    if (periodSelect.value) params.set('period', periodSelect.value);
    selectedSubreddits.forEach(function(s) { params.append('subreddit', s); });
    fetch('/reddit/posts?' + params).then(r => {
      if (!r.ok) {
        throw new Error(
          r.status === 401
            ? uiText(window.__tr && window.__tr.required_login, 'Login required', 'Требуется вход')
            : uiText(window.__tr && window.__tr.load_error, 'Load error (HTTP ' + r.status + ')', 'Ошибка загрузки (HTTP ' + r.status + ')')
        );
      }
      return r.json();
    }).then(list => {
      if (!Array.isArray(list)) throw new Error(uiText(window.__tr && window.__tr.server_error, 'Invalid response', 'Некорректный ответ сервера'));
      redditLoading.style.display = 'none';
      const scoreRange = (scoreFilterSelect && scoreFilterSelect.value) ? scoreFilterSelect.value : '';
      let filteredList = !scoreRange ? list : list.filter(function(p) {
        const s = p.relevance_score;
        if (s === undefined || s === null) return false;
        if (scoreRange === 'red') return s >= 0 && s <= 30;
        if (scoreRange === 'yellow') return s >= 31 && s <= 60;
        if (scoreRange === 'green') return s >= 61 && s <= 80;
        if (scoreRange === 'blue') return s >= 81;
        return true;
      });
      if (!filteredList || !filteredList.length) {
        redditList.innerHTML = '';
        redditEmpty.style.display = 'block';
        const titleEl = redditEmpty.querySelector('.news-empty-title');
        const descEl = document.getElementById('reddit-empty-desc');
        if (titleEl) titleEl.textContent = uiText(tr.reddit_empty_title, 'No Reddit posts', 'Нет постов Reddit');
        if (descEl) {
          descEl.innerHTML = savedSubredditNames.length === 0
            ? uiText(tr.reddit_empty_add_first, 'Add subreddits in <a href="/ui/setup">Settings</a> first, then click Refresh.', 'Сначала добавьте сабреддиты в <a href="/ui/setup">Settings</a>, затем нажмите «Обновить».')
            : uiText(tr.reddit_empty_desc, 'No posts for selected filters.', 'Нет постов по текущим фильтрам.');
        }
        return;
      }
      redditEmpty.style.display = 'none';
      redditList.innerHTML = filteredList.map((p, idx) => {
        const author = (p.author || '').trim() || uiText(null, 'unknown', 'неизвестный');
        const subName = (p.subreddit || '').trim() || '';
        const metaParts = ['u/' + escapeHtml(author)];
        if (subName) metaParts.push('r/' + escapeHtml(subName));
        metaParts.push(relativeTime(p.posted_at));
        const metaStr = metaParts.join(' · ');
        var statusVal = (p.status && REDDIT_STATUS_LABELS[p.status]) ? p.status : 'new';
        if (statusVal === 'new' && p.reply_variants && typeof p.reply_variants.post === 'string' && p.reply_variants.post.trim()) statusVal = 'in_progress';
        const statusLabel = REDDIT_STATUS_LABELS[statusVal] || uiText(tr.reddit_status_new, 'New', 'Новый');
        const relevanceScore = p.relevance_score !== undefined && p.relevance_score !== null ? p.relevance_score : null;
        const scoreColorClass = relevanceScore !== null ? getScoreColorClass(relevanceScore) : '';
        const scoreLabel = uiText(tr.reddit_score, 'Score', 'Score');
        const scoreHtml = relevanceScore !== null
          ? '<span class="news-card-score ' + scoreColorClass + '" data-score="' + relevanceScore + '" title="' + uiText(tr.reddit_relevance, 'Relevance: {}', 'Релевантность: {}').replace('{}', relevanceScore) + '/100">' + scoreLabel + ': ' + relevanceScore + '</span>'
          : '<span class="news-card-score-loading" data-post-id="' + p.id + '" data-index="' + idx + '">—</span>';
        const titleText = (p.title || (p.content || '').trim() || uiText(tr.post_no_title, 'No title', 'Без заголовка')).trim();
        const title = escapeHtml(titleText);
        const content = (p.content || '').trim();
        const sentences = content ? content.split(/(?<=[.!?])\s+/).filter(Boolean) : [];
        const desc = sentences.length ? escapeHtml(sentences.slice(0, 4).join(' ') + (sentences.length > 4 ? '…' : '')) : '';
        const upvotes = p.score != null ? p.score : '—';
        const comments = p.num_comments != null ? p.num_comments : '—';
        const upvotesHtml = buildMetricHtml('upvotes', upvotes);
        const commentsHtml = buildMetricHtml('comments', comments);
        const openOnReddit = uiText(tr.reddit_open_on_reddit, 'Open on Reddit', 'Открыть на Reddit');
        const openRedditLink = p.post_url ? '<a href="' + escapeHtml(p.post_url) + '" target="_blank" rel="noopener" class="news-card-open-reddit" title="' + openOnReddit + '" aria-label="' + openOnReddit + '" onclick="event.stopPropagation()">' + openOnReddit + ' <span aria-hidden="true">↗</span></a>' : '';
        const statusOpts = ['new','in_progress','done','hidden'].map(s => '<button type="button" class="reddit-status-opt" data-status="' + s + '">' + (REDDIT_STATUS_LABELS[s] || s) + '</button>').join('');
        const statusBadge = '<div class="reddit-status-wrap"><button type="button" class="reddit-status-badge status-' + statusVal + '" data-id="' + p.id + '" data-status="' + statusVal + '" aria-haspopup="true" aria-expanded="false" onclick="event.stopPropagation()">' + statusLabel + '</button><div class="reddit-status-dropdown" role="menu">' + statusOpts + '</div></div>';
        return '<article class="news-card" data-id="' + p.id + '" role="button" tabindex="0">' +
          '<div class="news-card-top">' +
            '<span class="news-card-meta">' + metaStr + '</span>' +
            '<div class="news-card-top-right-wrap">' + openRedditLink + '</div>' +
          '</div>' +
          '<div class="news-card-body">' +
            '<h2 class="news-card-title">' + title + '</h2>' +
            (desc ? '<div class="news-card-summary-wrap"><p class="news-card-summary">' + desc + '</p></div>' : '') +
          '</div>' +
          '<div class="news-card-footer">' +
            '<div class="news-card-footer-left">' +
              '<div class="reddit-metrics">' + upvotesHtml + commentsHtml + '</div>' +
              '<button type="button" class="news-card-read-more btn-reddit-read-full" data-id="' + p.id + '" onclick="event.stopPropagation()">' + uiText(tr.posts_read_more, 'Read more', 'Читать далее') + ' ' + getReadMoreIconSvg() + '</button>' +
            '</div>' +
            '<div class="news-card-actions">' +
              statusBadge +
              scoreHtml +
              '<button type="button" class="btn primary btn-sm btn-generate-post" data-id="' + p.id + '" onclick="event.stopPropagation()">' + uiText(tr.news_make_post, 'Make post', 'Сделать пост') + '</button>' +
            '</div>' +
          '</div>' +
        '</article>';
      }).join('');
      redditLoading.style.display = 'none';
      // Запускаем скорринг для Reddit постов без score
      scoreRedditPosts(filteredList);
      redditList.querySelectorAll('.news-card').forEach(card => {
        const id = parseInt(card.dataset.id, 10);
        card.addEventListener('click', (e) => {
          if (e.target.closest('.btn-generate-post') || e.target.closest('a') || e.target.closest('.news-card-read-more') || e.target.closest('.news-card-footer') || e.target.closest('.reddit-status-wrap')) return;
          openViewRedditModal(id);
        });
        card.addEventListener('keydown', (e) => {
          if (e.key !== 'Enter' && e.key !== ' ') return;
          if (e.target.closest('.btn-generate-post') || e.target.closest('a') || e.target.closest('.news-card-read-more') || e.target.closest('.news-card-footer') || e.target.closest('.reddit-status-wrap')) return;
          e.preventDefault();
          openViewRedditModal(id);
        });
      });
      redditList.querySelectorAll('.reddit-status-badge').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const wrap = btn.closest('.reddit-status-wrap');
          const dd = wrap && wrap.querySelector('.reddit-status-dropdown');
          const isOpen = dd && dd.classList.contains('is-open');
          document.querySelectorAll('.reddit-status-dropdown.is-open').forEach(d => d.classList.remove('is-open'));
          if (dd && !isOpen) { dd.classList.add('is-open'); btn.setAttribute('aria-expanded', 'true'); }
          else if (btn) btn.setAttribute('aria-expanded', 'false');
        });
      });
      redditList.querySelectorAll('.reddit-status-opt').forEach(opt => {
        opt.addEventListener('click', (e) => {
          e.stopPropagation();
          const wrap = opt.closest('.reddit-status-wrap');
          const postId = wrap && wrap.querySelector('.reddit-status-badge') && wrap.querySelector('.reddit-status-badge').dataset.id;
          const newStatus = opt.dataset.status;
          if (!postId || !newStatus) return;
          wrap.querySelector('.reddit-status-dropdown').classList.remove('is-open');
          fetch('/reddit/posts/' + postId, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) })
            .then(r => r.json())
            .then(() => {
              const badge = wrap.querySelector('.reddit-status-badge');
              badge.dataset.status = newStatus;
              badge.className = 'reddit-status-badge status-' + newStatus;
              badge.textContent = REDDIT_STATUS_LABELS[newStatus] || newStatus;
            })
            .catch(() => {});
        });
      });
      redditList.querySelectorAll('.btn-reddit-read-full').forEach(btn => {
        btn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openViewRedditModal(parseInt(btn.dataset.id, 10)); });
      });
      redditList.querySelectorAll('.btn-generate-post').forEach(btn => {
        btn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openViewRedditModal(parseInt(btn.dataset.id, 10), { focusGenerate: true }); });
      });
      tryOpenComposeRedditFromQuery();
    }).catch((err) => {
      redditLoading.style.display = 'none';
      redditEmpty.style.display = 'none';
      const errEl = document.getElementById('reddit-error');
      errEl.style.display = 'block';
      const detailEl = document.getElementById('reddit-error-detail');
      if (detailEl) detailEl.textContent = err && err.message ? err.message : uiText(tr.load_error, 'Load error', 'Ошибка загрузки');
    });
  }

  document.addEventListener('click', () => {
    document.querySelectorAll('.reddit-status-dropdown.is-open').forEach(d => d.classList.remove('is-open'));
  });

  const viewModal = document.getElementById('view-reddit-modal');
  const viewPanel = document.getElementById('view-reddit-drawer-panel');
  let currentViewId = null;
  let currentViewContent = '';
  let currentViewUrl = '';
  let viewAuthorsList = [];
  let viewSetupDraft = {};

  function getDrawerFocusables() {
    if (!viewPanel) return [];
    return [].slice.call(viewPanel.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select, textarea, [tabindex]:not([tabindex="-1"])')).filter(el => !el.hidden && el.offsetParent !== null);
  }
  function closeViewRedditDrawer() {
    viewModal.classList.remove('is-open');
    viewModal.setAttribute('aria-hidden', 'true');
    hideRedditGenerationProgress();
  }
  document.getElementById('view-reddit-drawer-close').addEventListener('click', closeViewRedditDrawer);
  document.getElementById('view-reddit-backdrop').addEventListener('click', closeViewRedditDrawer);
  viewModal.addEventListener('click', (e) => { if (e.target === viewModal) closeViewRedditDrawer(); });
  viewModal.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeViewRedditDrawer(); e.preventDefault(); } });

  function openViewRedditModal(id, opts) {
    opts = opts || {};
    viewModal.classList.add('is-open');
    viewModal.removeAttribute('aria-hidden');
    hideRedditGenerationProgress();
    currentViewId = id;
    fetch('/reddit/posts/' + id).then(r => r.json()).then(p => {
      if (p.status === 'new') {
        fetch('/reddit/posts/' + id, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'in_progress' }) })
          .then(r => r.json())
          .then(() => {
            const card = document.querySelector('.news-card[data-id="' + id + '"]');
            const badge = card && card.querySelector('.reddit-status-badge');
            if (badge) {
              badge.dataset.status = 'in_progress';
              badge.className = 'reddit-status-badge status-in_progress';
              badge.textContent = uiText(tr.reddit_status_in_progress, 'In progress', 'В работе');
            }
          })
          .catch(() => {});
      }
      currentViewContent = p.content || '';
      currentViewUrl = p.post_url || '#';
      document.getElementById('view-reddit-modal-title').textContent = p.title || uiText(tr.reddit_post_default, 'Post', 'Пост');
      const metaParts = [formatDate(p.posted_at)];
      if (p.author || p.subreddit) metaParts.push((p.author ? 'u/' + p.author : '') + (p.subreddit ? ' r/' + p.subreddit : ''));
      if (p.score != null) metaParts.push('↑ ' + p.score);
      if (p.num_comments != null) metaParts.push('💬 ' + p.num_comments);
      const metaRow = document.getElementById('view-reddit-meta-row');
      const metaText = metaParts.join(' · ');
      
      // Обновляем score в детальном виде
      const scoreWrap = document.getElementById('view-reddit-score-wrap');
      const scoreEl = document.getElementById('view-reddit-score');
      const scoreRefreshBtn = document.getElementById('view-reddit-score-refresh');
      if (scoreWrap && scoreEl) {
        scoreWrap.style.display = 'inline-flex';
        scoreWrap.style.alignItems = 'center';
        scoreWrap.style.gap = 'var(--space-2)';
        const relevanceScore = p.relevance_score !== undefined && p.relevance_score !== null ? p.relevance_score : null;
        if (relevanceScore !== null) {
          var colorClass = getScoreColorClass(relevanceScore);
          scoreEl.className = 'news-card-score ' + colorClass;
          scoreEl.setAttribute('data-score', relevanceScore);
          scoreEl.textContent = uiText(tr.reddit_score, 'Score', 'Score') + ': ' + relevanceScore;
          scoreEl.title = uiText(tr.reddit_relevance, 'Relevance: {}', 'Релевантность: {}').replace('{}', relevanceScore) + '/100';
          if (scoreRefreshBtn) {
            scoreRefreshBtn.style.display = 'inline-flex';
            scoreRefreshBtn.onclick = function(e) {
              e.stopPropagation();
              refreshRedditScore(id);
            };
          }
        } else {
          scoreEl.className = 'news-card-score-loading';
          scoreEl.textContent = '—';
          scoreEl.title = uiText(tr.news_relevance_loading, 'Relevance score...', 'Оценка релевантности...');
          if (scoreRefreshBtn) {
            scoreRefreshBtn.style.display = 'inline-flex';
            scoreRefreshBtn.onclick = function(e) {
              e.stopPropagation();
              refreshRedditScore(id);
            };
          }
        }
        // Добавляем score в мета-информацию
        metaRow.innerHTML = metaText + ' ';
        metaRow.appendChild(scoreWrap);
      } else {
        metaRow.textContent = metaText;
      }
      const sourceRow = document.getElementById('view-reddit-source-row');
      if (sourceRow && currentViewUrl && currentViewUrl !== '#') {
        sourceRow.style.display = 'block';
        sourceRow.innerHTML = uiText(tr.reddit_source, 'Source:', 'Источник:') + ' <a href="' + escapeHtml(currentViewUrl) + '" target="_blank" rel="noopener">Reddit</a>';
      } else if (sourceRow) sourceRow.style.display = 'none';
      const contentEl = document.getElementById('view-reddit-content');
      contentEl.textContent = currentViewContent || uiText(tr.reddit_no_text, '(no text)', '(нет текста)');
      contentEl.style.whiteSpace = 'pre-wrap';
      const linkHeader = document.getElementById('view-reddit-link-header');
      linkHeader.href = currentViewUrl;
      linkHeader.style.display = currentViewUrl !== '#' ? 'inline' : 'none';
      const textarea = document.getElementById('view-reddit-write-textarea');
      if (textarea) textarea.value = (p.reply_variants && p.reply_variants.post) ? (p.reply_variants.post || '') : '';
      updateRedditCharCount();
      if (opts.focusGenerate) document.getElementById('view-reddit-rewrite-btn').focus();
    }).catch(() => { currentViewId = null; closeViewRedditDrawer(); });
  }

  document.getElementById('view-reddit-copy-btn').addEventListener('click', function() {
    const ta = document.getElementById('view-reddit-write-textarea');
    const text = ta ? ta.value : '';
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => { if (typeof window.toast === 'function') window.toast(uiText(tr.reddit_copied, 'Copied', 'Скопировано'), 'success'); });
  });

  function updateRedditCharCount() {
    const ta = document.getElementById('view-reddit-write-textarea');
    const countEl = document.getElementById('view-reddit-char-count');
    const lengthSelect = document.getElementById('view-reddit-length');
    if (!ta || !countEl || !lengthSelect) return;
    const text = ta.value || '';
    const charCount = text.replace(/\s+/g, '').length;
    const length = lengthSelect.value || 'medium';
    const ranges = {
      short: { min: 600, max: 900 },
      medium: { min: 900, max: 1400 },
      long: { min: 1400, max: 2200 }
    };
    const range = ranges[length] || ranges.medium;
    const isValid = charCount >= range.min && charCount <= range.max;
    const status = isValid ? 'valid' : (charCount < range.min ? 'too-short' : 'too-long');
    countEl.textContent = charCount + ' / ' + range.min + '–' + range.max + ' ' + uiText(tr.reddit_chars, 'chars (no spaces)', 'знаков без пробелов');
    countEl.className = 'view-post-char-count view-post-char-count-' + status;
    updateRedditRewriteButtonsState();
  }
  function updateRedditRewriteButtonsState() {
    const ta = document.getElementById('view-reddit-write-textarea');
    const copyBtn = document.getElementById('view-reddit-copy-btn');
    const rewriteBtn = document.getElementById('view-reddit-rewrite-btn');
    if (!ta || !copyBtn || !rewriteBtn) return;
    const text = (ta.value || '').trim();
    const hasContent = text.length > 0 && text !== uiText(tr.reddit_generating, 'Generating…', 'Генерация…');
    if (hasContent) {
      copyBtn.classList.remove('secondary'); copyBtn.classList.add('primary');
      rewriteBtn.classList.remove('primary'); rewriteBtn.classList.add('secondary');
    } else {
      copyBtn.classList.remove('primary'); copyBtn.classList.add('secondary');
      rewriteBtn.classList.remove('secondary'); rewriteBtn.classList.add('primary');
    }
  }

  const redditGenerateProgress = document.getElementById('view-reddit-generate-progress');
  const redditGenerateProgressTrack = document.getElementById('view-reddit-generate-progress-track');
  const redditGenerateProgressFill = document.getElementById('view-reddit-generate-progress-fill');
  const redditGenerateProgressTime = document.getElementById('view-reddit-generate-progress-time');
  const redditGenerateProgressSteps = document.getElementById('view-reddit-generate-progress-steps');
  const redditGenerateProgressNote = document.getElementById('view-reddit-generate-progress-note');
  const redditProgressStages = [
    (tr.posts_gen_stage_prepare || uiText(null, 'Preparing post context', 'Собираем контекст поста')),
    (tr.posts_gen_stage_voice || uiText(null, 'Applying author voice', 'Применяем стиль автора')),
    (uiText(null, 'Generating post draft', 'Генерируем пост')),
    (uiText(null, 'Checking and adjusting length', 'Проверяем и корректируем длину')),
    (tr.posts_gen_stage_finalize || uiText(null, 'Reviewing and formatting', 'Проверяем и форматируем'))
  ];
  const redditProgressDetails = [
    (tr.posts_gen_detail_prepare_context || uiText(null, 'Analyzing topic, tone, and key message.', 'Анализируем тему, тональность и ключевой посыл.')),
    (tr.posts_gen_detail_prepare_author || uiText(null, 'Applying the selected author\'s style and vocabulary.', 'Применяем стиль и словарь выбранного автора.')),
    (uiText(null, 'Drafting one post for the selected goal.', 'Готовим единый пост под выбранную цель.')),
    (uiText(null, 'Verifying selected length and adjusting if needed.', 'Проверяем выбранную длину и корректируем при необходимости.')),
    (tr.posts_gen_detail_review || uiText(null, 'Checking readability, logic, and tone consistency.', 'Проверяем читабельность, логику и соответствие тону.'))
  ];
  const redditProgressStageOffsetsMs = [0, 1400, 4200, 8600, 13800];
  let redditProgressTimer = null;
  let redditProgressHideTimer = null;
  let redditProgressStartedAt = 0;
  let redditProgressActiveStage = 0;

  function formatRedditProgressElapsed(ms) {
    const total = Math.max(0, Math.floor(ms / 1000));
    const min = Math.floor(total / 60);
    const sec = String(total % 60).padStart(2, '0');
    return min + ':' + sec;
  }
  function computeRedditProgressStage(ms) {
    let idx = 0;
    for (let i = 0; i < redditProgressStageOffsetsMs.length; i++) {
      if (ms >= redditProgressStageOffsetsMs[i]) idx = i;
    }
    return idx;
  }
  function computeRedditProgressPercent(ms) {
    const rampMs = 38000;
    const maxPercentBeforeDone = 94;
    return Math.max(6, Math.min(maxPercentBeforeDone, Math.round((ms / rampMs) * maxPercentBeforeDone)));
  }
  function getRedditProgressDetail(ms, mode) {
    if (mode === 'done') return uiText(null, 'Done. Post is ready to publish.', 'Готово. Пост готов к публикации.');
    if (mode === 'error') return (tr.posts_generation_failed || uiText(null, 'Failed to complete generation.', 'Не удалось завершить генерацию.'));
    if (ms >= 45000) return (tr.posts_gen_hint_slow || uiText(null, 'Running extra validation. It can take up to 1-2 minutes.', 'Идёт дополнительная проверка. Иногда это занимает до 1-2 минут.'));
    return redditProgressDetails[redditProgressActiveStage] || '';
  }
  function renderRedditProgressSteps(mode) {
    if (!redditGenerateProgressSteps) return;
    redditGenerateProgressSteps.innerHTML = redditProgressStages.map(function(label, idx) {
      var cls = '';
      if (mode === 'done') cls = ' is-done';
      else if (mode === 'error') {
        if (idx < redditProgressActiveStage) cls = ' is-done';
        else if (idx === redditProgressActiveStage) cls = ' is-error';
      } else {
        if (idx < redditProgressActiveStage) cls = ' is-done';
        else if (idx === redditProgressActiveStage) cls = ' is-active';
      }
      return '<li class="generate-progress-step' + cls + '"><span class="generate-progress-step-dot" aria-hidden="true"></span><span>' + escapeHtml(label) + '</span></li>';
    }).join('');
  }
  function updateRedditProgressTick() {
    if (!redditGenerateProgress) return;
    const elapsed = Date.now() - redditProgressStartedAt;
    redditProgressActiveStage = computeRedditProgressStage(elapsed);
    if (redditGenerateProgressTime) redditGenerateProgressTime.textContent = formatRedditProgressElapsed(elapsed);
    const percent = computeRedditProgressPercent(elapsed);
    if (redditGenerateProgressFill) redditGenerateProgressFill.style.width = percent + '%';
    if (redditGenerateProgressTrack) redditGenerateProgressTrack.setAttribute('aria-valuenow', String(percent));
    renderRedditProgressSteps('running');
    if (redditGenerateProgressNote) redditGenerateProgressNote.textContent = getRedditProgressDetail(elapsed, 'running');
  }
  function clearRedditProgressTimers() {
    if (redditProgressTimer) { clearInterval(redditProgressTimer); redditProgressTimer = null; }
    if (redditProgressHideTimer) { clearTimeout(redditProgressHideTimer); redditProgressHideTimer = null; }
  }
  function hideRedditGenerationProgress() {
    clearRedditProgressTimers();
    if (!redditGenerateProgress) return;
    redditGenerateProgress.style.display = 'none';
    redditGenerateProgress.classList.remove('is-done', 'is-error');
    if (redditGenerateProgressFill) redditGenerateProgressFill.style.width = '0%';
    if (redditGenerateProgressTrack) redditGenerateProgressTrack.setAttribute('aria-valuenow', '0');
    if (redditGenerateProgressTime) redditGenerateProgressTime.textContent = '0:00';
    if (redditGenerateProgressSteps) redditGenerateProgressSteps.innerHTML = '';
    if (redditGenerateProgressNote) redditGenerateProgressNote.textContent = '';
  }
  function startRedditGenerationProgress() {
    if (!redditGenerateProgress) return;
    clearRedditProgressTimers();
    redditGenerateProgress.classList.remove('is-done', 'is-error');
    redditGenerateProgress.style.display = 'block';
    redditProgressStartedAt = Date.now();
    redditProgressActiveStage = 0;
    updateRedditProgressTick();
    redditProgressTimer = setInterval(updateRedditProgressTick, 350);
  }
  function finalizeRedditGenerationProgress(mode) {
    if (!redditGenerateProgress) return;
    clearRedditProgressTimers();
    const elapsed = Date.now() - redditProgressStartedAt;
    if (redditGenerateProgressTime) redditGenerateProgressTime.textContent = formatRedditProgressElapsed(elapsed);
    if (mode === 'done') {
      redditProgressActiveStage = redditProgressStages.length - 1;
      redditGenerateProgress.classList.add('is-done');
      if (redditGenerateProgressFill) redditGenerateProgressFill.style.width = '100%';
      if (redditGenerateProgressTrack) redditGenerateProgressTrack.setAttribute('aria-valuenow', '100');
      renderRedditProgressSteps('done');
      if (redditGenerateProgressNote) redditGenerateProgressNote.textContent = getRedditProgressDetail(elapsed, 'done');
      redditProgressHideTimer = setTimeout(hideRedditGenerationProgress, 1800);
      return;
    }
    redditGenerateProgress.classList.add('is-error');
    renderRedditProgressSteps('error');
    if (redditGenerateProgressNote) redditGenerateProgressNote.textContent = getRedditProgressDetail(elapsed, 'error');
    redditProgressHideTimer = setTimeout(hideRedditGenerationProgress, 3200);
  }

  document.getElementById('view-reddit-rewrite-btn').addEventListener('click', async () => {
    const postText = (currentViewContent || '').trim() || (document.getElementById('view-reddit-content').textContent || '').trim();
    if (!postText || postText === uiText(tr.reddit_no_text, '(no text)', '(нет текста)')) {
      if (typeof window.toast === 'function') window.toast(uiText(tr.reddit_wait_load, 'Wait for post to load or refresh the page', 'Дождитесь загрузки поста или обновите страницу'), 'error');
      return;
    }
    const goal = document.getElementById('view-reddit-goal').value;
    const length = document.getElementById('view-reddit-length').value;
    const authorIndex = document.getElementById('view-reddit-author-select').value;
    const author = (authorIndex !== '' && viewAuthorsList.length) ? viewAuthorsList[parseInt(authorIndex, 10)] : null;
    const payload = { news_text: postText, goal, length };
    if (author) payload.author = { full_name: author.full_name, role: author.role || '', history: author.history || '', linkedin_url: author.linkedin_url || '' };
    if (viewSetupDraft.products && viewSetupDraft.products.length) payload.products = viewSetupDraft.products;
    const btn = document.getElementById('view-reddit-rewrite-btn');
    const ta = document.getElementById('view-reddit-write-textarea');
    btn.disabled = true;
    btn.textContent = uiText(tr.reddit_generating, 'Generating…', 'Генерация…');
    if (ta) ta.value = uiText(tr.reddit_generating, 'Generating…', 'Генерация…');
    startRedditGenerationProgress();
    updateRedditCharCount();
    try {
      const res = await fetch('/agents/news_post_agent/run', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ payload }) });
      const text = await res.text();
      if (!res.ok) {
        var errMsg = res.statusText;
        if (text) {
          try { var errJson = JSON.parse(text); errMsg = errJson.detail || errJson.message || text.slice(0, 300); } catch (_) { errMsg = text.slice(0, 300); }
        }
        if (ta) ta.value = uiText(tr.server_error, 'Server error', 'Ошибка сервера') + ' (' + res.status + '): ' + errMsg;
        updateRedditCharCount();
        finalizeRedditGenerationProgress('error');
        return;
      }
      var data;
      try { data = JSON.parse(text); } catch (parseErr) {
        if (ta) ta.value = uiText(tr.load_error, 'Error', 'Ошибка') + ': response is not JSON. ' + (text ? text.slice(0, 200) : '');
        updateRedditCharCount();
        finalizeRedditGenerationProgress('error');
        return;
      }
      const postResult = data.result && data.result.post ? data.result.post : '';
      const postResultText = (postResult || '').trim();
      if (ta) ta.value = postResultText || uiText(tr.reddit_generate_failed, 'Failed to generate post.', 'Не удалось сгенерировать пост.');
      updateRedditCharCount();
      if (currentViewId != null && postResult) {
        fetch('/reddit/posts/' + currentViewId, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reply_variants: { post: postResult.trim() }, status: 'in_progress' }) })
          .then(r => r.json())
          .then(() => {
            const card = document.querySelector('.news-card[data-id="' + currentViewId + '"]');
            const badge = card && card.querySelector('.reddit-status-badge');
            if (badge) {
              badge.dataset.status = 'in_progress';
              badge.className = 'reddit-status-badge status-in_progress';
              badge.textContent = uiText(tr.reddit_status_in_progress, 'In progress', 'В работе');
            }
          })
          .catch(() => {});
      }
      finalizeRedditGenerationProgress(postResultText ? 'done' : 'error');
    } catch (err) {
      if (ta) ta.value = uiText(tr.load_error, 'Error', 'Ошибка') + ': ' + (err && err.message ? err.message : uiText(null, 'Failed to connect to server.', 'Не удалось подключиться к серверу.'));
      updateRedditCharCount();
      finalizeRedditGenerationProgress('error');
    } finally {
      btn.disabled = false;
      btn.textContent = uiText(tr.reddit_rewrite_btn, 'Rewrite', 'Переписать');
    }
  });

  const redditTextarea = document.getElementById('view-reddit-write-textarea');
  const redditLengthSelect = document.getElementById('view-reddit-length');
  if (redditTextarea) {
    redditTextarea.addEventListener('input', updateRedditCharCount);
    redditTextarea.addEventListener('paste', () => { setTimeout(updateRedditCharCount, 10); });
  }
  if (redditLengthSelect) {
    redditLengthSelect.addEventListener('change', updateRedditCharCount);
  }

  function fillAuthorSelect(authors) {
    const sel = document.getElementById('view-reddit-author-select');
    sel.innerHTML = '';
    viewAuthorsList = Array.isArray(authors) ? authors : [];
    if (!viewAuthorsList.length) {
      sel.appendChild(new Option(uiText(tr.reddit_add_authors_first, '— Add authors in Settings —', '— Добавьте авторов в Settings —'), ''));
      return;
    }
    viewAuthorsList.forEach((a, i) => {
      sel.appendChild(new Option(a.full_name || uiText(tr.reddit_author_n, 'Author {}', 'Автор {}').replace('{}', i + 1), String(i)));
    });
  }
  fetch('/setup/draft').then(r => r.json()).then(d => {
    viewSetupDraft = d || {};
    fillAuthorSelect(d.authors || []);
  }).catch(() => { viewSetupDraft = {}; fillAuthorSelect([]); });

  if (refreshBtn) {
    refreshBtn.addEventListener('click', function() {
      if (isRefreshInFlight) return;
      isRefreshInFlight = true;
      setRefreshLoading(true);
    var refreshAbort = new AbortController();
    var refreshTimeout = setTimeout(function() { refreshAbort.abort(); }, 90000);
    fetch('/reddit/refresh', { method: 'POST', headers: { 'Content-Type': 'application/json' }, signal: refreshAbort.signal })
      .then(function(r) { return r.json().catch(function() { return {}; }); })
      .then(function(data) {
        clearTimeout(refreshTimeout);
        loadRedditPosts();
        if (typeof window.toast === 'function') {
          var subCount = (data && data.subreddits != null) ? data.subreddits : -1;
          var added = (data && data.added != null) ? data.added : -1;
          if (subCount === 0) window.toast(uiText(tr.reddit_add_subreddits_first, 'Add subreddits in Settings first', 'Сначала добавьте сабреддиты в Settings'));
          else if (added !== -1) window.toast(added > 0
            ? uiText(tr.reddit_posts_added, 'Added posts: {}', 'Добавлено постов: {}').replace('{}', added)
            : uiText(tr.reddit_posts_updated, 'Posts updated', 'Посты обновлены'));
          else window.toast(uiText(tr.reddit_posts_updated, 'Posts updated', 'Посты обновлены'));
        }
      })
      .catch(function() {
        clearTimeout(refreshTimeout);
        loadRedditPosts();
        if (typeof window.toast === 'function') window.toast(uiText(tr.reddit_update_failed, 'Failed to update posts. Check connection or try later.', 'Не удалось обновить посты. Проверьте интернет или попробуйте позже.'));
      })
      .finally(function() {
        isRefreshInFlight = false;
        setRefreshLoading(false);
      });
    });
  }
  document.getElementById('reddit-empty-retry').addEventListener('click', () => loadRedditPosts());
  document.getElementById('reddit-error-retry').addEventListener('click', () => loadRedditPosts());
  periodSelect.addEventListener('change', () => loadRedditPosts());
  sortSelect.addEventListener('change', () => loadRedditPosts());
  if (scoreFilterSelect) scoreFilterSelect.addEventListener('change', () => loadRedditPosts());

  loadSavedSubreddits();
  loadRedditPosts();
  async function scoreRedditPosts(posts) {
    // Скоррим только те посты, у которых еще нет relevance_score
    var postsToScore = posts.filter(function(p) {
      return p.relevance_score === undefined || p.relevance_score === null;
    });
    if (postsToScore.length === 0) return;
    
    // Скоррим по одному посту за раз
    for (var i = 0; i < postsToScore.length; i++) {
      var post = postsToScore[i];
      try {
        var response = await fetch('/agents/scoring_agent/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            payload: {
              title: post.title || '',
              body: post.content || '',
              subreddit: post.subreddit || '',
            }
          })
        });
        if (!response.ok) continue;
        var result = await response.json();
        if (result && result.result && result.result.score !== undefined) {
          // Обновляем score в UI
          updateRedditCardScore(post.id, result.result.score);
          // Сохраняем score на сервере
          await fetch('/reddit/posts/' + post.id + '/score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ score: result.result.score, flag: result.result.flag, reason: result.result.reason })
          }).catch(function() {});
        }
      } catch (e) {
        console.error('Scoring error:', e);
      }
    }
  }
  function getScoreColorClass(score) {
    var num = Number(score);
    if (num >= 0 && num <= 30) return 'score-red';
    if (num >= 31 && num <= 60) return 'score-yellow';
    if (num >= 61 && num <= 80) return 'score-green';
    if (num >= 81) return 'score-blue';
    return '';
  }
  function updateRedditCardScore(postId, score) {
    var card = document.querySelector('.news-card[data-id="' + postId + '"]');
    if (!card) return;
    var scoreEl = card.querySelector('.news-card-score-loading, .news-card-score');
    if (!scoreEl) return;
    var colorClass = getScoreColorClass(score);
    scoreEl.className = 'news-card-score ' + colorClass;
    scoreEl.setAttribute('data-score', score);
    scoreEl.textContent = uiText(tr.reddit_score, 'Score', 'Score') + ': ' + score;
    scoreEl.title = uiText(tr.reddit_relevance, 'Relevance: {}', 'Релевантность: {}').replace('{}', score) + '/100';
    
    // Обновляем score в детальном виде, если он открыт
    if (Number(currentViewId) === Number(postId)) {
      var detailScoreEl = document.getElementById('view-reddit-score');
      var scoreRefreshBtn = document.getElementById('view-reddit-score-refresh');
      if (detailScoreEl) {
        detailScoreEl.className = 'news-card-score ' + colorClass;
        detailScoreEl.setAttribute('data-score', score);
        detailScoreEl.textContent = uiText(tr.reddit_score, 'Score', 'Score') + ': ' + score;
        detailScoreEl.title = uiText(tr.reddit_relevance, 'Relevance: {}', 'Релевантность: {}').replace('{}', score) + '/100';
        if (scoreRefreshBtn) {
          scoreRefreshBtn.style.display = 'inline-flex';
          scoreRefreshBtn.onclick = function(e) {
            e.stopPropagation();
            refreshRedditScore(postId);
          };
        }
      }
    }
  }
  async function refreshRedditScore(postId) {
    var scoreEl = document.getElementById('view-reddit-score');
    var scoreRefreshBtn = document.getElementById('view-reddit-score-refresh');
    if (scoreEl) {
      scoreEl.textContent = '…';
      scoreEl.title = uiText(tr.reddit_score_updating, 'Updating score...', 'Обновление оценки...');
    }
    if (scoreRefreshBtn) scoreRefreshBtn.disabled = true;
    try {
      var postIdNum = Number(postId);
      var postResponse = await fetch('/reddit/posts/' + postIdNum);
      if (!postResponse.ok) throw new Error(uiText(tr.load_error, 'Failed to load post', 'Не удалось загрузить пост'));
      var post = await postResponse.json();
      
      var response = await fetch('/agents/scoring_agent/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          payload: {
            title: post.title || '',
            body: post.content || '',
            subreddit: post.subreddit || '',
          }
        })
      });
      if (!response.ok) {
        var errText = await response.text();
        throw new Error(uiText(null, 'Scoring request failed: ', 'Ошибка запроса оценки: ') + (errText || response.status));
      }
      var result = await response.json();
      if (result && result.result && result.result.score !== undefined) {
        var score = result.result.score;
        await fetch('/reddit/posts/' + postIdNum + '/score', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ score: score, flag: result.result.flag, reason: result.result.reason })
        }).catch(function() {});
        
        updateRedditCardScore(postIdNum, score);
        // Явно обновляем score в открытом drawer (на случай если карточка не в DOM)
        if (scoreEl) {
          var colorClass = getScoreColorClass(score);
          scoreEl.className = 'news-card-score ' + colorClass;
          scoreEl.setAttribute('data-score', score);
          scoreEl.textContent = uiText(tr.reddit_score, 'Score', 'Score') + ': ' + score;
          scoreEl.title = uiText(tr.reddit_relevance, 'Relevance: {}', 'Релевантность: {}').replace('{}', score) + '/100';
        }
        if (scoreRefreshBtn) {
          scoreRefreshBtn.style.display = 'inline-flex';
          scoreRefreshBtn.onclick = function(e) {
            e.stopPropagation();
            refreshRedditScore(postIdNum);
          };
        }
      } else {
        if (scoreEl) {
          scoreEl.textContent = '—';
          scoreEl.title = uiText(tr.reddit_score_failed, 'Failed to get score', 'Не удалось получить оценку');
        }
      }
    } catch (e) {
      console.error('Scoring error:', e);
      if (scoreEl) {
        scoreEl.textContent = '—';
        scoreEl.title = uiText(tr.reddit_score_error, 'Update error', 'Ошибка обновления');
      }
    } finally {
      if (scoreRefreshBtn) scoreRefreshBtn.disabled = false;
    }
  }
})();
</script>
{% endblock %}
