{% extends "base.html" %}
{% block title %}{{ tr.news_title }} — MyVOICE's{% endblock %}
{% block content %}
<div class="news-page-wrap">
<header class="news-page-header">
  <div class="news-header-top">
    <h1 class="news-page-title">{{ tr.news_title }}</h1>
    <div class="news-header-actions">
      <button type="button" id="news-make-post-btn" class="btn secondary btn-icon-text" aria-label="{{ tr.news_make_post_from_text }}" title="{{ tr.news_make_post_from_text }}">{{ tr.news_make_post_from_text }}</button>
      <button type="button" id="news-refresh-btn" class="btn secondary btn-icon-text news-refresh-btn" aria-label="{{ tr.posts_refresh }}" title="{{ tr.posts_refresh }}"><span aria-hidden="true">↻</span> {{ tr.posts_refresh }}</button>
    </div>
  </div>
  <p class="news-header-desc">{{ tr.news_lead }}</p>
  <div class="news-toolbar-row news-toolbar-row-reddit">
    <div class="news-toolbar-field">
      <label class="news-toolbar-label" for="news-source-filter">{{ tr.news_source }}</label>
      <select id="news-source-filter" class="news-toolbar-select" aria-label="{{ tr.news_source }}">
        <option value="">{{ tr.news_all_sources }}</option>
        <option value="Land Line Media">Land Line Media</option>
        <option value="Transport Topics">Transport Topics</option>
        <option value="CDLLife">CDLLife</option>
      </select>
    </div>
    <div class="news-toolbar-field">
      <label class="news-toolbar-label" for="news-score-filter">{{ tr.news_score_label }}</label>
      <select id="news-score-filter" class="news-toolbar-select" aria-label="{{ tr.news_filter_relevance }}">
        <option value="">{{ tr.news_all }}</option>
        <option value="blue">{{ tr.reddit_score_blue }}</option>
        <option value="green">{{ tr.reddit_score_green }}</option>
        <option value="yellow">{{ tr.reddit_score_yellow }}</option>
        <option value="red">{{ tr.reddit_score_red }}</option>
      </select>
    </div>
  </div>
</header>

<div id="news-feed" class="news-feed">
  <div id="news-loading" class="news-loading-skeleton" style="display: none;" aria-live="polite">
    <div class="news-skeleton-card"></div>
    <div class="news-skeleton-card"></div>
    <div class="news-skeleton-card"></div>
  </div>
  <div id="news-list"></div>
  <div id="news-empty" class="news-empty-state" style="display: none;">
    <p class="news-empty-title">{{ tr.news_empty_title }}</p>
    <p class="news-empty-desc">{{ tr.news_empty_desc }}</p>
    <button type="button" id="news-empty-retry" class="btn primary">{{ tr.news_refresh }}</button>
  </div>
  <div id="news-error" class="news-error-state" style="display: none;">
    <p class="news-error-text">{{ tr.news_error }}</p>
    <p id="news-error-detail" class="news-error-detail"></p>
    <button type="button" id="news-error-retry" class="btn secondary">{{ tr.news_retry }}</button>
  </div>
</div>
</div>

<!-- Article panel -->
<div id="news-view-drawer" class="news-view-drawer" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="news-view-title">
  <div class="news-view-backdrop" id="news-view-backdrop"></div>
  <div class="news-view-panel">
    <div class="news-view-header">
      <div class="news-view-header-top">
        <span class="news-view-header-label" aria-hidden="true">{{ tr.news_article_label }}</span>
        <div class="news-view-header-actions">
          <a id="news-view-link" href="#" target="_blank" rel="noopener" class="news-view-open-link link-tertiary" title="{{ tr.open_original }}" aria-label="{{ tr.open_original }}" style="display: none;">{{ tr.open_original }} <span aria-hidden="true">↗</span></a>
          <button type="button" class="news-view-close" id="news-view-close" title="{{ tr.common_close_esc }}" aria-label="{{ tr.common_close }}">×</button>
        </div>
      </div>
      <h2 id="news-view-title" class="news-view-title"></h2>
    </div>
    <div class="news-view-meta" id="news-view-meta">
      <span id="news-view-score-wrap" style="display: none; margin-left: var(--space-3);">
        <span id="news-view-score" class="news-card-score-loading" title="{{ tr.news_relevance_loading }}">—</span>
        <button type="button" id="news-view-score-refresh" class="news-score-refresh-btn" title="{{ tr.news_refresh_score }}" style="display: none; margin-left: var(--space-2);" aria-label="{{ tr.news_refresh_score }}">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
        </button>
      </span>
    </div>
    <div class="news-view-source" id="news-view-source"></div>
    <div class="news-view-scroll-wrap">
      <div id="news-view-body" class="news-view-body"></div>
      <div class="news-rewrite-block">
      <div class="news-rewrite-header">
        <h3 class="news-rewrite-title">{{ tr.news_rewrite_title }}</h3>
        <p class="news-rewrite-desc">{{ tr.news_rewrite_desc }}</p>
      </div>
      <div class="news-rewrite-form">
        <div class="news-rewrite-fields">
          <div class="news-rewrite-field">
            <label for="news-rewrite-author">{{ tr.reddit_as_author }}</label>
            <select id="news-rewrite-author" aria-label="{{ tr.reddit_author }}"><option value="">{{ tr.reddit_loading }}</option></select>
          </div>
          <div class="news-rewrite-field">
            <label for="news-rewrite-goal">{{ tr.reddit_goal }}</label>
            <select id="news-rewrite-goal" aria-label="{{ tr.reddit_goal }}"><option value="network">Network</option><option value="native_ads">{{ tr.reddit_goal_native }}</option><option value="full_ads">{{ tr.reddit_goal_full }}</option></select>
          </div>
          <div class="news-rewrite-field news-rewrite-field-length">
            <label for="news-rewrite-length">{{ tr.reddit_length }}</label>
            <select id="news-rewrite-length" aria-label="{{ tr.reddit_length }}"><option value="short">{{ tr.reddit_length_short }}</option><option value="medium" selected>{{ tr.reddit_length_medium }}</option><option value="long">{{ tr.reddit_length_long }}</option></select>
          </div>
          <button type="button" id="news-rewrite-btn" class="btn primary news-rewrite-btn" aria-label="{{ tr.news_rewrite_title }}">{{ tr.reddit_rewrite_btn }}</button>
          <button type="button" id="news-write-copy" class="btn secondary btn-sm news-copy-btn news-rewrite-btn">{{ tr.reddit_copy }}</button>
        </div>
        <div class="news-rewrite-output">
          <div class="news-rewrite-output-header">
            <span class="news-rewrite-result-label">{{ tr.reddit_result }}</span>
            <span id="news-write-char-count" class="news-char-count" style="font-size: var(--text-12); color: var(--text-muted);"></span>
          </div>
          <textarea id="news-write-textarea" rows="4" placeholder="{{ tr.reddit_result_placeholder }}"></textarea>
        </div>
      </div>
    </div>
    </div>
  </div>
</div>

<!-- Modal: Сделать пост по тексту -->
<div id="news-post-from-text-modal" class="news-post-from-text-modal" role="dialog" aria-modal="true" aria-labelledby="news-post-from-text-title" hidden>
  <div class="news-post-from-text-backdrop" id="news-post-from-text-backdrop"></div>
  <div class="news-post-from-text-panel">
    <div class="news-post-from-text-header">
      <h2 id="news-post-from-text-title" class="news-post-from-text-title">{{ tr.news_post_from_text_title }}</h2>
      <button type="button" class="news-post-from-text-close" id="news-post-from-text-close" title="{{ tr.common_close_esc }}" aria-label="{{ tr.common_close }}">×</button>
    </div>
    <div class="news-post-from-text-body">
      <p class="news-post-from-text-desc">{{ tr.news_post_from_text_desc }}</p>
      <label for="news-post-from-text-input">{{ tr.news_post_from_text_input_label }}</label>
      <textarea id="news-post-from-text-input" rows="6" placeholder="{{ tr.news_post_from_text_input_placeholder }}"></textarea>
      <div class="news-post-from-text-form">
        <div class="news-post-from-text-fields">
          <div class="news-post-from-text-field">
            <label for="news-post-from-text-author">{{ tr.reddit_as_author }}</label>
            <select id="news-post-from-text-author" aria-label="{{ tr.reddit_author }}"><option value="">{{ tr.reddit_loading }}</option></select>
          </div>
          <div class="news-post-from-text-field">
            <label for="news-post-from-text-goal">{{ tr.reddit_goal }}</label>
            <select id="news-post-from-text-goal" aria-label="{{ tr.reddit_goal }}"><option value="network">Network</option><option value="native_ads">{{ tr.reddit_goal_native }}</option><option value="full_ads">{{ tr.reddit_goal_full }}</option></select>
          </div>
          <div class="news-post-from-text-field">
            <label for="news-post-from-text-length">{{ tr.reddit_length }}</label>
            <select id="news-post-from-text-length" aria-label="{{ tr.reddit_length }}"><option value="short">{{ tr.reddit_length_short }}</option><option value="medium" selected>{{ tr.reddit_length_medium }}</option><option value="long">{{ tr.reddit_length_long }}</option></select>
          </div>
        </div>
        <div class="news-post-from-text-buttons">
          <button type="button" id="news-post-from-text-generate" class="btn primary news-post-from-text-generate-btn" aria-label="{{ tr.reddit_rewrite_btn }}">{{ tr.reddit_rewrite_btn }}</button>
          <button type="button" id="news-post-from-text-copy" class="btn secondary btn-sm news-post-from-text-copy-btn">{{ tr.reddit_copy }}</button>
        </div>
        <div class="news-post-from-text-output">
          <div class="news-post-from-text-output-header">
            <span>{{ tr.reddit_result }}</span>
            <span id="news-post-from-text-char-count" class="news-char-count" style="font-size: var(--text-12); color: var(--text-muted);"></span>
          </div>
          <textarea id="news-post-from-text-result" rows="6" placeholder="{{ tr.reddit_result_placeholder }}"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* ——— Страница новостей: аккуратный, читаемый дизайн ——— */
  .news-page-wrap { margin-top: 0; }
  .news-page-header { margin-bottom: var(--space-6); }
  .news-header-top { display: flex; align-items: center; justify-content: space-between; gap: var(--space-4); margin-bottom: var(--space-2); }
  .news-header-actions { display: flex; align-items: center; gap: var(--space-2); }
  .news-page-title { font-size: 1.25rem; font-weight: 700; margin: 0; color: var(--text); letter-spacing: -0.02em; }
  .news-header-desc { margin: 0 0 var(--space-4); font-size: var(--text-12); color: var(--text-muted); line-height: 1.5; max-width: 42rem; }
  .news-toolbar-row { display: flex; align-items: center; gap: var(--space-4); flex-wrap: wrap; }
  .news-toolbar-row-reddit { align-items: flex-start; }
  .news-toolbar-row-reddit .news-toolbar-field { gap: var(--space-2); }
  .news-toolbar-field { display: flex; flex-direction: column; gap: var(--space-1); }
  .news-toolbar-label { font-size: var(--text-12); font-weight: 500; color: var(--text-muted); margin: 0; text-transform: uppercase; letter-spacing: 0.04em; }
  .news-toolbar-select { min-width: 160px; height: 2.25rem; padding: 0 var(--space-3); font-size: var(--text-14); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface); color: var(--text); box-sizing: border-box; }
  .news-toolbar-select:focus { outline: none; border-color: var(--primary); box-shadow: var(--focus-ring); }
  .btn-icon-text { display: inline-flex; align-items: center; gap: var(--space-2); }
  .news-refresh-btn { height: 2.25rem; padding: 0 var(--space-4); }
  .news-feed { margin-top: 0; }
  .news-loading-skeleton { display: flex; flex-direction: column; gap: var(--space-4); padding: var(--space-4) 0; }
  .news-skeleton-card { height: 160px; border-radius: var(--radius-lg); background: linear-gradient(90deg, var(--border) 25%, var(--surface) 50%, var(--border) 75%); background-size: 200% 100%; animation: news-skeleton-shine 1.2s ease-in-out infinite; }
  @keyframes news-skeleton-shine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  .news-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: var(--space-6); margin-bottom: var(--space-4); cursor: pointer; transition: box-shadow var(--motion-normal), border-color var(--motion-fast), transform var(--motion-fast); box-shadow: 0 1px 3px rgba(0,0,0,0.04); position: relative; overflow: hidden; }
  .news-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, var(--primary) 0%, rgba(99,102,241,0.3) 100%); opacity: 0; transition: opacity var(--motion-fast); }
  .news-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 2px 6px rgba(99,102,241,0.12); border-color: rgba(99,102,241,0.35); }
  .news-card:hover::before { opacity: 1; }
  .news-card-top { display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); margin-bottom: var(--space-3); }
  .news-card-meta { font-size: var(--text-12); color: var(--text-muted); }
  .news-card-meta a { color: inherit; text-decoration: none; }
  .news-card-meta a:hover { color: var(--primary); }
  .news-card-open-link { display: inline-flex; align-items: center; gap: var(--space-1); font-size: var(--text-12); color: var(--text-muted); text-decoration: none; padding: 2px 6px; border-radius: var(--radius-sm); transition: color var(--motion-fast), background var(--motion-fast); }
  .news-card-open-link:hover { color: var(--primary); background: var(--bg); text-decoration: none; }
  .news-card-open-link:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .news-card-body { margin-bottom: var(--space-3); }
  .news-card-title { font-size: 0.9375rem; font-weight: 600; margin: 0 0 var(--space-2); line-height: 1.4; color: var(--text); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .news-card-title a { color: inherit; text-decoration: none; }
  .news-card-title a:hover { color: var(--primary); }
  .news-card-summary { font-size: var(--text-14); line-height: 1.5; color: var(--text); margin: 0; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  .news-card-footer { display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); flex-wrap: wrap; }
  .news-card-footer-left { display: flex; align-items: center; gap: var(--space-3); font-size: var(--text-12); color: var(--text-muted); }
  .news-card-footer-left button { background: none; border: none; padding: 0; font-size: inherit; color: var(--primary); cursor: pointer; font-weight: 500; }
  .news-card-footer-left button:hover { text-decoration: underline; }
  .news-card-footer-left button:focus-visible { outline: none; border-radius: var(--radius-sm); box-shadow: var(--focus-ring); }
  .news-card-actions { display: flex; align-items: center; gap: var(--space-2); flex-shrink: 0; }
  .news-card-actions .news-card-score,
  .news-card-actions .news-card-score-loading { margin-right: 0; }
  .news-card-link-icon { flex-shrink: 0; color: var(--text-muted); }
  .news-card-link-icon:hover { color: var(--primary); }
  .news-card-link-corner { flex-shrink: 0; min-width: 28px; min-height: 28px; padding: 0; border: none; background: transparent; color: var(--text-muted); border-radius: 0; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; transition: color var(--motion-fast); font-size: 1.1rem; line-height: 1; }
  .news-card-link-corner:hover { background: transparent; color: var(--primary); text-decoration: none; }
  .news-card-link-corner:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .news-card-top-right-wrap { display: flex; align-items: center; gap: var(--space-2); flex-shrink: 0; }
  .news-card-source-wrap { font-size: var(--text-12); color: var(--text-muted); }
  .news-card-source { font-size: inherit; color: inherit; }
  .news-card-source a { color: var(--primary); font-weight: 500; }
  .news-card-source a:hover { text-decoration: underline; }
  .news-card-read-more { font-size: var(--text-14); color: var(--primary); background: none; border: none; cursor: pointer; padding: 0; font-weight: 500; }
  .news-card-read-more:hover { text-decoration: underline; }
  .news-card-read-more:focus-visible { outline: none; border-radius: var(--radius-sm); box-shadow: var(--focus-ring); }
  .news-card-stats { margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid var(--border); font-size: var(--text-12); color: var(--text-muted); }
  .news-card-score {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 4.5rem;
    height: 1.5rem;
    padding: 0 var(--space-2);
    font-size: var(--text-12);
    font-weight: 600;
    border-radius: var(--radius-sm);
    border: 1px solid;
  }
  /* 0-30: красный */
  .news-card-score.score-red {
    background: #fee2e2;
    color: #dc2626;
    border-color: #dc2626;
  }
  /* 31-60: желтый */
  .news-card-score.score-yellow {
    background: #fef3c7;
    color: #d97706;
    border-color: #d97706;
  }
  /* 61-80: зеленый */
  .news-card-score.score-green {
    background: #d1fae5;
    color: #10b981;
    border-color: #10b981;
  }
  /* 81+: синий */
  .news-card-score.score-blue {
    background: #dbeafe;
    color: #2563eb;
    border-color: #2563eb;
  }
  .news-card-score-loading {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2.5rem;
    height: 1.5rem;
    padding: 0 var(--space-2);
    font-size: var(--text-12);
    font-weight: 600;
    color: var(--text-muted);
    border-radius: var(--radius-sm);
    background: var(--bg);
    border: 1px solid var(--border);
  }
  .news-score-refresh-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    padding: 0;
    border: none;
    background: var(--bg);
    color: var(--text-muted);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background var(--motion-fast), color var(--motion-fast);
  }
  .news-score-refresh-btn:hover:not(:disabled) {
    background: var(--primary-soft);
    color: var(--primary);
  }
  .news-score-refresh-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .news-score-refresh-btn:focus-visible {
    outline: none;
    box-shadow: var(--focus-ring);
  }
  .news-empty-state, .news-error-state { text-align: center; padding: var(--space-10); background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
  .news-empty-title, .news-error-text { margin: 0 0 var(--space-2); font-weight: 600; font-size: var(--text-16); color: var(--text); }
  .news-empty-desc, .news-error-detail { margin: 0 0 var(--space-4); color: var(--text-muted); font-size: var(--text-14); line-height: 1.5; }
  /* Drawer: панель выезжает справа */
  .news-view-drawer { position: fixed; inset: 0; z-index: 100; display: none; pointer-events: none; }
  .news-view-drawer.is-open { display: block; pointer-events: auto; }
  .news-view-backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.45); backdrop-filter: blur(6px); opacity: 0; transition: opacity 0.3s ease; }
  .news-view-drawer.is-open .news-view-backdrop { opacity: 1; }
  .news-view-panel { position: absolute; top: 0; right: 0; width: 65vw; max-width: 1200px; height: 100%; background: var(--surface); transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: -12px 0 48px rgba(0,0,0,0.12), -4px 0 16px rgba(0,0,0,0.06); overflow: hidden; }
  .news-view-drawer.is-open .news-view-panel { transform: translateX(0); }
  .news-view-header { padding: var(--space-4) var(--space-6) var(--space-5); border-bottom: 1px solid var(--border); flex-shrink: 0; background: var(--surface); }
  .news-view-header-top { display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); margin-bottom: var(--space-3); }
  .news-view-header-label { font-size: var(--text-12); font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
  .news-view-header-actions { display: flex; align-items: center; gap: var(--space-2); flex-shrink: 0; }
  .news-view-title { margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text); line-height: 1.35; letter-spacing: -0.02em; }
  .news-view-link-icon { flex-shrink: 0; color: var(--text-muted); }
  .news-view-link-icon:hover { color: var(--primary); }
  .news-view-open-link { font-size: var(--text-14); font-weight: 500; white-space: nowrap; }
  .news-view-open-link.link-tertiary { color: var(--primary); background: none; border: none; padding: 0; text-decoration: none; cursor: pointer; }
  .news-view-open-link.link-tertiary:hover { text-decoration: underline; }
  .news-view-open-link.link-tertiary:focus-visible { outline: none; border-radius: var(--radius-sm); box-shadow: var(--focus-ring); }
  .news-view-close { min-width: 32px; min-height: 32px; padding: 0; border: none; background: transparent; color: var(--text-muted); font-size: 1.25rem; line-height: 1; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: color var(--motion-fast), background var(--motion-fast); }
  .news-view-close:hover { background: var(--bg); color: var(--text); }
  .news-view-close:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .news-view-meta { padding: var(--space-2) var(--space-6); font-size: var(--text-14); color: var(--text-muted); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .news-view-source { padding: var(--space-2) var(--space-6); font-size: var(--text-14); color: var(--text-muted); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .news-view-source a { color: var(--primary); font-weight: 500; }
  .news-view-source a:hover { text-decoration: underline; }
  .news-view-scroll-wrap { flex: 1; min-height: 0; overflow-y: auto; }
  .news-view-body { padding: var(--space-6); font-size: var(--text-16); line-height: 1.7; color: var(--text); }
  .news-view-body p { margin: 0 0 var(--space-4); }
  .news-view-body p:last-child { margin-bottom: 0; }
  .news-view-body h2, .news-view-body h3 { margin: var(--space-6) 0 var(--space-3); font-size: 1.25em; font-weight: 600; color: var(--text); }
  .news-view-body ul { margin: 0 0 var(--space-4); padding-left: var(--space-6); }
  .news-view-loading { color: var(--text-muted); font-style: italic; margin: 0; }
  /* Блок «Переписать эту новость» */
  .news-rewrite-block {
    flex-shrink: 0;
    margin: var(--space-3) var(--space-4) var(--space-4);
    padding: var(--space-4);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .news-rewrite-header {
    margin-bottom: var(--space-2);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--border);
  }
  .news-rewrite-title {
    margin: 0 0 var(--space-1);
    font-size: var(--text-14);
    font-weight: 600;
    color: var(--text);
  }
  .news-rewrite-desc {
    margin: 0;
    font-size: var(--text-12);
    color: var(--text-muted);
    line-height: 1.45;
  }
  .news-rewrite-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }
  .news-rewrite-fields {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-2);
  }
  .news-rewrite-field {
    flex: 1 1 0;
    min-width: 95px;
    max-width: 170px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .news-rewrite-field label {
    font-size: var(--text-12);
    font-weight: 500;
    color: var(--text-muted);
    margin: 0;
  }
  .news-rewrite-field select {
    height: 2.25rem;
    padding: 0 var(--space-2);
    font-size: var(--text-14);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text);
    box-sizing: border-box;
    transition: border-color var(--motion-fast), box-shadow var(--motion-fast);
  }
  .news-rewrite-field select:hover {
    border-color: var(--text-muted);
  }
  .news-rewrite-field select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--focus-ring);
  }
  .news-rewrite-field-length { max-width: 210px; }
  .news-rewrite-btn {
    height: 2.25rem;
    padding: 0 var(--space-4);
    font-weight: 600;
    flex-shrink: 0;
  }
  .news-rewrite-btn.news-copy-btn { height: 2.25rem; padding: 0 var(--space-3); }
  #news-rewrite-btn { margin-left: auto; }
  .news-rewrite-output {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }
  .news-rewrite-output-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
  }
  .news-rewrite-result-label {
    font-size: var(--text-12);
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .news-rewrite-block textarea {
    width: 100%;
    min-height: 3.5rem;
    padding: var(--space-2) var(--space-3);
    font-family: inherit;
    font-size: var(--text-14);
    line-height: 1.55;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg);
    resize: vertical;
    box-sizing: border-box;
    display: block;
    transition: border-color var(--motion-fast), box-shadow var(--motion-fast);
  }
  .news-rewrite-block textarea:hover {
    border-color: var(--text-muted);
  }
  .news-rewrite-block textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
  }
  .news-rewrite-block textarea::placeholder {
    color: var(--text-muted);
  }
  .news-copy-btn {
    flex-shrink: 0;
  }
  .news-char-count {
    font-size: var(--text-12);
    color: var(--text-muted);
    white-space: nowrap;
  }
  .news-char-count-valid {
    color: var(--success, #10b981);
  }
  .news-char-count-too-short,
  .news-char-count-too-long {
    color: var(--error, #ef4444);
    font-weight: 500;
  }
  /* Modal: Сделать пост по тексту */
  .news-post-from-text-modal {
    position: fixed;
    inset: 0;
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-6);
    pointer-events: none;
  }
  .news-post-from-text-modal[hidden] { display: none !important; }
  .news-post-from-text-modal.is-open { pointer-events: auto; }
  .news-post-from-text-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  .news-post-from-text-modal.is-open .news-post-from-text-backdrop { opacity: 1; }
  .news-post-from-text-panel {
    position: relative;
    width: 100%;
    max-width: 640px;
    max-height: 90vh;
    overflow-y: auto;
    background: var(--surface);
    border-radius: var(--radius-lg);
    box-shadow: var(--elevation-modal);
    border: 1px solid var(--border);
    padding: var(--space-6);
    transform: scale(0.96);
    opacity: 0;
    transition: transform 0.2s ease, opacity 0.2s ease;
  }
  .news-post-from-text-modal.is-open .news-post-from-text-panel {
    transform: scale(1);
    opacity: 1;
  }
  .news-post-from-text-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
  }
  .news-post-from-text-title {
    margin: 0;
    font-size: var(--text-20);
    font-weight: 600;
    color: var(--text);
  }
  .news-post-from-text-close {
    width: 2.25rem;
    height: 2.25rem;
    padding: 0;
    border: none;
    background: var(--bg);
    color: var(--text-muted);
    font-size: 1.5rem;
    line-height: 1;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background var(--motion-fast), color var(--motion-fast);
  }
  .news-post-from-text-close:hover {
    background: var(--border);
    color: var(--text);
  }
  .news-post-from-text-body { display: flex; flex-direction: column; gap: var(--space-4); }
  .news-post-from-text-desc {
    margin: 0;
    font-size: var(--text-14);
    color: var(--text-muted);
    line-height: 1.5;
  }
  .news-post-from-text-body label {
    font-size: var(--text-14);
    font-weight: 500;
    color: var(--text);
    margin: 0;
  }
  .news-post-from-text-body #news-post-from-text-input {
    width: 100%;
    padding: var(--space-3);
    font-family: inherit;
    font-size: var(--text-14);
    line-height: 1.55;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    resize: vertical;
    box-sizing: border-box;
  }
  .news-post-from-text-body #news-post-from-text-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--focus-ring);
  }
  .news-post-from-text-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    margin-top: var(--space-2);
  }
  .news-post-from-text-fields {
    display: flex;
    gap: var(--space-2);
    align-items: flex-end;
  }
  .news-post-from-text-field {
    flex: 1 1 0;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .news-post-from-text-buttons {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-top: var(--space-2);
  }
  .news-post-from-text-generate-btn,
  .news-post-from-text-copy-btn {
    height: 2.25rem;
    padding: 0 var(--space-4);
    font-weight: 600;
  }
  .news-post-from-text-field label {
    font-size: var(--text-12);
    font-weight: 500;
    color: var(--text-muted);
    margin: 0;
  }
  .news-post-from-text-field select {
    width: 100%;
    min-width: 0;
    height: 2.25rem;
    padding: 0 var(--space-2);
    font-size: var(--text-14);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text);
    box-sizing: border-box;
  }
  .news-post-from-text-field select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--focus-ring);
  }
  .news-post-from-text-output {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }
  .news-post-from-text-output-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
  }
  .news-post-from-text-output-header span {
    font-size: var(--text-12);
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .news-post-from-text-output textarea {
    width: 100%;
    min-height: 6rem;
    padding: var(--space-2) var(--space-3);
    font-family: inherit;
    font-size: var(--text-14);
    line-height: 1.55;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg);
    resize: vertical;
    box-sizing: border-box;
  }
  .news-post-from-text-output textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: var(--focus-ring);
  }
</style>
<script>
(function() {
  const tr = window.__tr || {};
  function escapeHtml(s) {
    if (s == null) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }
  var localeForDate = (typeof window.__locale !== 'undefined' && window.__locale === 'en') ? 'en-US' : 'ru-RU';
  function formatDate(iso) {
    if (!iso) return '—';
    try {
      var d = new Date(iso);
      return d.toLocaleDateString(localeForDate, { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    } catch (e) { return iso; }
  }
  function relativeTime(iso) {
    if (!iso) return '—';
    try {
      var d = new Date(iso);
      var now = new Date();
      var s = Math.floor((now - d) / 1000);
      if (s < 60) return (tr.news_time_just_now || 'just now');
      if (s < 3600) return (tr.news_time_min_ago || '{} min ago').replace('{}', Math.floor(s / 60));
      if (s < 86400) return (tr.news_time_hr_ago || '{} hr ago').replace('{}', Math.floor(s / 3600));
      if (s < 604800) return (tr.news_time_days_ago || '{} days ago').replace('{}', Math.floor(s / 86400));
      return formatDate(iso);
    } catch (e) { return iso; }
  }
  var listEl = document.getElementById('news-list');
  var loadingEl = document.getElementById('news-loading');
  var emptyEl = document.getElementById('news-empty');
  var errorEl = document.getElementById('news-error');
  var refreshBtn = document.getElementById('news-refresh-btn');
  var emptyRetryBtn = document.getElementById('news-empty-retry');
  var errorRetryBtn = document.getElementById('news-error-retry');
  var lastNewsItems = [];
  var currentNewsItem = null;

  function setState(loading, empty, error) {
    if (loadingEl) loadingEl.style.display = loading ? 'flex' : 'none';
    if (emptyEl) emptyEl.style.display = empty ? 'block' : 'none';
    if (errorEl) errorEl.style.display = error ? 'block' : 'none';
    if (listEl) listEl.style.display = (loading || empty || error) ? 'none' : 'block';
  }
  function setErrorDetail(msg) {
    var el = document.getElementById('news-error-detail');
    if (el) { el.textContent = msg || ''; el.style.display = msg ? 'block' : 'none'; }
  }
  function renderNewsList() {
    if (!listEl) return;
    var sourceFilter = document.getElementById('news-source-filter');
    var scoreFilterSelect = document.getElementById('news-score-filter');
    var filterVal = sourceFilter ? sourceFilter.value : '';
    var scoreRange = scoreFilterSelect ? scoreFilterSelect.value : '';
    var withIdx = lastNewsItems.length ? lastNewsItems.map(function(item, idx) { return { item: item, origIdx: idx }; }) : [];
    var filtered = filterVal ? withIdx.filter(function(x) { return x.item.source === filterVal; }) : withIdx;
    if (scoreRange) {
      filtered = filtered.filter(function(x) {
        var s = x.item.score;
        if (s === undefined || s === null) return false;
        if (scoreRange === 'red') return s >= 0 && s <= 30;
        if (scoreRange === 'yellow') return s >= 31 && s <= 60;
        if (scoreRange === 'green') return s >= 61 && s <= 80;
        if (scoreRange === 'blue') return s >= 81;
        return true;
      });
    }
    if (filtered.length === 0 && lastNewsItems.length > 0 && (filterVal || scoreRange)) {
      if (emptyEl) {
        emptyEl.style.display = 'block';
        var titleEl = emptyEl.querySelector('.news-empty-title');
        var descEl = emptyEl.querySelector('.news-empty-desc');
        if (titleEl) titleEl.textContent = tr.news_empty_title || 'No news';
        if (descEl) descEl.textContent = filterVal && scoreRange ? (tr.news_empty_filter_both || 'No news for selected filters.') : filterVal ? (tr.news_empty_filter_source || 'Select another source.') : (tr.news_empty_filter_score || 'No news with selected Score.');
      }
      if (emptyRetryBtn) emptyRetryBtn.style.display = 'none';
      if (listEl) { listEl.style.display = 'none'; listEl.innerHTML = ''; }
      setState(false, true, false);
      return;
    }
    if (filtered.length === 0 && lastNewsItems.length === 0) {
      setState(false, true, false);
      listEl.innerHTML = '';
      return;
    }
    setState(false, false, false);
    listEl.style.display = 'block';
    if (emptyEl) emptyEl.style.display = 'none';
    listEl.innerHTML = filtered.map(function(x) {
      var item = x.item;
      var idx = x.origIdx;
      var title = escapeHtml(item.title || (tr.news_no_title || 'No title'));
      var link = (item.link || '').trim();
      var summary = escapeHtml(item.summary || '');
      var publishedRel = relativeTime(item.published);
      var sourceName = item.source || 'Land Line Media';
      var openOrig = tr.open_original || 'Open original';
      var linkText = link ? '<a href="' + escapeHtml(link) + '" target="_blank" rel="noopener" class="news-card-open-link" title="' + openOrig + '" aria-label="' + openOrig + '" onclick="event.stopPropagation()">' + openOrig + ' <span aria-hidden="true">↗</span></a>' : '';
      var score = item.score !== undefined && item.score !== null ? item.score : null;
      var scoreColorClass = score !== null ? getScoreColorClass(score) : '';
      var relevanceTitle = (tr.news_relevance_score || 'Relevance: {}').replace('{}', score) + '/100';
      var scoreHtml = score !== null 
        ? '<span class="news-card-score ' + scoreColorClass + '" data-score="' + score + '" title="' + relevanceTitle + '">Score: ' + score + '</span>' 
        : '<span class="news-card-score-loading" data-index="' + idx + '" title="' + (tr.news_relevance_loading || 'Relevance score...') + '">—</span>';
      return '<article class="news-card" data-index="' + idx + '" role="button" tabindex="0">' +
        '<div class="news-card-top">' +
          '<span class="news-card-meta">' + escapeHtml(sourceName) + ' · ' + escapeHtml(publishedRel) + '</span>' +
          (link ? '<div class="news-card-top-right-wrap">' + linkText + '</div>' : '') +
        '</div>' +
        '<div class="news-card-body">' +
          '<h2 class="news-card-title">' + title + '</h2>' +
          (summary ? '<p class="news-card-summary">' + summary + '</p>' : '') +
        '</div>' +
        '<div class="news-card-footer">' +
          '<div class="news-card-footer-left">' +
            '<button type="button" class="news-card-read-more btn-news-read-full" data-index="' + idx + '" onclick="event.stopPropagation()">' + (tr.news_expand || 'Expand') + '</button>' +
          '</div>' +
          '<div class="news-card-actions">' +
            scoreHtml +
            '<button type="button" class="btn primary btn-sm btn-news-rewrite-post" data-index="' + idx + '" onclick="event.stopPropagation()">' + (tr.news_make_post || 'Make post') + '</button>' +
          '</div>' +
        '</div>' +
        '</article>';
    }).join('');
    listEl.querySelectorAll('.news-card').forEach(function(card) {
      card.addEventListener('click', function(e) {
        if (e.target.closest('a') || e.target.closest('.news-card-read-more') || e.target.closest('.news-card-footer') || e.target.closest('.btn-news-rewrite-post')) return;
        var idx = parseInt(card.getAttribute('data-index'), 10);
        openNewsView(idx);
      });
      card.addEventListener('keydown', function(e) {
        if (e.key !== 'Enter' && e.key !== ' ') return;
        if (e.target.closest('a') || e.target.closest('.news-card-read-more') || e.target.closest('.news-card-footer') || e.target.closest('.btn-news-rewrite-post')) return;
        e.preventDefault();
        var idx = parseInt(card.getAttribute('data-index'), 10);
        openNewsView(idx);
      });
    });
    listEl.querySelectorAll('.btn-news-read-full').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var idx = parseInt(btn.getAttribute('data-index'), 10);
        openNewsView(idx);
      });
    });
    listEl.querySelectorAll('.btn-news-rewrite-post').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var idx = parseInt(btn.getAttribute('data-index'), 10);
        openNewsView(idx);
      });
    });
  }
  function itemKey(it) {
    return (it.link || '').trim() || (it.title || '') + (it.published || '');
  }
  async function scoreNewsItems() {
    // Скоррим только те новости, у которых еще нет score
    var itemsToScore = lastNewsItems.filter(function(item, idx) {
      return item.score === undefined || item.score === null;
    });
    if (itemsToScore.length === 0) {
      console.log('No items to score');
      return;
    }
    console.log('Scoring', itemsToScore.length, 'items');
    
    // Скоррим по одной новости за раз
    for (var i = 0; i < itemsToScore.length; i++) {
      var item = itemsToScore[i];
      var idx = lastNewsItems.indexOf(item);
      if (idx === -1) continue;
      
      try {
        var response = await fetch('/agents/scoring_agent/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            payload: {
              title: item.title || '',
              body: item.summary || item.content || '',
            }
          })
        });
        if (!response.ok) {
          console.warn('Scoring request failed for item', idx, response.status);
          continue;
        }
        var result = await response.json();
        if (result && result.result && result.result.score !== undefined) {
          lastNewsItems[idx].score = result.result.score;
          lastNewsItems[idx].score_flag = result.result.flag;
          lastNewsItems[idx].score_reason = result.result.reason;
          // Сохраняем score в БД, если у новости есть id
          if (item.id) {
            fetch('/news/items/' + item.id + '/score', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ score: result.result.score, flag: result.result.flag, reason: result.result.reason })
            }).catch(function() {});
          }
          // Обновляем отображение этой карточки
          updateNewsCardScore(idx, result.result.score);
          console.log('Scored item', idx, 'score:', result.result.score);
        } else {
          console.warn('Invalid scoring result for item', idx, result);
        }
      } catch (e) {
        console.error('Scoring error for item', idx, ':', e);
      }
    }
  }
  function getScoreColorClass(score) {
    var num = Number(score);
    if (num >= 0 && num <= 30) return 'score-red';
    if (num >= 31 && num <= 60) return 'score-yellow';
    if (num >= 61 && num <= 80) return 'score-green';
    if (num >= 81) return 'score-blue';
    return '';
  }
  function updateNewsCardScore(idx, score) {
    var card = document.querySelector('.news-card[data-index="' + idx + '"]');
    if (!card) {
      console.warn('Card not found for index:', idx);
      return;
    }
    var scoreEl = card.querySelector('.news-card-score-loading, .news-card-score');
    if (!scoreEl) {
      console.warn('Score element not found in card:', idx);
      return;
    }
    var colorClass = getScoreColorClass(score);
    scoreEl.className = 'news-card-score ' + colorClass;
    scoreEl.setAttribute('data-score', score);
    scoreEl.textContent = 'Score: ' + score;
    scoreEl.title = (tr.news_relevance_score || 'Relevance: {}').replace('{}', score + '/100');
    // Убираем data-index если был
    scoreEl.removeAttribute('data-index');
    
    // Обновляем score в детальном виде, если он открыт
    if (currentNewsItem && currentNewsItem === lastNewsItems[idx]) {
      var scoreWrap = document.getElementById('news-view-score-wrap');
      var detailScoreEl = document.getElementById('news-view-score');
      var scoreRefreshBtn = document.getElementById('news-view-score-refresh');
      if (scoreWrap && detailScoreEl) {
        detailScoreEl.className = 'news-card-score ' + colorClass;
        detailScoreEl.setAttribute('data-score', score);
        detailScoreEl.textContent = 'Score: ' + score;
        detailScoreEl.title = (tr.news_relevance_score || 'Relevance: {}').replace('{}', score + '/100');
        if (scoreRefreshBtn) {
          scoreRefreshBtn.style.display = 'inline-flex';
          scoreRefreshBtn.onclick = function(e) {
            e.stopPropagation();
            refreshNewsScore(idx);
          };
        }
      }
    }
  }
  async function refreshNewsScore(index) {
    var item = lastNewsItems[index];
    if (!item) return;
    var scoreEl = document.getElementById('news-view-score');
    var scoreRefreshBtn = document.getElementById('news-view-score-refresh');
    if (scoreEl) {
      scoreEl.textContent = '…';
      scoreEl.title = (tr.reddit_score_updating || 'Updating score...');
    }
    if (scoreRefreshBtn) scoreRefreshBtn.disabled = true;
    try {
      var response = await fetch('/agents/scoring_agent/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          payload: {
            title: item.title || '',
            body: item.summary || item.content || '',
          }
        })
      });
      if (!response.ok) {
        throw new Error('Scoring request failed');
      }
      var result = await response.json();
      if (result && result.result && result.result.score !== undefined) {
        var score = result.result.score;
        lastNewsItems[index].score = score;
        lastNewsItems[index].score_flag = result.result.flag;
        lastNewsItems[index].score_reason = result.result.reason;
        if (lastNewsItems[index].id) {
          fetch('/news/items/' + lastNewsItems[index].id + '/score', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ score: score, flag: result.result.flag, reason: result.result.reason })
          }).catch(function() {});
        }
        updateNewsCardScore(index, score);
        // Явно обновляем score в открытом drawer
        if (scoreEl) {
          var colorClass = getScoreColorClass(score);
          scoreEl.className = 'news-card-score ' + colorClass;
          scoreEl.setAttribute('data-score', score);
          scoreEl.textContent = 'Score: ' + score;
          scoreEl.title = (tr.news_relevance_score || 'Relevance: {}').replace('{}', score + '/100');
        }
        if (scoreRefreshBtn) {
          scoreRefreshBtn.style.display = 'inline-flex';
          scoreRefreshBtn.onclick = function(e) {
            e.stopPropagation();
            refreshNewsScore(index);
          };
        }
      } else {
        if (scoreEl) {
          scoreEl.textContent = '—';
          scoreEl.title = (tr.reddit_score_failed || 'Failed to get score');
        }
      }
    } catch (e) {
      console.error('Scoring error:', e);
      if (scoreEl) {
        scoreEl.textContent = '—';
        scoreEl.title = (tr.news_score_update_error || 'Update error');
      }
    } finally {
      if (scoreRefreshBtn) scoreRefreshBtn.disabled = false;
    }
  }
  function loadNews(forceRefresh) {
    setErrorDetail('');
    setState(true, false, false);
    var url = forceRefresh ? '/news/refresh' : '/news';
    var opts = forceRefresh ? { method: 'POST', headers: { 'Content-Type': 'application/json' } } : {};
    fetch(url, opts)
      .then(function(r) {
        if (!r.ok) {
          return r.json().then(function(body) {
            var detail = (body && body.detail) ? body.detail : r.statusText || (tr.news_load_error || 'Load error');
            setErrorDetail(detail);
            throw new Error(detail);
          }).catch(function(e) {
            if (!document.getElementById('news-error-detail').textContent)
              setErrorDetail(e.message || (tr.news_server_error || 'Server error {}').replace('{}', r.status));
            throw e;
          });
        }
        return r.json();
      })
      .then(function(data) {
        var items = data.items || [];
        setState(false, false, false);
        lastNewsItems = items;
        if (items.length === 0) {
          setState(false, true, false);
          listEl.innerHTML = '';
          return;
        }
        renderNewsList();
        // Запускаем скорринг для всех новостей без score
        scoreNewsItems();
        if (forceRefresh && typeof window.toast === 'function') window.toast(tr.news_updated_toast || 'News updated');
      })
      .catch(function(err) {
        setState(false, false, true);
        listEl.innerHTML = '';
        if (!document.getElementById('news-error-detail').textContent)
          setErrorDetail(err && err.message ? err.message : (tr.news_check_connection || 'Check your internet connection.'));
      });
  }
  function stripLinksInHtml(html) {
    if (!html || !/<a\b/i.test(html)) return html;
    var div = document.createElement('div');
    div.innerHTML = html;
    div.querySelectorAll('a').forEach(function(a) {
      a.replaceWith(document.createTextNode(a.textContent || ''));
    });
    return div.innerHTML;
  }
  function openNewsView(index) {
    var item = lastNewsItems[index];
    if (!item) return;
    currentNewsItem = item;
    var ta = document.getElementById('news-write-textarea');
    if (ta) ta.value = '';
    updateNewsCharCount();
    var drawer = document.getElementById('news-view-drawer');
    var titleEl = document.getElementById('news-view-title');
    var metaEl = document.getElementById('news-view-meta');
    var sourceEl = document.getElementById('news-view-source');
    var bodyEl = document.getElementById('news-view-body');
    var linkEl = document.getElementById('news-view-link');
    var scoreWrap = document.getElementById('news-view-score-wrap');
    var scoreEl = document.getElementById('news-view-score');
    var scoreRefreshBtn = document.getElementById('news-view-score-refresh');
    if (titleEl) titleEl.textContent = item.title || (tr.news_no_title || 'No title');
    var dateText = formatDate(item.published);
    // Обновляем score в детальном виде
    if (scoreWrap && scoreEl) {
      scoreWrap.style.display = 'inline-flex';
      scoreWrap.style.alignItems = 'center';
      scoreWrap.style.gap = 'var(--space-2)';
      var score = item.score !== undefined && item.score !== null ? item.score : null;
      if (score !== null) {
        var colorClass = getScoreColorClass(score);
        scoreEl.className = 'news-card-score ' + colorClass;
        scoreEl.setAttribute('data-score', score);
        scoreEl.textContent = 'Score: ' + score;
        scoreEl.title = (tr.news_relevance_score || 'Relevance: {}').replace('{}', score + '/100');
        if (scoreRefreshBtn) {
          scoreRefreshBtn.style.display = 'inline-flex';
          scoreRefreshBtn.onclick = function(e) {
            e.stopPropagation();
            refreshNewsScore(index);
          };
        }
      } else {
        scoreEl.className = 'news-card-score-loading';
        scoreEl.textContent = '—';
        scoreEl.title = (tr.news_relevance_loading || 'Relevance score...');
        if (scoreRefreshBtn) {
          scoreRefreshBtn.style.display = 'inline-flex';
          scoreRefreshBtn.onclick = function(e) {
            e.stopPropagation();
            refreshNewsScore(index);
          };
        }
      }
    }
    // Устанавливаем мета-информацию (дата + score)
    if (metaEl) {
      metaEl.innerHTML = dateText + ' ';
      if (scoreWrap) {
        metaEl.appendChild(scoreWrap);
      }
    }
    if (sourceEl) {
      var sName = item.source || 'Land Line Media';
      var sUrl = (item.sourceUrl || 'https://landline.media/news/').trim();
      var sLabel = sName === 'Transport Topics' ? 'ttnews.com' : (sName === 'CDLLife' ? 'cdllife.com' : 'landline.media');
      sourceEl.innerHTML = (tr.reddit_source || 'Source:') + ' <a href="' + escapeHtml(sUrl) + '" target="_blank" rel="noopener">' + escapeHtml(sName) + '</a> (' + escapeHtml(sLabel) + ')';
    }
    var fallbackContent = item.content || item.summary || '';
    if (bodyEl) {
      bodyEl.innerHTML = '<p class="news-view-loading">' + (tr.news_loading_full || 'Loading full text…') + '</p>';
    }
    if (linkEl) {
      linkEl.href = item.link || '#';
      linkEl.style.display = (item.link && item.link !== '#') ? 'inline' : 'none';
    }
    if (drawer) {
      drawer.classList.add('is-open');
      drawer.setAttribute('aria-hidden', 'false');
    }
    var articleUrl = (item.link || '').trim();
    if (articleUrl && articleUrl !== '#') {
      fetch('/news/full?url=' + encodeURIComponent(articleUrl))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!bodyEl) return;
          if (data.content && data.content.length > 50) {
            bodyEl.innerHTML = data.content;
          } else {
            if (bodyEl) {
              if (/<[a-z][\s\S]*>/i.test(fallbackContent)) bodyEl.innerHTML = stripLinksInHtml(fallbackContent);
              else bodyEl.textContent = fallbackContent || '';
            }
          }
        })
        .catch(function() {
          if (bodyEl) {
            if (/<[a-z][\s\S]*>/i.test(fallbackContent)) bodyEl.innerHTML = stripLinksInHtml(fallbackContent);
            else bodyEl.textContent = fallbackContent || '';
          }
        });
    } else {
      if (bodyEl) {
        if (/<[a-z][\s\S]*>/i.test(fallbackContent)) bodyEl.innerHTML = stripLinksInHtml(fallbackContent);
        else bodyEl.textContent = fallbackContent || (tr.news_no_text || 'No text.');
      }
    }
  }
  function closeNewsView() {
    var drawer = document.getElementById('news-view-drawer');
    if (drawer) {
      drawer.classList.remove('is-open');
      drawer.setAttribute('aria-hidden', 'true');
    }
  }
  document.getElementById('news-view-backdrop').addEventListener('click', closeNewsView);
  document.getElementById('news-view-close').addEventListener('click', closeNewsView);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeNewsView();
  });
  var copyBtn = document.getElementById('news-write-copy');
  if (copyBtn) {
    copyBtn.addEventListener('click', function() {
      var ta = document.getElementById('news-write-textarea');
      var text = ta ? ta.value : '';
      if (!text) return;
      navigator.clipboard.writeText(text).then(function() {
        if (typeof window.toast === 'function') window.toast(tr.reddit_copied || 'Copied');
      }).catch(function() {});
    });
  }

  var newsRewriteAuthorsList = [];
  var newsRewriteSetupDraft = { authors: [], products: [] };
  function fillNewsAuthorSelect(authors) {
    newsRewriteAuthorsList = Array.isArray(authors) ? authors : [];
    [document.getElementById('news-rewrite-author'), document.getElementById('news-post-from-text-author')].forEach(function(sel) {
      if (!sel) return;
      sel.innerHTML = '';
      if (!newsRewriteAuthorsList.length) {
        sel.appendChild(new Option(tr.reddit_add_authors_first || '— Add authors in Settings —', ''));
        return;
      }
      newsRewriteAuthorsList.forEach(function(a, i) {
        sel.appendChild(new Option(a.full_name || ((tr.reddit_author_n || 'Author {}').replace('{}', String(i + 1))), String(i)));
      });
    });
  }
  fetch('/setup/draft').then(function(r) { return r.json(); }).then(function(draft) {
    newsRewriteSetupDraft = { authors: draft.authors || [], products: draft.products || [] };
    fillNewsAuthorSelect(draft.authors);
  }).catch(function() { newsRewriteSetupDraft = { authors: [], products: [] }; fillNewsAuthorSelect([]); });

  function updateNewsCharCount() {
    var ta = document.getElementById('news-write-textarea');
    var countEl = document.getElementById('news-write-char-count');
    var lengthSelect = document.getElementById('news-rewrite-length');
    if (!ta || !countEl || !lengthSelect) return;
    var text = ta.value || '';
    var charCount = text.length;
    var length = lengthSelect.value || 'medium';
    var ranges = {
      short: { min: 600, max: 900 },
      medium: { min: 900, max: 1400 },
      long: { min: 1400, max: 2200 }
    };
    var range = ranges[length] || ranges.medium;
    var isValid = charCount >= range.min && charCount <= range.max;
    var status = isValid ? 'valid' : (charCount < range.min ? 'too-short' : 'too-long');
    countEl.textContent = charCount + ' / ' + range.min + '–' + range.max + ' ' + (tr.reddit_chars || 'chars');
    countEl.className = 'news-char-count news-char-count-' + status;
    updateNewsRewriteButtonsState();
  }
  function updateNewsRewriteButtonsState() {
    var ta = document.getElementById('news-write-textarea');
    var copyBtn = document.getElementById('news-write-copy');
    var rewriteBtn = document.getElementById('news-rewrite-btn');
    if (!ta || !copyBtn || !rewriteBtn) return;
    var text = (ta.value || '').trim();
    var hasContent = text.length > 0 && text !== (tr.reddit_generating || 'Generating…');
    if (hasContent) {
      copyBtn.classList.remove('secondary'); copyBtn.classList.add('primary');
      rewriteBtn.classList.remove('primary'); rewriteBtn.classList.add('secondary');
    } else {
      copyBtn.classList.remove('primary'); copyBtn.classList.add('secondary');
      rewriteBtn.classList.remove('secondary'); rewriteBtn.classList.add('primary');
    }
  }
  var newsRewriteBtn = document.getElementById('news-rewrite-btn');
  if (newsRewriteBtn) {
    newsRewriteBtn.addEventListener('click', function() {
      var bodyEl = document.getElementById('news-view-body');
      var ta = document.getElementById('news-write-textarea');
      var postText = bodyEl ? bodyEl.innerText || '' : '';
      postText = postText.trim();
      if (postText === (tr.news_loading_full || 'Loading full text…') || postText.length < 100) {
        if (currentNewsItem) {
          var fc = currentNewsItem.content || currentNewsItem.summary || '';
          postText = (fc + '').replace(/<[^>]+>/g, ' ').trim();
        }
      }
      if (!postText || postText.length < 50) {
        if (typeof window.toast === 'function') window.toast(tr.news_wait_article || 'Wait for the article to load or refresh the page', 'error');
        return;
      }
      var goal = document.getElementById('news-rewrite-goal').value;
      var length = document.getElementById('news-rewrite-length').value;
      var authorIndex = document.getElementById('news-rewrite-author').value;
      var author = (authorIndex !== '' && newsRewriteAuthorsList.length) ? newsRewriteAuthorsList[parseInt(authorIndex, 10)] : null;
      var payload = { news_text: postText, goal: goal, length: length };
      if (author) payload.author = { full_name: author.full_name, role: author.role || '', history: author.history || '', linkedin_url: author.linkedin_url || '' };
      if (newsRewriteSetupDraft.products && newsRewriteSetupDraft.products.length) payload.products = newsRewriteSetupDraft.products;
      newsRewriteBtn.disabled = true;
      newsRewriteBtn.textContent = (tr.reddit_generating || 'Generating…');
      if (ta) ta.value = (tr.reddit_generating || 'Generating…');
      updateNewsCharCount();
      fetch('/agents/news_post_agent/run', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ payload: payload }) })
        .then(function(r) { return r.text().then(function(t) { return { ok: r.ok, status: r.status, text: t }; }); })
        .then(function(r) {
          if (!r.ok) {
            var errMsg = r.text ? (function() { try { var j = JSON.parse(r.text); return j.detail || j.message || r.text.slice(0, 300); } catch (_) { return r.text.slice(0, 300); } }()) : (tr.news_error_server || 'Server error');
            if (ta) ta.value = (tr.news_error_server || 'Server error') + ' (' + r.status + '): ' + errMsg;
            updateNewsCharCount();
            return;
          }
          var data;
          try { data = JSON.parse(r.text); } catch (_) { if (ta) ta.value = (tr.news_error_not_json || 'Error: response is not JSON.'); updateNewsCharCount(); return; }
          var postTextResult = data.result && data.result.post ? data.result.post : '';
          if (ta) ta.value = (postTextResult || '').trim() || (tr.reddit_generate_failed || 'Failed to generate post.');
          updateNewsCharCount();
        })
        .catch(function(err) {
          if (ta) ta.value = (tr.news_error_connect || 'Failed to connect to server.') + (err && err.message ? ': ' + err.message : '');
          updateNewsCharCount();
        })
        .finally(function() {
          newsRewriteBtn.disabled = false;
          newsRewriteBtn.textContent = (tr.reddit_rewrite_btn || 'Rewrite');
        });
    });
  }
  var newsTextarea = document.getElementById('news-write-textarea');
  var newsLengthSelect = document.getElementById('news-rewrite-length');
  if (newsTextarea) {
    newsTextarea.addEventListener('input', updateNewsCharCount);
    newsTextarea.addEventListener('paste', function() { setTimeout(updateNewsCharCount, 10); });
  }
  if (newsLengthSelect) {
    newsLengthSelect.addEventListener('change', updateNewsCharCount);
  }

  /* Modal: Сделать пост по тексту */
  var postFromTextModal = document.getElementById('news-post-from-text-modal');
  var postFromTextBackdrop = document.getElementById('news-post-from-text-backdrop');
  var postFromTextClose = document.getElementById('news-post-from-text-close');
  var postFromTextInput = document.getElementById('news-post-from-text-input');
  var postFromTextResult = document.getElementById('news-post-from-text-result');
  var postFromTextGenerate = document.getElementById('news-post-from-text-generate');
  var postFromTextCopy = document.getElementById('news-post-from-text-copy');
  var postFromTextCharCount = document.getElementById('news-post-from-text-char-count');
  var postFromTextLengthSelect = document.getElementById('news-post-from-text-length');

  function openPostFromTextModal() {
    if (postFromTextModal) {
      postFromTextModal.hidden = false;
      postFromTextModal.classList.add('is-open');
      if (postFromTextInput) postFromTextInput.focus();
      updatePostFromTextButtonsState();
    }
  }
  function closePostFromTextModal() {
    if (postFromTextModal) {
      postFromTextModal.hidden = true;
      postFromTextModal.classList.remove('is-open');
    }
  }
  function updatePostFromTextCharCount() {
    if (!postFromTextResult || !postFromTextCharCount || !postFromTextLengthSelect) return;
    var text = postFromTextResult.value || '';
    var charCount = text.length;
    var length = postFromTextLengthSelect.value || 'medium';
    var ranges = { short: { min: 600, max: 900 }, medium: { min: 900, max: 1400 }, long: { min: 1400, max: 2200 } };
    var range = ranges[length] || ranges.medium;
    var isValid = charCount >= range.min && charCount <= range.max;
    var status = isValid ? 'valid' : (charCount < range.min ? 'too-short' : 'too-long');
    postFromTextCharCount.textContent = charCount + ' / ' + range.min + '–' + range.max + ' ' + (tr.reddit_chars || 'chars');
    postFromTextCharCount.className = 'news-char-count news-char-count-' + status;
    updatePostFromTextButtonsState();
  }
  function updatePostFromTextButtonsState() {
    if (!postFromTextResult || !postFromTextCopy || !postFromTextGenerate) return;
    var text = (postFromTextResult.value || '').trim();
    var hasContent = text.length > 0 && text !== (tr.reddit_generating || 'Generating…');
    if (hasContent) {
      postFromTextCopy.classList.remove('secondary'); postFromTextCopy.classList.add('primary');
      postFromTextGenerate.classList.remove('primary'); postFromTextGenerate.classList.add('secondary');
    } else {
      postFromTextCopy.classList.remove('primary'); postFromTextCopy.classList.add('secondary');
      postFromTextGenerate.classList.remove('secondary'); postFromTextGenerate.classList.add('primary');
    }
  }

  var newsMakePostBtn = document.getElementById('news-make-post-btn');
  if (newsMakePostBtn) newsMakePostBtn.addEventListener('click', openPostFromTextModal);
  if (postFromTextBackdrop) postFromTextBackdrop.addEventListener('click', closePostFromTextModal);
  if (postFromTextClose) postFromTextClose.addEventListener('click', closePostFromTextModal);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && postFromTextModal && postFromTextModal.classList.contains('is-open')) closePostFromTextModal();
  });

  if (postFromTextCopy) {
    postFromTextCopy.addEventListener('click', function() {
      var text = postFromTextResult ? postFromTextResult.value : '';
      if (!text) return;
      navigator.clipboard.writeText(text).then(function() {
        if (typeof window.toast === 'function') window.toast(tr.reddit_copied || 'Copied');
      }).catch(function() {});
    });
  }
  if (postFromTextResult) {
    postFromTextResult.addEventListener('input', updatePostFromTextCharCount);
    postFromTextResult.addEventListener('paste', function() { setTimeout(updatePostFromTextCharCount, 10); });
  }
  if (postFromTextLengthSelect) postFromTextLengthSelect.addEventListener('change', updatePostFromTextCharCount);

  if (postFromTextGenerate) {
    postFromTextGenerate.addEventListener('click', function() {
      var inputText = (postFromTextInput && postFromTextInput.value) ? postFromTextInput.value.trim() : '';
      if (!inputText || inputText.length < 50) {
        if (typeof window.toast === 'function') window.toast(tr.news_post_from_text_min || 'Вставьте текст (минимум 50 символов)', 'error');
        return;
      }
      var goal = document.getElementById('news-post-from-text-goal').value;
      var length = document.getElementById('news-post-from-text-length').value;
      var authorIndex = document.getElementById('news-post-from-text-author').value;
      var author = (authorIndex !== '' && newsRewriteAuthorsList.length) ? newsRewriteAuthorsList[parseInt(authorIndex, 10)] : null;
      var payload = { news_text: inputText, goal: goal, length: length };
      if (author) payload.author = { full_name: author.full_name, role: author.role || '', history: author.history || '', linkedin_url: author.linkedin_url || '' };
      if (newsRewriteSetupDraft.products && newsRewriteSetupDraft.products.length) payload.products = newsRewriteSetupDraft.products;
      postFromTextGenerate.disabled = true;
      postFromTextGenerate.textContent = (tr.reddit_generating || 'Generating…');
      if (postFromTextResult) postFromTextResult.value = (tr.reddit_generating || 'Generating…');
      updatePostFromTextCharCount();
      fetch('/agents/news_post_agent/run', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ payload: payload }) })
        .then(function(r) { return r.text().then(function(t) { return { ok: r.ok, status: r.status, text: t }; }); })
        .then(function(r) {
          if (!r.ok) {
            var errMsg = r.text ? (function() { try { var j = JSON.parse(r.text); return j.detail || j.message || r.text.slice(0, 300); } catch (_) { return r.text.slice(0, 300); } }()) : (tr.news_error_server || 'Server error');
            if (postFromTextResult) postFromTextResult.value = (tr.news_error_server || 'Server error') + ' (' + r.status + '): ' + errMsg;
            updatePostFromTextCharCount();
            return;
          }
          var data;
          try { data = JSON.parse(r.text); } catch (_) { if (postFromTextResult) postFromTextResult.value = (tr.news_error_not_json || 'Error: response is not JSON.'); updatePostFromTextCharCount(); return; }
          var postTextResult = data.result && data.result.post ? data.result.post : '';
          if (postFromTextResult) postFromTextResult.value = (postTextResult || '').trim() || (tr.reddit_generate_failed || 'Failed to generate post.');
          updatePostFromTextCharCount();
        })
        .catch(function(err) {
          if (postFromTextResult) postFromTextResult.value = (tr.news_error_connect || 'Failed to connect to server.') + (err && err.message ? ': ' + err.message : '');
          updatePostFromTextCharCount();
        })
        .finally(function() {
          postFromTextGenerate.disabled = false;
          postFromTextGenerate.textContent = (tr.reddit_rewrite_btn || 'Rewrite');
          updatePostFromTextButtonsState();
        });
    });
  }

  var sourceFilter = document.getElementById('news-source-filter');
  var newsScoreFilter = document.getElementById('news-score-filter');
  if (sourceFilter) sourceFilter.addEventListener('change', renderNewsList);
  if (newsScoreFilter) newsScoreFilter.addEventListener('change', renderNewsList);
  if (refreshBtn) refreshBtn.addEventListener('click', function() { loadNews(true); });  /* true = принудительное обновление с серверов */
  if (emptyRetryBtn) emptyRetryBtn.addEventListener('click', loadNews);
  if (errorRetryBtn) errorRetryBtn.addEventListener('click', loadNews);
  loadNews();
})();
</script>
{% endblock %}
