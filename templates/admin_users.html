{% extends "base.html" %}
{% block title %}{{ (tr.admin_users_title if tr and tr.admin_users_title else ('Users' if locale == 'en' else 'Пользователи')) }} — MyVOICE's{% endblock %}
{% block content %}
{% set is_en = locale == 'en' %}
<div class="admin-users-premium-shell">
<header class="admin-page-header">
  <div class="admin-page-header-text">
    <h1 class="admin-page-title">{{ (tr.admin_users_title if tr and tr.admin_users_title else ('Users' if is_en else 'Пользователи')) }}</h1>
    <p class="admin-page-desc">{{ (tr.admin_users_desc if tr and tr.admin_users_desc else ('List of all registered users' if is_en else 'Список всех зарегистрированных пользователей')) }}</p>
  </div>
  <div class="admin-page-header-actions">
    <button type="button" id="btn-add-user" class="btn primary btn-add-user" aria-label="{{ (tr.admin_add_user if tr and tr.admin_add_user else ('Add user' if is_en else 'Добавить пользователя')) }}">
      <span class="btn-add-user-icon" aria-hidden="true">+</span> {{ (tr.admin_add_user if tr and tr.admin_add_user else ('Add user' if is_en else 'Добавить пользователя')) }}
    </button>
  </div>
</header>

<div class="admin-stats">
  <div class="admin-stat-card">
    <span class="admin-stat-value">{{ total_users }}</span>
    <span class="admin-stat-label">{{ (tr.admin_total_users if tr else 'Всего пользователей') }}</span>
  </div>
  <div class="admin-stat-card">
    <span class="admin-stat-value">{{ admin_count }}</span>
    <span class="admin-stat-label">{{ (tr.admin_admins if tr else 'Администраторов') }}</span>
  </div>
  <div class="admin-stat-card">
    <span class="admin-stat-value admin-stat-value-success">{{ active_subscriptions }}</span>
    <span class="admin-stat-label">{{ (tr.admin_active_subscriptions if tr else 'Активных подписок') }}</span>
  </div>
  <div class="admin-stat-card">
    <span class="admin-stat-value admin-stat-value-warning">{{ trial_users }}</span>
    <span class="admin-stat-label">{{ (tr.admin_trial_users if tr else 'Пробных пользователей') }}</span>
  </div>
  <div class="admin-stat-card">
    <span class="admin-stat-value admin-stat-value-warning">{{ pending_users }}</span>
    <span class="admin-stat-label">{{ (tr.admin_pending_users if tr else 'Ожидают подтверждения') }}</span>
  </div>
</div>

<div class="card admin-users-card">
  <div class="data-table-wrap">
    <table class="data-table" role="table">
      <thead>
        <tr>
          <th>{{ (tr.admin_email if tr else 'Email') }}</th>
          <th>{{ (tr.admin_status if tr else 'Статус') }}</th>
          <th>{{ (tr.admin_role if tr else 'Роль') }}</th>
          <th>{{ (tr.admin_plan if tr else 'План') }}</th>
          <th>{{ (tr.admin_subscription if tr else 'Подписка') }}</th>
          <th>{{ (tr.admin_subscription_expires if tr else 'Истекает') }}</th>
          <th>{{ (tr.admin_created_at if tr else 'Зарегистрирован') }}</th>
          <th>{{ (tr.admin_last_login if tr else 'Последний вход') }}</th>
          <th class="admin-users-actions-head"></th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr data-user-id="{{ user.id }}">
          <td><strong>{{ user.email }}</strong></td>
          <td>
            {% if (user.approval_status if user is defined and user else 'approved') == 'pending' %}
            <span class="badge badge-status-pending">{{ (tr.admin_status_pending if tr else 'Ожидает') }}</span>
            {% elif (user.approval_status if user is defined and user else 'approved') == 'rejected' %}
            <span class="badge badge-danger">{{ (tr.admin_status_rejected if tr else 'Отклонён') }}</span>
            {% else %}
            <span class="badge badge-status-approved">{{ (tr.admin_status_approved if tr else 'Одобрен') }}</span>
            {% endif %}
          </td>
          <td>
            {% if user.role == 'admin' %}
            <span class="badge badge-role-admin">{{ (tr.admin_role_admin if tr else 'Админ') }}</span>
            {% else %}
            <span class="badge badge-muted">{{ (tr.admin_role_user if tr else 'Пользователь') }}</span>
            {% endif %}
          </td>
          <td>
            <span class="badge badge-muted">{{ (user.plan_name or 'starter') }}</span>
          </td>
          <td>
            {% if user.subscription_status == 'active' %}
            <span class="badge badge-sub-active">{{ (tr.admin_subscription_active if tr else 'Активна') }}</span>
            {% elif user.subscription_status == 'trial' %}
            <span class="badge badge-sub-trial">{{ (tr.admin_subscription_trial if tr else 'Пробная') }}</span>
            {% elif user.subscription_status == 'expired' %}
            <span class="badge badge-danger">{{ (tr.admin_subscription_expired if tr else 'Истекла') }}</span>
            {% elif user.subscription_status == 'cancelled' %}
            <span class="badge badge-muted">{{ (tr.admin_subscription_cancelled if tr else 'Отменена') }}</span>
            {% else %}
            <span class="badge badge-muted">{{ (tr.admin_subscription_free if tr else 'Бесплатная') }}</span>
            {% endif %}
          </td>
          <td>
            {% if user.subscription_expires_at %}
            {{ user.subscription_expires_at.strftime('%d.%m.%Y') if user.subscription_expires_at else '—' }}
            {% else %}
            —
            {% endif %}
          </td>
          <td>{{ user.created_at.strftime('%d.%m.%Y %H:%M') if user.created_at else '—' }}</td>
          <td>{{ user.last_login_at.strftime('%d.%m.%Y %H:%M') if user.last_login_at else '—' }}</td>
          <td class="admin-users-actions-cell">
            <div class="admin-user-menu-wrap">
              <button type="button" class="btn btn-ghost btn-sm btn-card-menu btn-icon admin-user-menu-btn" data-user-id="{{ user.id }}" aria-label="{{ (tr.admin_more_actions if tr else 'Ещё') }}" aria-haspopup="true" aria-expanded="false">
                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16" aria-hidden="true"><circle cx="12" cy="6" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="18" r="1.5"/></svg>
              </button>
              <div class="admin-user-menu-dropdown" role="menu">
                {% if (user.approval_status if user is defined and user else 'approved') == 'pending' %}
                <button type="button" role="menuitem" class="admin-user-menu-item btn-approve-user" data-user-id="{{ user.id }}">{{ (tr.admin_approve_user if tr else 'Одобрить') }}</button>
                <button type="button" role="menuitem" class="admin-user-menu-item btn-reject-user danger" data-user-id="{{ user.id }}">{{ (tr.admin_reject_user if tr else 'Отклонить') }}</button>
                {% endif %}
                <button type="button" role="menuitem" class="admin-user-menu-item btn-edit-user" data-user-id="{{ user.id }}">{{ (tr.admin_edit_user if tr else 'Редактировать') }}</button>
                <button type="button" role="menuitem" class="admin-user-menu-item btn-delete-user danger" data-user-id="{{ user.id }}">{{ (tr.admin_delete_user if tr else 'Удалить') }}</button>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% if not users %}
        <tr>
          <td colspan="9" class="admin-users-empty-cell">
            {{ (tr.admin_no_users if tr else 'Пользователей пока нет') }}
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
</div>

<!-- Модальное окно добавления пользователя -->
<div id="add-user-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="add-user-modal-title" hidden>
  <div class="modal-backdrop" aria-hidden="true"></div>
  <div class="modal-content card confirm-modal-content admin-user-modal-content">
    <h2 id="add-user-modal-title" class="confirm-modal-title">{{ (tr.admin_add_user if tr else 'Добавить пользователя') }}</h2>
    <form id="add-user-form" class="admin-user-form">
      <div style="margin-bottom: var(--space-4);">
        <label for="add-user-email" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.login_email if tr else 'Email') }} <span style="color: var(--error);">*</span>
        </label>
        <input type="email" id="add-user-email" name="email" required autocomplete="email" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);" placeholder="user@example.com">
      </div>
      <div style="margin-bottom: var(--space-4);">
        <label for="add-user-password" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.login_password if tr else 'Пароль') }} <span style="color: var(--error);">*</span>
        </label>
        <input type="password" id="add-user-password" name="password" required autocomplete="new-password" minlength="6" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);" placeholder="{{ (tr.admin_password_placeholder if tr else 'Минимум 6 символов') }}">
      </div>
      <div style="margin-bottom: var(--space-4);">
        <label for="add-user-role" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.admin_role if tr else 'Роль') }}
        </label>
        <select id="add-user-role" name="role" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);">
          <option value="user">{{ (tr.admin_role_user if tr else 'Пользователь') }}</option>
          <option value="admin">{{ (tr.admin_role_admin if tr else 'Админ') }}</option>
        </select>
      </div>
      <div style="margin-bottom: var(--space-4);">
        <label for="add-user-plan" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.admin_plan if tr else 'План') }}
        </label>
        <select id="add-user-plan" name="plan_name" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);">
          {% for plan_key in plans %}
          <option value="{{ plan_key }}">{{ plan_key|title }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="margin-bottom: var(--space-4);">
        <label for="add-user-subscription" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.admin_subscription if tr else 'Подписка') }}
        </label>
        <select id="add-user-subscription" name="subscription_status" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);">
          <option value="free">{{ (tr.admin_subscription_free if tr else 'Бесплатная') }}</option>
          <option value="trial">{{ (tr.admin_subscription_trial if tr else 'Пробная') }}</option>
          <option value="active">{{ (tr.admin_subscription_active if tr else 'Активна') }}</option>
          <option value="expired">{{ (tr.admin_subscription_expired if tr else 'Истекла') }}</option>
          <option value="cancelled">{{ (tr.admin_subscription_cancelled if tr else 'Отменена') }}</option>
        </select>
      </div>
      <div id="add-user-error" style="display: none; font-size: var(--text-14); color: var(--error); margin-bottom: var(--space-4); padding: var(--space-2); background: var(--danger-soft, #fee2e2); border-radius: var(--radius-sm);"></div>
      <div class="modal-actions">
        <button type="button" id="add-user-cancel" class="btn secondary">{{ (tr.admin_cancel if tr else 'Отмена') }}</button>
        <button type="submit" id="add-user-submit" class="btn primary">{{ (tr.admin_add_user if tr else 'Добавить пользователя') }}</button>
      </div>
    </form>
  </div>
</div>

<!-- Модальное окно редактирования пользователя -->
<div id="edit-user-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-user-modal-title" hidden>
  <div class="modal-backdrop" aria-hidden="true"></div>
  <div class="modal-content card confirm-modal-content admin-user-modal-content">
    <h2 id="edit-user-modal-title" class="confirm-modal-title">{{ (tr.admin_edit_user if tr else 'Редактировать пользователя') }}</h2>
    <form id="edit-user-form" class="admin-user-form">
      <input type="hidden" id="edit-user-id" name="id">
      <div style="margin-bottom: var(--space-4);">
        <label for="edit-user-email" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.login_email if tr else 'Email') }} <span style="color: var(--error);">*</span>
        </label>
        <input type="email" id="edit-user-email" name="email" required autocomplete="email" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);" placeholder="user@example.com">
      </div>
      <div style="margin-bottom: var(--space-4);">
        <label for="edit-user-password" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.login_password if tr else 'Пароль') }} <span style="font-size: var(--text-12); color: var(--text-muted); font-weight: 400;">({{ (tr.admin_password_optional if tr else 'оставьте пустым, чтобы не менять') }})</span>
        </label>
        <input type="password" id="edit-user-password" name="password" autocomplete="new-password" minlength="6" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);" placeholder="{{ (tr.admin_password_placeholder if tr else 'Минимум 6 символов') }}">
      </div>
      <div style="margin-bottom: var(--space-4);">
        <label for="edit-user-role" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.admin_role if tr else 'Роль') }}
        </label>
        <select id="edit-user-role" name="role" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);">
          <option value="user">{{ (tr.admin_role_user if tr else 'Пользователь') }}</option>
          <option value="admin">{{ (tr.admin_role_admin if tr else 'Админ') }}</option>
        </select>
      </div>
      <div style="margin-bottom: var(--space-4);">
        <label for="edit-user-plan" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.admin_plan if tr else 'План') }}
        </label>
        <select id="edit-user-plan" name="plan_name" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);">
          {% for plan_key in plans %}
          <option value="{{ plan_key }}">{{ plan_key|title }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="margin-bottom: var(--space-4);">
        <label for="edit-user-subscription" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.admin_subscription if tr else 'Подписка') }}
        </label>
        <select id="edit-user-subscription" name="subscription_status" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);">
          <option value="free">{{ (tr.admin_subscription_free if tr else 'Бесплатная') }}</option>
          <option value="trial">{{ (tr.admin_subscription_trial if tr else 'Пробная') }}</option>
          <option value="active">{{ (tr.admin_subscription_active if tr else 'Активна') }}</option>
          <option value="expired">{{ (tr.admin_subscription_expired if tr else 'Истекла') }}</option>
          <option value="cancelled">{{ (tr.admin_subscription_cancelled if tr else 'Отменена') }}</option>
        </select>
      </div>
      <div style="margin-bottom: var(--space-4);">
        <label for="edit-user-expires" style="display: block; font-size: var(--text-14); font-weight: 500; margin-bottom: var(--space-2); color: var(--text);">
          {{ (tr.admin_subscription_expires if tr else 'Истекает') }}
        </label>
        <input type="date" id="edit-user-expires" name="subscription_expires_at" style="width: 100%; padding: 0.6rem 0.75rem; font-size: var(--text-16); border: 1px solid var(--border); border-radius: var(--radius);" placeholder="YYYY-MM-DD">
      </div>
      <div id="edit-user-error" style="display: none; font-size: var(--text-14); color: var(--error); margin-bottom: var(--space-4); padding: var(--space-2); background: var(--danger-soft, #fee2e2); border-radius: var(--radius-sm);"></div>
      <div class="modal-actions">
        <button type="button" id="edit-user-cancel" class="btn secondary">{{ (tr.admin_cancel if tr else 'Отмена') }}</button>
        <button type="submit" id="edit-user-submit" class="btn primary">{{ (tr.admin_save if tr else 'Сохранить') }}</button>
      </div>
    </form>
  </div>
</div>

<!-- Подтверждение удаления -->
<div id="delete-user-modal" class="modal confirm-modal" role="alertdialog" aria-modal="true" aria-labelledby="delete-user-modal-title" hidden>
  <div class="modal-backdrop" aria-hidden="true"></div>
  <div class="modal-content card confirm-modal-content admin-user-modal-content admin-user-delete-modal-content">
    <h2 id="delete-user-modal-title" class="confirm-modal-title">{{ (tr.admin_delete_user_confirm_title if tr else 'Удалить пользователя?') }}</h2>
    <p id="delete-user-modal-desc" class="confirm-modal-desc">{{ (tr.admin_delete_user_confirm_desc if tr else 'Это действие нельзя отменить.') }}</p>
    <div class="modal-actions">
      <button type="button" id="delete-user-cancel" class="btn secondary">{{ (tr.admin_cancel if tr else 'Отмена') }}</button>
      <button type="button" id="delete-user-ok" class="btn btn-danger">{{ (tr.companies_delete if tr else 'Удалить') }}</button>
    </div>
  </div>
</div>

<style>
  .main-wrap { padding: 32px !important; }
  .admin-users-premium-shell { max-width: 1160px; margin: 0 auto; width: 100%; }
  .admin-page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 24px;
  }
  .admin-page-header-text { min-width: 0; }
  .admin-page-title {
    margin: 0 0 8px;
    font-size: 28px;
    line-height: 32px;
    font-weight: 700;
    color: #111827;
  }
  .admin-page-desc {
    margin: 0;
    max-width: 760px;
    font-size: 14px;
    line-height: 20px;
    color: #4b5563;
  }
  .admin-page-header-actions { display: flex; gap: 12px; flex-wrap: wrap; flex-shrink: 0; }
  .btn-add-user {
    height: 40px;
    border-radius: 12px;
    padding: 0 16px;
    margin: 0;
    line-height: 38px;
    font-size: 14px;
    font-weight: 600;
    border: 1px solid #4f46e5;
    background: #4f46e5;
    box-shadow: none;
    transition: background 200ms ease-out, border-color 200ms ease-out, transform 120ms ease-out;
  }
  .btn-add-user:hover { background: #4338ca; border-color: #4338ca; }
  .btn-add-user:active { transform: scale(0.98); }
  .btn-add-user-icon { font-size: 18px; line-height: 1; margin-right: 8px; }

  .admin-stats {
    display: grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }
  .admin-stat-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    padding: 20px;
    min-height: 106px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: border-color 200ms ease-out, box-shadow 200ms ease-out, transform 200ms ease-out;
  }
  .admin-stat-card:hover {
    border-color: #cbd5e1;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.04);
    transform: translateY(-1px);
  }
  .admin-stat-value {
    font-size: 30px;
    line-height: 1.1;
    font-weight: 700;
    letter-spacing: -0.03em;
    color: #111827;
  }
  .admin-stat-value-success { color: #0f766e; }
  .admin-stat-value-warning { color: #b45309; }
  .admin-stat-label {
    margin-top: 8px;
    font-size: 13px;
    line-height: 18px;
    font-weight: 500;
    color: #6b7280;
  }

  .admin-users-card {
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    background: #ffffff;
    padding: 0;
    box-shadow: none;
    overflow: hidden;
  }
  .admin-users-card .data-table-wrap { width: 100%; overflow-x: auto; }
  .admin-users-card .data-table {
    width: 100%;
    min-width: 1040px;
    border-collapse: separate;
    border-spacing: 0;
    table-layout: fixed;
  }
  .admin-users-card .data-table thead th {
    background: #f8fafc;
    color: #6b7280;
    font-size: 11px;
    line-height: 16px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 500;
    border-bottom: 1px solid #e5e7eb;
    padding: 12px 16px;
    white-space: nowrap;
  }
  .admin-users-card .data-table td {
    border-bottom: 1px solid #eef2f7;
    color: #111827;
    font-size: 13px;
    line-height: 18px;
    padding: 14px 16px;
    vertical-align: middle;
    overflow-wrap: anywhere;
  }
  .admin-users-card .data-table tbody tr:last-child td { border-bottom: none; }
  .admin-users-card .data-table tbody tr:hover td { background: #fafcff; }
  .admin-users-actions-head { width: 56px; text-align: right; }
  .admin-users-actions-cell { text-align: right; }
  .admin-users-empty-cell {
    text-align: center;
    padding: 32px !important;
    color: #6b7280 !important;
    background: #ffffff;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid transparent;
    font-size: 12px;
    line-height: 16px;
    font-weight: 500;
  }
  .badge-status-pending { background: #fffbeb; color: #b45309; border-color: #fde68a; }
  .badge-status-approved { background: #ecfdf5; color: #0f766e; border-color: #a7f3d0; }
  .badge-role-admin { background: #eef2ff; color: #4338ca; border-color: #c7d2fe; }
  .badge-sub-active { background: #ecfdf5; color: #0f766e; border-color: #a7f3d0; }
  .badge-sub-trial { background: #fffbeb; color: #b45309; border-color: #fde68a; }
  .badge-danger { background: #fef2f2; color: #b91c1c; border-color: #fecaca; }
  .badge-muted { background: #f8fafc; color: #6b7280; border-color: #e2e8f0; }

  .admin-user-menu-wrap { position: relative; display: inline-block; z-index: 1; }
  .admin-user-menu-wrap.is-open { z-index: 50; }
  .admin-user-menu-wrap .btn-card-menu {
    width: 40px;
    min-width: 40px;
    height: 40px;
    min-height: 40px;
    margin: 0;
    border: 1px solid #d1d5db;
    border-radius: 12px;
    background: #ffffff;
    color: #6b7280;
    box-shadow: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .admin-user-menu-wrap .btn-card-menu:hover {
    background: #f9fafb;
    border-color: #cbd5e1;
    color: #374151;
  }
  .admin-user-menu-wrap .btn-card-menu:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.18);
  }
  .admin-user-menu-dropdown {
    position: fixed;
    top: 0;
    left: 0;
    min-width: 180px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    padding: 6px;
    z-index: 1200;
    display: none;
    transform-origin: top right;
  }
  .admin-user-menu-wrap.is-open .admin-user-menu-dropdown { display: block; }
  .admin-user-menu-item {
    display: block;
    width: 100%;
    padding: 8px 10px;
    text-align: left;
    font-size: 13px;
    line-height: 18px;
    color: #111827;
    background: none;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-family: inherit;
  }
  .admin-user-menu-item:hover { background: #f9fafb; }
  .admin-user-menu-item.danger { color: #b91c1c; }
  .admin-user-menu-item.danger:hover { background: #fef2f2; }

  .admin-user-modal-content {
    max-width: 520px !important;
    width: 100%;
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 24px 64px rgba(15, 23, 42, 0.18);
    padding: 24px;
  }
  .admin-user-delete-modal-content { max-width: 420px !important; }
  .admin-user-form > div[style] { margin-bottom: 16px !important; }
  .admin-user-form label[style] {
    margin-bottom: 6px !important;
    color: #111827 !important;
    font-size: 13px !important;
    line-height: 18px !important;
    font-weight: 500 !important;
  }
  .admin-user-form input[style],
  .admin-user-form select[style] {
    width: 100% !important;
    height: 40px !important;
    padding: 0 12px !important;
    margin-bottom: 0 !important;
    border: 1px solid #d1d5db !important;
    border-radius: 12px !important;
    background: #ffffff !important;
    color: #111827 !important;
    box-shadow: none !important;
    font-size: 14px !important;
  }
  .admin-user-form input[style]:focus,
  .admin-user-form select[style]:focus {
    outline: none !important;
    border-color: #4f46e5 !important;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.18) !important;
  }
  #add-user-error,
  #edit-user-error {
    border: 1px solid #fecaca !important;
    border-radius: 12px !important;
    background: #fef2f2 !important;
    color: #b91c1c !important;
    font-size: 13px !important;
    line-height: 18px !important;
    padding: 8px 10px !important;
  }
  .modal-actions { margin-top: 20px; gap: 8px; }
  .modal-actions .btn {
    height: 40px;
    border-radius: 12px;
    margin: 0;
    line-height: 38px;
    font-size: 14px;
    font-weight: 600;
    padding: 0 16px;
    box-shadow: none;
    transition: background 200ms ease-out, border-color 200ms ease-out, transform 120ms ease-out;
  }
  .modal-actions .btn:active { transform: scale(0.98); }
  .modal-actions .btn.secondary {
    border: 1px solid #d1d5db;
    background: #ffffff;
    color: #111827;
  }
  .modal-actions .btn.secondary:hover { background: #f9fafb; border-color: #cbd5e1; }
  .modal-actions .btn.primary {
    border: 1px solid #4f46e5;
    background: #4f46e5;
    color: #ffffff;
  }
  .modal-actions .btn.primary:hover { background: #4338ca; border-color: #4338ca; }
  .btn.btn-danger { border: 1px solid #dc2626; background: #dc2626; color: #ffffff; }
  .btn.btn-danger:hover { background: #b91c1c; border-color: #b91c1c; }
  .confirm-modal-desc {
    margin: 0 0 16px;
    font-size: 14px;
    line-height: 20px;
    color: #4b5563;
  }

  @media (max-width: 1180px) {
    .admin-stats { grid-template-columns: repeat(3, minmax(0, 1fr)); }
  }
  @media (max-width: 980px) {
    .main-wrap { padding: 24px !important; }
    .admin-stats { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 768px) {
    .main-wrap { padding: 16px !important; }
    .admin-page-header { flex-direction: column; align-items: stretch; }
    .admin-page-title { font-size: 24px; line-height: 30px; }
    .admin-stats { grid-template-columns: 1fr; }
    .btn-add-user { width: 100%; }
    .modal-actions .btn { width: 100%; }
  }
</style>

<script>
(function() {
  const tr = window.__tr || {};
  const addUserBtn = document.getElementById('btn-add-user');
  const addUserModal = document.getElementById('add-user-modal');
  const addUserForm = document.getElementById('add-user-form');
  const addUserCancel = document.getElementById('add-user-cancel');
  const addUserError = document.getElementById('add-user-error');
  const modalBackdrop = addUserModal.querySelector('.modal-backdrop');

  function openAddUserModal() {
    addUserModal.hidden = false;
    addUserModal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    document.getElementById('add-user-email').focus();
  }

  function closeAddUserModal() {
    addUserModal.hidden = true;
    addUserModal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    addUserForm.reset();
    addUserError.style.display = 'none';
    addUserError.textContent = '';
  }

  if (addUserBtn) {
    addUserBtn.addEventListener('click', openAddUserModal);
  }
  if (addUserCancel) {
    addUserCancel.addEventListener('click', closeAddUserModal);
  }
  if (modalBackdrop) {
    modalBackdrop.addEventListener('click', closeAddUserModal);
  }

  addUserModal.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !addUserModal.hidden) {
      closeAddUserModal();
    }
  });

  if (addUserForm) {
    addUserForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      addUserError.style.display = 'none';
      addUserError.textContent = '';

      const email = document.getElementById('add-user-email').value.trim();
      const password = document.getElementById('add-user-password').value;
      const role = document.getElementById('add-user-role').value;
      const plan_name = document.getElementById('add-user-plan').value;
      const subscription_status = document.getElementById('add-user-subscription').value;

      if (!email || !password) {
        addUserError.textContent = tr.admin_error_required || 'Заполните все обязательные поля';
        addUserError.style.display = 'block';
        return;
      }

      if (password.length < 6) {
        addUserError.textContent = tr.register_error_short_password || 'Пароль должен быть не менее 6 символов';
        addUserError.style.display = 'block';
        return;
      }

      const submitBtn = document.getElementById('add-user-submit');
      submitBtn.disabled = true;
      submitBtn.textContent = tr.admin_adding || 'Добавление...';

      try {
        const response = await fetch('/admin/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, role, plan_name, subscription_status })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.detail || data.error || 'Ошибка создания пользователя');
        }

        if (typeof window.toast === 'function') {
          window.toast(tr.admin_user_added || 'Пользователь добавлен', 'success');
        }
        closeAddUserModal();
        window.location.reload();
      } catch (err) {
        addUserError.textContent = err.message || (tr.admin_error_create || 'Не удалось создать пользователя');
        addUserError.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = tr.admin_add_user || 'Добавить пользователя';
      }
    });
  }

  // Сохраняем данные пользователей для редактирования
  const usersData = {{ users_serialized|tojson|safe }};

  function toIsoDate(d) {
    if (!d) return '';
    try {
      const dt = typeof d === 'string' ? new Date(d) : d;
      return dt.toISOString ? dt.toISOString().slice(0, 10) : '';
    } catch (_) { return ''; }
  }

  // Три точки: открытие/закрытие меню
  function closeAllUserMenus() {
    document.querySelectorAll('.admin-user-menu-wrap.is-open').forEach(function(w) {
      w.classList.remove('is-open');
      const b = w.querySelector('.admin-user-menu-btn');
      if (b) b.setAttribute('aria-expanded', 'false');
    });
  }

  function positionUserMenu(wrap, btn) {
    const menu = wrap && wrap.querySelector('.admin-user-menu-dropdown');
    if (!menu || !btn) return;
    menu.style.display = 'block';
    menu.style.visibility = 'hidden';
    menu.style.left = '0px';
    menu.style.top = '0px';

    const menuRect = menu.getBoundingClientRect();
    const btnRect = btn.getBoundingClientRect();
    const gap = 8;
    const viewportPad = 8;

    let top = btnRect.top - menuRect.height - gap;
    if (top < viewportPad) top = btnRect.bottom + gap;
    if (top + menuRect.height > window.innerHeight - viewportPad) {
      top = Math.max(viewportPad, window.innerHeight - menuRect.height - viewportPad);
    }

    let left = btnRect.right - menuRect.width;
    if (left < viewportPad) left = viewportPad;
    if (left + menuRect.width > window.innerWidth - viewportPad) {
      left = Math.max(viewportPad, window.innerWidth - menuRect.width - viewportPad);
    }

    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
    menu.style.visibility = '';
    menu.style.display = '';
  }

  document.querySelectorAll('.admin-user-menu-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const wrap = btn.closest('.admin-user-menu-wrap');
      const isOpen = wrap && wrap.classList.contains('is-open');
      closeAllUserMenus();
      if (wrap && !isOpen) {
        positionUserMenu(wrap, btn);
        wrap.classList.add('is-open');
        btn.setAttribute('aria-expanded', 'true');
      } else if (btn) {
        btn.setAttribute('aria-expanded', 'false');
      }
    });
  });
  document.addEventListener('click', closeAllUserMenus);
  window.addEventListener('resize', closeAllUserMenus);
  window.addEventListener('scroll', closeAllUserMenus, true);

  // Редактировать
  const editUserModal = document.getElementById('edit-user-modal');
  const editUserForm = document.getElementById('edit-user-form');
  const editUserCancel = document.getElementById('edit-user-cancel');
  const editUserError = document.getElementById('edit-user-error');
  const editModalBackdrop = editUserModal && editUserModal.querySelector('.modal-backdrop');

  function openEditUserModal(userId) {
    const u = usersData.find(function(x) { return x.id === userId; });
    if (!u) return;
    document.getElementById('edit-user-id').value = u.id;
    document.getElementById('edit-user-email').value = u.email || '';
    document.getElementById('edit-user-password').value = '';
    document.getElementById('edit-user-role').value = u.role || 'user';
    document.getElementById('edit-user-plan').value = u.plan_name || 'starter';
    document.getElementById('edit-user-subscription').value = u.subscription_status || 'free';
    document.getElementById('edit-user-expires').value = toIsoDate(u.subscription_expires_at);
    editUserError.style.display = 'none';
    editUserError.textContent = '';
    editUserModal.hidden = false;
    editUserModal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    document.getElementById('edit-user-email').focus();
  }

  function closeEditUserModal() {
    editUserModal.hidden = true;
    editUserModal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  document.querySelectorAll('.btn-edit-user').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeAllUserMenus();
      openEditUserModal(parseInt(btn.dataset.userId, 10));
    });
  });

  if (editUserCancel) editUserCancel.addEventListener('click', closeEditUserModal);
  if (editModalBackdrop) editModalBackdrop.addEventListener('click', closeEditUserModal);
  editUserModal.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !editUserModal.hidden) closeEditUserModal();
  });

  if (editUserForm) {
    editUserForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      editUserError.style.display = 'none';
      editUserError.textContent = '';
      const userId = parseInt(document.getElementById('edit-user-id').value, 10);
      const email = document.getElementById('edit-user-email').value.trim();
      const password = document.getElementById('edit-user-password').value;
      const role = document.getElementById('edit-user-role').value;
      const plan_name = document.getElementById('edit-user-plan').value;
      const subscription_status = document.getElementById('edit-user-subscription').value;
      const subscription_expires_at = document.getElementById('edit-user-expires').value;
      if (!email || email.indexOf('@') === -1) {
        editUserError.textContent = tr.admin_error_required || 'Заполните email';
        editUserError.style.display = 'block';
        return;
      }
      if (password && password.length < 6) {
        editUserError.textContent = tr.register_error_short_password || 'Пароль не менее 6 символов';
        editUserError.style.display = 'block';
        return;
      }
      const submitBtn = document.getElementById('edit-user-submit');
      submitBtn.disabled = true;
      submitBtn.textContent = tr.admin_saving || 'Сохранение...';
      try {
        const body = { email, role, plan_name, subscription_status };
        if (password) body.password = password;
        body.subscription_expires_at = subscription_expires_at || '';
        const res = await fetch('/admin/users/' + userId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json().catch(function() { return {}; });
        if (!res.ok) throw new Error(data.detail || data.error || 'Ошибка');
        if (typeof window.toast === 'function') window.toast(tr.admin_user_updated || 'Пользователь обновлён', 'success');
        closeEditUserModal();
        window.location.reload();
      } catch (err) {
        editUserError.textContent = err.message || (tr.admin_error_update || 'Не удалось обновить');
        editUserError.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = tr.admin_save || 'Сохранить';
      }
    });
  }

  // Удалить
  const deleteUserModal = document.getElementById('delete-user-modal');
  const deleteUserCancel = document.getElementById('delete-user-cancel');
  const deleteUserOk = document.getElementById('delete-user-ok');
  const deleteModalBackdrop = deleteUserModal && deleteUserModal.querySelector('.modal-backdrop');
  let deleteUserId = null;

  function openDeleteUserModal(userId) {
    deleteUserId = userId;
    const u = usersData.find(function(x) { return x.id === userId; });
    const desc = document.getElementById('delete-user-modal-desc');
    if (desc && u) desc.textContent = (tr.admin_delete_user_confirm_desc || 'Пользователь') + ' ' + (u.email || '') + ' ' + (tr.admin_will_be_deleted || 'будет удалён. Это действие нельзя отменить.');
    if (desc && !u) desc.textContent = tr.admin_delete_user_confirm_desc || 'Это действие нельзя отменить.';
    deleteUserModal.hidden = false;
    deleteUserModal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    deleteUserOk.focus();
  }

  function closeDeleteUserModal() {
    deleteUserModal.hidden = true;
    deleteUserModal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    deleteUserId = null;
  }

  document.querySelectorAll('.btn-delete-user').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeAllUserMenus();
      openDeleteUserModal(parseInt(btn.dataset.userId, 10));
    });
  });

  // Одобрить / Отклонить
  async function approveOrReject(userId, action) {
    const url = action === 'approve' ? '/admin/users/' + userId + '/approve' : '/admin/users/' + userId + '/reject';
    try {
      const res = await fetch(url, { method: 'POST' });
      const data = await res.json().catch(function() { return {}; });
      if (!res.ok) throw new Error(data.detail || data.error || 'Ошибка');
      const msg = action === 'approve' ? (tr.admin_user_approved || 'Пользователь одобрен') : (tr.admin_user_rejected || 'Регистрация отклонена');
      if (typeof window.toast === 'function') window.toast(msg, 'success');
      window.location.reload();
    } catch (err) {
      if (typeof window.toast === 'function') window.toast(err.message || 'Ошибка', 'error');
    }
  }
  document.querySelectorAll('.btn-approve-user').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeAllUserMenus();
      approveOrReject(parseInt(btn.dataset.userId, 10), 'approve');
    });
  });
  document.querySelectorAll('.btn-reject-user').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeAllUserMenus();
      approveOrReject(parseInt(btn.dataset.userId, 10), 'reject');
    });
  });

  if (deleteUserCancel) deleteUserCancel.addEventListener('click', closeDeleteUserModal);
  if (deleteModalBackdrop) deleteModalBackdrop.addEventListener('click', closeDeleteUserModal);
  deleteUserModal.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !deleteUserModal.hidden) closeDeleteUserModal();
  });

  if (deleteUserOk) {
    deleteUserOk.addEventListener('click', async function() {
      if (deleteUserId == null) return;
      const id = deleteUserId;
      closeDeleteUserModal();
      try {
        const res = await fetch('/admin/users/' + id, { method: 'DELETE' });
        const data = await res.json().catch(function() { return {}; });
        if (!res.ok) throw new Error(data.detail || data.error || 'Ошибка');
        if (typeof window.toast === 'function') window.toast(tr.admin_user_deleted || 'Пользователь удалён', 'success');
        window.location.reload();
      } catch (err) {
        if (typeof window.toast === 'function') window.toast(err.message || (tr.admin_error_delete || 'Не удалось удалить'), 'error');
      }
    });
  }
})();
</script>
{% endblock %}
