{% extends "base.html" %}
{% block title %}{{ tr.people_title }} — MyVOICE's{% endblock %}
{% block content %}
<header class="page-header">
  <div class="page-header-text">
    <h1>{{ tr.people_title }}</h1>
    <p class="page-header-desc">{{ tr.people_lead }}</p>
  </div>
  <div class="page-header-actions">
    <button type="button" id="btn-toggle-add" class="btn primary btn-add-contact" aria-expanded="false" aria-label="{{ tr.people_add_contact }}" title="{{ tr.people_add_contact }}">
      <span class="btn-add-icon" aria-hidden="true">+</span> {{ tr.people_add_contact }}
    </button>
  </div>
</header>
<div class="card people-card">
  <h2 class="section-title">{{ tr.people_list_title }}</h2>
  <div class="people-toolbar">
    <div class="people-search-wrap">
      <input type="text" id="people-search" class="people-search-input" placeholder="{{ tr.people_search_placeholder }}" autocomplete="off" aria-label="{{ tr.people_search_label }}">
      <button type="button" id="people-search-clear" class="btn-icon people-search-clear" title="{{ tr.companies_clear_search }}" aria-label="{{ tr.companies_clear_search }}" style="display: none;">×</button>
    </div>
    <label class="people-kol-toggle">
      <input type="checkbox" id="people-kol-only" aria-label="{{ tr.people_kol_only }}">
      <span>{{ tr.people_kol_only }}</span>
    </label>
  </div>
  <div id="people-loading" class="loading-skeleton-inline" style="display: none;" aria-live="polite">
    <div class="skeleton-line"></div>
    <div class="skeleton-line"></div>
    <div class="skeleton-line"></div>
  </div>
  <div id="people-list-wrap" class="people-list-wrap" style="display: none;"></div>
  <div id="people-empty" class="empty-state-card" style="display: none;">
    <p class="empty-state-title">{{ tr.people_empty_title }}</p>
    <p class="empty-state-desc">{{ tr.people_empty_desc }}</p>
    <button type="button" id="people-empty-cta" class="btn primary">{{ tr.people_add_contact }}</button>
  </div>
  <div id="people-search-empty" class="empty-state-card" style="display: none;">
    <p class="empty-state-title">{{ tr.people_no_results }}</p>
    <p class="empty-state-desc">{{ tr.people_no_results_desc }}</p>
    <button type="button" id="people-reset-filters" class="btn secondary">{{ tr.people_reset_filters }}</button>
  </div>
  <div id="people-error" class="error-state-card" style="display: none;">
    <p class="error-state-text">{{ tr.people_error_title }}</p>
    <button type="button" id="people-error-retry" class="btn primary">{{ tr.posts_retry }}</button>
  </div>
</div>

<!-- Contact details drawer (right panel) -->
<div id="contact-drawer" class="contact-drawer" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="contact-drawer-title">
  <div class="contact-drawer-backdrop" id="contact-drawer-backdrop"></div>
  <div class="contact-drawer-panel card">
    <div class="contact-drawer-header">
      <h2 id="contact-drawer-title" class="contact-drawer-name"></h2>
      <span id="contact-drawer-company" class="contact-drawer-company"></span>
      <span id="contact-drawer-kol-badge" class="badge contact-drawer-kol" style="display: none;">KOL</span>
      <div class="contact-drawer-actions">
        <a id="contact-drawer-linkedin" href="#" target="_blank" rel="noopener" class="btn secondary contact-drawer-btn-linkedin" style="display: none;" aria-label="{{ tr.people_open_linkedin }}">{{ tr.people_open_linkedin }}</a>
        <button type="button" id="contact-drawer-edit" class="btn secondary" aria-label="{{ tr.person_form_edit }}">{{ tr.setup_edit }}</button>
        <div class="contact-drawer-kebab-wrap">
          <button type="button" id="contact-drawer-kebab" class="btn-icon kebab-trigger" aria-label="{{ tr.people_actions }}" aria-expanded="false" aria-haspopup="true" title="{{ tr.people_actions }}">…</button>
          <div id="contact-drawer-kebab-menu" class="kebab-menu" role="menu" hidden>
            <button type="button" class="kebab-item btn-contact-drawer-delete danger" role="menuitem">{{ tr.companies_delete }}</button>
          </div>
        </div>
      </div>
      <button type="button" id="contact-drawer-close" class="contact-drawer-close btn-icon" title="{{ tr.common_close_esc }}" aria-label="{{ tr.people_close_drawer }}">×</button>
    </div>
    <div class="contact-drawer-body">
      <section class="contact-drawer-section" aria-labelledby="contact-overview-heading">
        <h3 id="contact-overview-heading" class="contact-drawer-section-title">{{ tr.people_overview }}</h3>
        <dl class="contact-drawer-dl">
          <dt>{{ tr.people_role }}</dt><dd id="contact-drawer-title-val"></dd>
          <dt>{{ tr.people_company }}</dt><dd id="contact-drawer-company-val"></dd>
          <dt>LinkedIn</dt><dd id="contact-drawer-linkedin-val"></dd>
          <dt>{{ tr.people_thought_leader }}</dt><dd id="contact-drawer-kol-val"></dd>
        </dl>
      </section>
      <section class="contact-drawer-section" aria-labelledby="contact-notes-heading">
        <h3 id="contact-notes-heading" class="contact-drawer-section-title">{{ tr.people_notes }}</h3>
        <textarea id="contact-drawer-notes" class="contact-drawer-notes" rows="4" placeholder="{{ tr.people_notes_placeholder }}" aria-label="{{ tr.people_notes }}"></textarea>
        <button type="button" id="contact-drawer-notes-save" class="btn secondary btn-sm" style="margin-top: var(--space-2);">{{ tr.people_save_notes }}</button>
      </section>
      <section class="contact-drawer-section" aria-labelledby="contact-posts-heading">
        <h3 id="contact-posts-heading" class="contact-drawer-section-title">{{ tr.companies_posts }}</h3>
        <p id="contact-drawer-posts-empty" class="contact-drawer-posts-empty">{{ tr.companies_posts_desc_before }}<a href="/ui/posts">{{ tr.comments_page }}</a>{{ tr.companies_posts_desc_after }}</p>
      </section>
    </div>
  </div>
</div>

<!-- Add/Edit contact form drawer -->
<div id="person-form-drawer" class="contact-drawer person-form-drawer" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="person-form-drawer-title">
  <div class="contact-drawer-backdrop" id="person-form-drawer-backdrop"></div>
  <div class="contact-drawer-panel card person-form-drawer-panel">
    <div class="contact-drawer-header">
      <h2 id="person-form-drawer-title" class="contact-drawer-name">{{ tr.person_form_add }}</h2>
      <button type="button" id="person-form-drawer-close" class="contact-drawer-close btn-icon" title="{{ tr.common_close_esc }}" aria-label="{{ tr.common_close }}">×</button>
    </div>
    <div class="contact-drawer-body person-form-drawer-body">
      <form id="person-form" class="person-form-inner">
        <label for="person-full-name">{{ tr.person_full_name }} <span class="required">*</span></label>
        <input name="full_name" id="person-full-name" placeholder="{{ tr.person_full_name_placeholder }}" required aria-required="true">
        <label for="person-title">{{ tr.people_role }}</label>
        <input name="title" id="person-title" placeholder="{{ tr.people_role }}">
        <label for="person-company-search">{{ tr.people_company }}</label>
        <div class="person-company-combobox">
          <input type="text" id="person-company-search" placeholder="{{ tr.person_company_placeholder }}" autocomplete="off" aria-label="{{ tr.people_company }}" aria-expanded="false" aria-controls="person-company-list">
          <input type="hidden" name="company_id" id="person-company-id" value="">
          <div id="person-company-list" class="person-company-list" role="listbox" hidden></div>
        </div>
        <p class="form-hint" style="margin-top: var(--space-1);">{{ tr.person_company_hint }}</p>
        <label for="person-linkedin-url">LinkedIn URL</label>
        <input name="linkedin_url" id="person-linkedin-url" placeholder="https://www.linkedin.com/in/..." type="url" aria-describedby="person-linkedin-error" aria-invalid="false">
        <p id="person-linkedin-error" class="input-error-text" role="alert" style="display: none;"></p>
        <div class="kol-field-wrap">
          <label class="kol-checkbox-label">
            <input type="checkbox" name="is_kol" value="1" class="kol-checkbox" id="person-is-kol">
            <span class="kol-checkbox-custom" aria-hidden="true"></span>
            <span class="kol-label">{{ tr.person_kol_label }}</span>
          </label>
        </div>
        <p id="person-form-msg" class="person-form-msg"></p>
      </form>
    </div>
    <div class="contact-drawer-footer person-form-drawer-footer">
      <button type="button" id="btn-cancel-add" class="btn secondary">{{ tr.company_cancel }}</button>
      <button type="submit" id="person-form-submit" form="person-form" class="btn primary">{{ tr.company_save }}</button>
    </div>
  </div>
</div>
<style>
  .section-title { margin: 0 0 var(--space-3); font-size: var(--text-16); font-weight: 600; color: var(--text); }
  .people-card { padding: var(--space-6); border-radius: var(--radius); box-shadow: var(--elevation-1); border: 1px solid var(--border); }
  .people-card .btn-add-contact { margin: 0; }
  .people-card .btn-add-contact:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .people-card .btn-add-contact[aria-expanded="true"] .btn-add-icon { transform: rotate(45deg); }
  .btn-add-icon { display: inline-block; font-size: 1.25rem; line-height: 1; transition: transform var(--motion-fast); }
  .people-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4); }
  .people-search-wrap { display: flex; align-items: center; gap: var(--space-2); flex: 1; min-width: 200px; max-width: 28rem; position: relative; }
  .people-search-input { flex: 1; min-width: 0; padding: var(--space-2) var(--space-3) var(--space-2) 2.25rem; font-size: var(--text-14); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 0.65rem center; transition: border-color var(--motion-fast), box-shadow var(--motion-fast); }
  .people-search-input:focus { outline: none; border-color: var(--primary); box-shadow: var(--focus-ring); }
  .people-search-input:focus-visible { outline: none; }
  .people-search-input::placeholder { color: var(--text-muted); }
  .people-search-clear { position: absolute; right: var(--space-2); min-width: 32px; min-height: 32px; padding: 0; border: none; background: transparent; color: var(--text-muted); font-size: 1.25rem; line-height: 1; cursor: pointer; border-radius: var(--radius-sm); }
  .people-search-clear:hover { color: var(--text); background: var(--border); }
  .people-search-clear:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .people-kol-toggle { display: inline-flex; align-items: center; gap: var(--space-2); font-size: var(--text-14); color: var(--text); cursor: pointer; margin: 0; }
  .people-kol-toggle input { width: 1.125rem; height: 1.125rem; }
  .people-kol-toggle input:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .error-state-card { padding: var(--space-8); text-align: center; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); margin-top: var(--space-4); }
  .error-state-text { margin: 0 0 var(--space-4); font-weight: 600; font-size: var(--text-16); color: var(--text); }
  .error-state-card .btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .empty-state-card .btn + .btn { margin-left: var(--space-2); }
  .loading-skeleton-inline { margin-top: var(--space-2); }
  .skeleton-line { height: 40px; border-radius: var(--radius-sm); background: linear-gradient(90deg, var(--border) 25%, var(--bg) 50%, var(--border) 75%); background-size: 200% 100%; animation: skeleton 1s ease-in-out infinite; margin-bottom: var(--space-2); }
  .empty-state-card { padding: var(--space-8); text-align: center; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); margin-top: var(--space-4); }
  .empty-state-title { margin: 0 0 var(--space-2); font-weight: 600; font-size: var(--text-16); color: var(--text); }
  .empty-state-desc { margin: 0 0 var(--space-4); font-size: var(--text-14); color: var(--text-muted); }
  .empty-state-card .btn { margin: 0; }
  .empty-state-card .btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  @keyframes skeleton { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  .people-list-wrap { margin-top: var(--space-2); overflow-x: auto; }
  .people-table-main { width: 100%; border-collapse: collapse; font-size: var(--text-14); }
  .people-table-main th,
  .people-table-main td { padding: var(--space-3) var(--space-4); text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
  .people-table-main th { font-weight: 600; color: var(--text-muted); font-size: var(--text-12); text-transform: uppercase; letter-spacing: 0.03em; background: var(--bg); }
  .people-table-main tbody tr.contact-row { cursor: pointer; transition: background var(--motion-fast); }
  .people-table-main tbody tr.contact-row:hover { background: var(--primary-soft); }
  .people-table-main tbody tr.contact-row:hover .contact-name-link { color: var(--primary); }
  .people-table-main tbody tr.contact-row:focus-within { outline: none; background: var(--primary-soft); }
  .people-table-main .contact-name-link { font-weight: 500; color: var(--text); text-decoration: none; }
  .people-table-main .contact-name-link:hover { color: var(--primary); text-decoration: underline; }
  .people-table-main .linkedin-link { display: inline-flex; align-items: center; justify-content: center; width: 2.25rem; height: 2.25rem; min-width: 44px; min-height: 44px; color: var(--text-muted); border-radius: var(--radius-sm); }
  .people-table-main .linkedin-link:hover { color: var(--primary); background: var(--primary-soft); }
  .people-table-main .linkedin-link:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .people-table-main .row-actions { display: flex; align-items: center; gap: var(--space-1); }
  .people-table-main .kebab-wrap { position: relative; }
  .people-table-main .kebab-menu { position: absolute; right: 0; top: 100%; margin-top: var(--space-1); min-width: 160px; z-index: 10; list-style: none; margin: 0; padding: var(--space-1); background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--elevation-2); }
  .people-table-main .kebab-menu[hidden] { display: none !important; }
  .people-table-main .kebab-item { display: block; width: 100%; padding: var(--space-2) var(--space-3); text-align: left; font-size: var(--text-14); background: none; border: none; cursor: pointer; border-radius: var(--radius-sm); color: var(--text); }
  .people-table-main .kebab-item.danger { color: var(--danger); }
  .people-table-main .kebab-item.danger:hover { background: var(--danger-soft); }
  .people-table-main .btn-icon { min-width: 44px; min-height: 44px; padding: 0; border: none; background: var(--bg); color: var(--text-muted); cursor: pointer; border-radius: var(--radius-sm); display: inline-flex; align-items: center; justify-content: center; }
  .people-table-main .btn-icon:hover { background: var(--border); color: var(--text); }
  .people-table-main .btn-icon:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .people-table-main .badge { background: var(--primary-soft); color: var(--primary); font-size: var(--text-12); font-weight: 500; padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); }
  .contact-name-link { color: var(--primary); cursor: pointer; font-weight: 500; }
  .contact-name-link:hover { text-decoration: underline; }
  .person-form-inner { max-width: 100%; }
  .person-form-inner label { display: block; margin-bottom: var(--space-1); font-size: var(--text-14); font-weight: 500; color: var(--text); }
  .person-form-inner input[type="text"], .person-form-inner input[type="url"] { width: 100%; margin-bottom: var(--space-3); padding: var(--space-2) var(--space-3); font-size: var(--text-14); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface); transition: border-color var(--motion-fast), box-shadow var(--motion-fast); }
  .person-form-inner input:focus { outline: none; border-color: var(--primary); box-shadow: var(--focus-ring); }
  .person-form-inner input.input-error { border-color: var(--danger); }
  .person-form-inner .required { color: var(--danger); }
  .form-hint { margin: calc(-1 * var(--space-2)) 0 var(--space-3); font-size: var(--text-12); color: var(--text-muted); }
  .input-error-text { color: var(--danger); font-size: var(--text-14); margin-top: var(--space-1); }
  .kol-field-wrap { margin-top: var(--space-4); margin-bottom: var(--space-2); padding: var(--space-4); background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); }
  .kol-checkbox-label { display: flex !important; align-items: center; gap: var(--space-3); margin: 0 !important; cursor: pointer; }
  .kol-checkbox { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
  .kol-checkbox-custom { position: relative; flex-shrink: 0; width: 1.25rem; height: 1.25rem; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--surface); transition: border-color var(--motion-fast), background var(--motion-fast), box-shadow var(--motion-fast); }
  .kol-checkbox:focus-visible + .kol-checkbox-custom { box-shadow: var(--focus-ring); }
  .kol-checkbox:checked + .kol-checkbox-custom { background: var(--primary); border-color: var(--primary); }
  .kol-checkbox:checked + .kol-checkbox-custom::after { content: ''; position: absolute; left: 0.35rem; top: 0.1rem; width: 0.4rem; height: 0.7rem; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
  .kol-label { font-weight: 600; font-size: var(--text-14); color: var(--text); }
  .person-form-msg { margin: var(--space-2) 0 0 0; font-size: var(--text-14); }
  .person-company-combobox { position: relative; margin-bottom: var(--space-3); }
  .person-company-combobox input[type="text"] { margin-bottom: 0; }
  .person-company-list { position: absolute; left: 0; right: 0; top: 100%; margin-top: 2px; max-height: 220px; overflow-y: auto; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--elevation-2); z-index: 10; }
  .person-company-list[hidden] { display: none !important; }
  .person-company-item { display: block; width: 100%; padding: var(--space-2) var(--space-3); text-align: left; font-size: var(--text-14); background: none; border: none; cursor: pointer; color: var(--text); border-radius: 0; transition: background var(--motion-fast); }
  .person-company-item:hover { background: var(--primary-soft); }
  .person-company-item:focus-visible { outline: none; box-shadow: inset var(--focus-ring); }
  .person-company-item.create { font-weight: 500; color: var(--primary); }
  /* Contact drawer (right panel) */
  .contact-drawer { position: fixed; inset: 0; z-index: 100; display: none; pointer-events: none; }
  .contact-drawer.is-open { display: block; pointer-events: auto; }
  .contact-drawer-backdrop { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.35); backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.25s ease; }
  .contact-drawer.is-open .contact-drawer-backdrop { opacity: 1; }
  .contact-drawer-panel { position: absolute; top: 0; right: 0; width: 100%; max-width: 440px; height: 100%; margin: 0; border-radius: 0; box-shadow: -8px 0 32px rgba(0,0,0,0.12); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; background: var(--surface); }
  .contact-drawer.is-open .contact-drawer-panel { transform: translateX(0); }
  .contact-drawer-header { display: flex; flex-wrap: wrap; align-items: flex-start; gap: var(--space-2) var(--space-3); padding: var(--space-4); border-bottom: 1px solid var(--border); }
  .contact-drawer-name { margin: 0; font-size: var(--text-20); font-weight: 600; color: var(--text); line-height: 1.3; flex: 1 1 100%; }
  .contact-drawer-company { font-size: var(--text-14); color: var(--text-muted); }
  .contact-drawer-kebab-wrap { position: relative; }
  .contact-drawer-actions { display: flex; flex-wrap: wrap; align-items: center; gap: var(--space-2); }
  .contact-drawer-close { margin-left: auto; min-width: 44px; min-height: 44px; padding: 0; border: none; background: var(--bg); color: var(--text-muted); font-size: 1.5rem; line-height: 1; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background var(--motion-fast), color var(--motion-fast); }
  .contact-drawer-close:hover { background: var(--border); color: var(--text); }
  .contact-drawer-close:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .contact-drawer-body { padding: var(--space-4); overflow-y: auto; flex: 1; min-height: 0; }
  .contact-drawer-section { margin-bottom: var(--space-6); }
  .contact-drawer-section-title { margin: 0 0 var(--space-3); font-size: var(--text-14); font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.03em; }
  .contact-drawer-dl { margin: 0; font-size: var(--text-14); display: grid; gap: var(--space-1) var(--space-4); grid-template-columns: auto 1fr; }
  .contact-drawer-dl dt { color: var(--text-muted); font-weight: 500; }
  .contact-drawer-dl dd { margin: 0; color: var(--text); overflow-wrap: break-word; }
  .contact-drawer-dl dd:empty::after { content: '—'; color: var(--text-muted); }
  .contact-drawer-notes { width: 100%; min-height: 80px; padding: var(--space-2) var(--space-3); font-size: var(--text-14); border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface); resize: vertical; }
  .contact-drawer-notes:focus { outline: none; border-color: var(--primary); box-shadow: var(--focus-ring); }
  .btn-sm { padding: var(--space-1) var(--space-3); font-size: var(--text-12); }
  .contact-drawer-posts-empty { margin: 0; font-size: var(--text-14); color: var(--text-muted); line-height: 1.5; }
  .contact-drawer-posts-empty a { color: var(--primary); font-weight: 500; }
  .person-form-drawer-panel { display: flex; flex-direction: column; }
  .person-form-drawer-body { flex: 1; overflow-y: auto; }
  .person-form-drawer-footer { display: flex; gap: var(--space-2); justify-content: flex-end; padding: var(--space-4); border-top: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
  .person-form-drawer-footer .btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
  .contact-drawer .kebab-menu { position: absolute; right: 0; top: 100%; margin-top: var(--space-1); min-width: 140px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--elevation-2); z-index: 20; padding: var(--space-1); }
  .contact-drawer .kebab-trigger { min-width: 44px; min-height: 44px; }
</style>
<script>
  const tr = window.__tr || {};
  const personLinkedinInput = document.getElementById('person-linkedin-url');
  const personLinkedinError = document.getElementById('person-linkedin-error');
  const personFormSubmit = document.getElementById('person-form-submit');
  const personCompanySearch = document.getElementById('person-company-search');
  const personCompanyId = document.getElementById('person-company-id');
  const personCompanyList = document.getElementById('person-company-list');

  function isValidLinkedInUrl(v) {
    if (!v || !v.trim()) return true;
    return /linkedin\.com/i.test(v.trim());
  }
  function validatePersonForm() {
    const fullName = (document.getElementById('person-full-name') || {}).value;
    const linkedinValid = isValidLinkedInUrl(personLinkedinInput ? personLinkedinInput.value : '');
    personLinkedinInput.classList.toggle('input-error', !linkedinValid);
    if (personLinkedinError) {
      personLinkedinError.style.display = linkedinValid ? 'none' : 'block';
      personLinkedinError.textContent = linkedinValid ? '' : (tr.person_linkedin_error || 'Enter a valid LinkedIn URL (linkedin.com).');
    }
    personLinkedinInput.setAttribute('aria-invalid', linkedinValid ? 'false' : 'true');
    const canSave = !!fullName.trim() && linkedinValid;
    if (personFormSubmit) personFormSubmit.disabled = !canSave;
  }
  if (personLinkedinInput) {
    personLinkedinInput.addEventListener('input', validatePersonForm);
    personLinkedinInput.addEventListener('blur', validatePersonForm);
  }
  document.getElementById('person-form').addEventListener('submit', function(e) {
    if (!isValidLinkedInUrl(personLinkedinInput.value)) { e.preventDefault(); validatePersonForm(); return; }
  });

  function renderCompanyList(query) {
    const q = (query || '').trim().toLowerCase();
    const matched = (companiesList || []).filter(c => (c.name || '').toLowerCase().includes(q));
    const exactMatch = matched.find(c => (c.name || '').toLowerCase() === q);
    personCompanyList.innerHTML = '';
    personCompanyList.hidden = true;
    if (!personCompanySearch.value.trim()) {
      matched.slice(0, 20).forEach(c => {
        const el = document.createElement('button');
        el.type = 'button';
        el.className = 'person-company-item';
        el.textContent = c.name || ((tr.company_default_name || 'Company #{}').replace('{}', c.id));
        el.dataset.id = c.id;
        el.dataset.name = c.name || '';
        el.addEventListener('click', () => { personCompanyId.value = c.id; personCompanySearch.value = c.name || ''; personCompanyList.hidden = true; personCompanySearch.setAttribute('aria-expanded', 'false'); validatePersonForm(); });
        personCompanyList.appendChild(el);
      });
    } else {
      matched.slice(0, 15).forEach(c => {
        const el = document.createElement('button');
        el.type = 'button';
        el.className = 'person-company-item';
        el.textContent = c.name || ((tr.company_default_name || 'Company #{}').replace('{}', c.id));
        el.dataset.id = c.id;
        el.dataset.name = c.name || '';
        el.addEventListener('click', () => { personCompanyId.value = c.id; personCompanySearch.value = c.name || ''; personCompanyList.hidden = true; personCompanySearch.setAttribute('aria-expanded', 'false'); validatePersonForm(); });
        personCompanyList.appendChild(el);
      });
      if (q && !exactMatch) {
        const createEl = document.createElement('button');
        createEl.type = 'button';
        createEl.className = 'person-company-item create';
        const nameDisplay = (query || '').trim().slice(0, 40);
        createEl.textContent = (tr.create_company_btn || 'Create «{}»').replace('{}', nameDisplay + ((query || '').trim().length > 40 ? '…' : ''));
        createEl.addEventListener('click', async () => {
          const name = personCompanySearch.value.trim();
          if (!name) return;
          try {
            const res = await fetch('/companies', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
            if (!res.ok) return;
            const company = await res.json();
            companiesList = companiesList || [];
            companiesList.push(company);
            personCompanyId.value = company.id;
            personCompanySearch.value = company.name || '';
            personCompanyList.hidden = true;
            personCompanySearch.setAttribute('aria-expanded', 'false');
            if (typeof window.toast === 'function') window.toast(tr.company_created || 'Company created', 'success');
          } catch (_) {}
        });
        personCompanyList.appendChild(createEl);
      }
    }
    if (personCompanyList.children.length) {
      personCompanyList.hidden = false;
      personCompanySearch.setAttribute('aria-expanded', 'true');
    }
  }
  personCompanySearch.addEventListener('input', () => renderCompanyList(personCompanySearch.value));
  personCompanySearch.addEventListener('focus', () => renderCompanyList(personCompanySearch.value));
  personCompanySearch.addEventListener('blur', () => setTimeout(() => { personCompanyList.hidden = true; personCompanySearch.setAttribute('aria-expanded', 'false'); }, 150));
  document.addEventListener('click', (e) => {
    if (!personCompanySearch.contains(e.target) && !personCompanyList.contains(e.target)) { personCompanyList.hidden = true; personCompanySearch.setAttribute('aria-expanded', 'false'); }
  });

  let companiesList = [];
  fetch('/companies').then(r => r.json()).then(companies => {
    companiesList = companies || [];
    loadPeople();
  }).catch(() => { loadPeople(); });

  function splitFullName(fullName) {
    const s = (fullName || '').trim();
    if (!s) return { firstName: '', lastName: '' };
    const parts = s.split(/\s+/);
    if (parts.length === 1) return { firstName: parts[0], lastName: '' };
    const lastName = parts.pop();
    return { firstName: parts.join(' '), lastName };
  }

  const peopleLoading = document.getElementById('people-loading');
  const peopleListWrap = document.getElementById('people-list-wrap');
  const peopleEmpty = document.getElementById('people-empty');
  const peopleSearchEmpty = document.getElementById('people-search-empty');
  const peopleError = document.getElementById('people-error');
  const peopleSearchInput = document.getElementById('people-search');
  const peopleSearchClear = document.getElementById('people-search-clear');
  const peopleKolOnly = document.getElementById('people-kol-only');
  let lastPeopleList = [];
  let lastCompanyMap = {};
  let peopleFilterStr = '';
  let peopleFilterKol = false;

  document.addEventListener('click', (e) => {
    if (e.target.closest && e.target.closest('.kebab-wrap')) return;
    if (e.target.closest && e.target.closest('.contact-drawer-kebab-wrap')) return;
    if (!peopleListWrap) return;
    peopleListWrap.querySelectorAll('.kebab-menu').forEach(m => { m.hidden = true; });
    peopleListWrap.querySelectorAll('.kebab-trigger').forEach(b => b.setAttribute('aria-expanded', 'false'));
    const drawerMenu = document.getElementById('contact-drawer-kebab-menu');
    if (drawerMenu) drawerMenu.hidden = true;
  });
  function personMatchesSearch(p, companyName, q) {
    if (!q || !q.trim()) return true;
    const s = q.trim().toLowerCase();
    const full = (p.full_name || '').toLowerCase();
    const title = (p.title || '').toLowerCase();
    const company = (companyName || '').toLowerCase();
    return full.includes(s) || title.includes(s) || company.includes(s);
  }
  function getCompanyName(p, companyMap) {
    if (p.company_id == null) return '—';
    return companyMap[p.company_id] || ((tr.company_default_name || 'Company #{}').replace('{}', p.company_id));
  }
  function renderPeopleTable(peopleList, companyMap, filterStr, kolOnly) {
    let list = peopleList || [];
    if (filterStr && filterStr.trim()) list = list.filter(p => personMatchesSearch(p, getCompanyName(p, companyMap), filterStr));
    if (kolOnly) list = list.filter(p => !!p.is_kol);
    const hasFilters = !!(filterStr && filterStr.trim()) || !!kolOnly;
    if (peopleError) peopleError.style.display = 'none';
    peopleSearchEmpty.style.display = (hasFilters && list.length === 0) ? 'block' : 'none';
    peopleEmpty.style.display = 'none';
    if (list.length === 0 && !hasFilters) {
      peopleListWrap.innerHTML = '';
      peopleListWrap.style.display = 'none';
      peopleEmpty.style.display = 'block';
      peopleSearchEmpty.style.display = 'none';
      return;
    }
    if (list.length === 0) {
      peopleListWrap.innerHTML = '';
      peopleListWrap.style.display = 'none';
      return;
    }
    peopleListWrap.style.display = 'block';
    const linkedinSvg = '<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" aria-hidden="true"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>';
    const kebabSvg = '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16" aria-hidden="true"><circle cx="12" cy="6" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="18" r="1.5"/></svg>';
    const rows = list.map(p => {
      const fullName = (p.full_name || '').trim() || '—';
      const companyName = getCompanyName(p, companyMap);
      const linkedinCell = (p.linkedin_url && p.linkedin_url.trim())
        ? '<a href="' + escapeHtml(p.linkedin_url.trim()) + '" target="_blank" rel="noopener" class="linkedin-link" title="' + (tr.people_open_linkedin || 'Open LinkedIn') + '" aria-label="' + (tr.people_open_linkedin || 'Open LinkedIn') + '">' + linkedinSvg + '</a>'
        : '—';
      const kolCell = p.is_kol ? '<span class="badge">KOL</span>' : '—';
      const actionsCell = '<div class="row-actions" onclick="event.stopPropagation()"><div class="kebab-wrap"><button type="button" class="btn-icon kebab-trigger" aria-label="' + (tr.people_actions || 'Actions') + '" aria-expanded="false" aria-haspopup="menu" data-person-id="' + p.id + '">' + kebabSvg + '</button><div class="kebab-menu" role="menu" hidden><button type="button" class="kebab-item btn-edit-person" role="menuitem" data-person-id="' + p.id + '">' + (tr.setup_edit || 'Edit') + '</button><button type="button" class="kebab-item btn-delete-person danger" role="menuitem" data-person-id="' + p.id + '">' + (tr.companies_delete || 'Delete') + '</button></div></div></div>';
      const linkedinCellContent = (p.linkedin_url && p.linkedin_url.trim()) ? '<a href="' + escapeHtml(p.linkedin_url.trim()) + '" target="_blank" rel="noopener" class="linkedin-link" title="' + (tr.people_open_linkedin || 'Open LinkedIn') + '" aria-label="' + (tr.people_open_linkedin || 'Open LinkedIn') + '">' + linkedinSvg + '</a>' : '—';
      return '<tr class="contact-row" data-person-id="' + p.id + '" tabindex="0" role="button"><td><a href="#" class="contact-name-link open-contact" data-person-id="' + p.id + '">' + escapeHtml(fullName) + '</a></td><td>' + escapeHtml(p.title || '—') + '</td><td>' + escapeHtml(companyName) + '</td><td>' + kolCell + '</td><td>' + linkedinCellContent + '</td><td>' + actionsCell + '</td></tr>';
    }).join('');
    peopleListWrap.innerHTML = '<table class="people-table-main" role="grid"><thead><tr><th scope="col">' + (tr.common_name || 'Name') + '</th><th scope="col">' + (tr.people_role || 'Position') + '</th><th scope="col">' + (tr.people_company || 'Company') + '</th><th scope="col">' + (tr.people_thought_leader || 'Thought leader') + '</th><th scope="col">LinkedIn</th><th scope="col"></th></tr></thead><tbody>' + rows + '</tbody></table>';
    peopleListWrap.querySelectorAll('.contact-row').forEach(row => {
      row.addEventListener('click', (e) => {
        if (e.target.closest('.row-actions')) return;
        const id = parseInt(row.dataset.personId, 10);
        openContactDrawer(id, row);
      });
      row.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter' && e.key !== ' ') return;
        if (e.target.closest('.row-actions')) return;
        e.preventDefault();
        openContactDrawer(parseInt(row.dataset.personId, 10), row);
      });
    });
    peopleListWrap.querySelectorAll('.open-contact').forEach(btn => {
      btn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openContactDrawer(parseInt(btn.dataset.personId, 10), btn); });
    });
    peopleListWrap.querySelectorAll('.kebab-trigger').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const menu = btn.closest('.kebab-wrap').querySelector('.kebab-menu');
        const isOpen = !menu.hidden;
        peopleListWrap.querySelectorAll('.kebab-menu').forEach(m => { m.hidden = true; });
        peopleListWrap.querySelectorAll('.kebab-trigger').forEach(b => b.setAttribute('aria-expanded', 'false'));
        if (!isOpen) { menu.hidden = false; btn.setAttribute('aria-expanded', 'true'); }
      });
    });
    peopleListWrap.querySelectorAll('.btn-edit-person').forEach(btn => {
      btn.addEventListener('click', (e) => { e.stopPropagation(); btn.closest('.kebab-menu').hidden = true; openFormDrawer(parseInt(btn.dataset.personId, 10)); });
    });
    peopleListWrap.querySelectorAll('.btn-delete-person').forEach(btn => {
      btn.addEventListener('click', (e) => { e.stopPropagation(); btn.closest('.kebab-menu').hidden = true; deletePerson(parseInt(btn.dataset.personId, 10)); });
    });
  }
  function applyPeopleFilters() {
    peopleFilterStr = peopleSearchInput ? peopleSearchInput.value : '';
    peopleFilterKol = peopleKolOnly ? peopleKolOnly.checked : false;
    if (peopleSearchClear) peopleSearchClear.style.display = (peopleFilterStr && peopleFilterStr.trim()) ? 'block' : 'none';
    renderPeopleTable(lastPeopleList, lastCompanyMap, peopleFilterStr, peopleFilterKol);
  }
  function loadPeople() {
    if (peopleLoading) peopleLoading.style.display = 'block';
    if (peopleEmpty) peopleEmpty.style.display = 'none';
    if (peopleError) peopleError.style.display = 'none';
    if (peopleListWrap) peopleListWrap.style.display = 'none';
    fetch('/people').then(r => r.json()).then(people => {
      if (peopleLoading) peopleLoading.style.display = 'none';
      const companyMap = {};
      (companiesList || []).forEach(c => { companyMap[c.id] = c.name || ''; });
      lastCompanyMap = companyMap;
      lastPeopleList = people || [];
      if (!lastPeopleList.length) {
        if (peopleEmpty) peopleEmpty.style.display = 'block';
        if (peopleSearchEmpty) peopleSearchEmpty.style.display = 'none';
        if (peopleListWrap) peopleListWrap.innerHTML = '';
        return;
      }
      applyPeopleFilters();
      const openId = new URLSearchParams(location.search).get('open');
      if (openId) openContactDrawer(parseInt(openId, 10));
    }).catch(() => {
      if (peopleLoading) peopleLoading.style.display = 'none';
      if (peopleError) peopleError.style.display = 'block';
      if (peopleEmpty) peopleEmpty.style.display = 'none';
      if (peopleListWrap) peopleListWrap.style.display = 'none';
    });
  }
  if (peopleSearchInput) {
    peopleSearchInput.addEventListener('input', applyPeopleFilters);
    peopleSearchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        peopleSearchInput.value = '';
        if (peopleSearchClear) peopleSearchClear.style.display = 'none';
        applyPeopleFilters();
        peopleSearchInput.blur();
      }
    });
  }
  if (peopleSearchClear) peopleSearchClear.addEventListener('click', () => { peopleSearchInput.value = ''; peopleSearchClear.style.display = 'none'; applyPeopleFilters(); peopleSearchInput.focus(); });
  if (peopleKolOnly) peopleKolOnly.addEventListener('change', applyPeopleFilters);
  document.getElementById('people-reset-filters').addEventListener('click', () => {
    peopleSearchInput.value = '';
    if (peopleKolOnly) peopleKolOnly.checked = false;
    if (peopleSearchClear) peopleSearchClear.style.display = 'none';
    applyPeopleFilters();
  });
  document.getElementById('people-error-retry').addEventListener('click', loadPeople);
  document.getElementById('people-empty-cta').addEventListener('click', () => document.getElementById('btn-toggle-add').click());

  let currentContactId = null;
  let contactDrawerRestoreFocus = null;
  const contactDrawer = document.getElementById('contact-drawer');
  const contactDrawerBackdrop = document.getElementById('contact-drawer-backdrop');
  function getContactDrawerFocusables() {
    const panel = contactDrawer ? contactDrawer.querySelector('.contact-drawer-panel') : null;
    if (!panel) return [];
    return [].slice.call(panel.querySelectorAll('a[href], button:not([disabled]), textarea, [tabindex]:not([tabindex="-1"])')).filter(el => !el.hidden && el.offsetParent !== null);
  }
  function trapContactDrawerFocus(e) {
    if (e.key !== 'Tab' || !contactDrawer.classList.contains('is-open')) return;
    const focusables = getContactDrawerFocusables();
    if (focusables.length === 0) return;
    const first = focusables[0], last = focusables[focusables.length - 1];
    if (e.shiftKey) { if (document.activeElement === first) { e.preventDefault(); last.focus(); } }
    else { if (document.activeElement === last) { e.preventDefault(); first.focus(); } }
  }
  contactDrawer.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { closeContactDrawer(); e.preventDefault(); }
    trapContactDrawerFocus(e);
  });
  function closeContactDrawer() {
    contactDrawer.classList.remove('is-open');
    contactDrawer.setAttribute('aria-hidden', 'true');
    setTimeout(() => {
      contactDrawer.style.display = 'none';
      if (contactDrawerRestoreFocus && typeof contactDrawerRestoreFocus.focus === 'function') contactDrawerRestoreFocus.focus();
      contactDrawerRestoreFocus = null;
    }, 300);
  }
  document.getElementById('contact-drawer-close').addEventListener('click', closeContactDrawer);
  contactDrawerBackdrop.addEventListener('click', closeContactDrawer);
  async function openContactDrawer(id, restoreEl) {
    contactDrawerRestoreFocus = restoreEl || document.activeElement;
    contactDrawer.style.display = 'block';
    contactDrawer.setAttribute('aria-hidden', 'false');
    contactDrawer.classList.add('is-open');
    try {
      const res = await fetch('/people/' + id);
      if (!res.ok) { closeContactDrawer(); if (typeof window.toast === 'function') window.toast(tr.contact_not_found || 'Contact not found', 'error'); return; }
      const p = await res.json();
      currentContactId = id;
      const companyName = (p.company_id != null && companiesList.length) ? (companiesList.find(c => c.id === p.company_id) || {}).name || (tr.company_default_name || 'Company #{}').replace('{}', p.company_id) : '—';
      document.getElementById('contact-drawer-title').textContent = p.full_name || '—';
      document.getElementById('contact-drawer-company').textContent = companyName;
      const kolBadge = document.getElementById('contact-drawer-kol-badge');
      kolBadge.style.display = p.is_kol ? 'inline-block' : 'none';
      const linkBtn = document.getElementById('contact-drawer-linkedin');
      if (p.linkedin_url && p.linkedin_url.trim()) {
        linkBtn.href = p.linkedin_url.trim();
        linkBtn.style.display = 'inline-flex';
      } else linkBtn.style.display = 'none';
      document.getElementById('contact-drawer-title-val').textContent = p.title || '—';
      document.getElementById('contact-drawer-company-val').textContent = companyName;
      const linkedinVal = document.getElementById('contact-drawer-linkedin-val');
      if (p.linkedin_url && p.linkedin_url.trim()) {
        linkedinVal.innerHTML = '';
        const a = document.createElement('a');
        a.href = p.linkedin_url.trim();
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = tr.contact_linkedin_profile || 'LinkedIn profile';
        a.className = 'contact-name-link';
        linkedinVal.appendChild(a);
      } else linkedinVal.textContent = '—';
      document.getElementById('contact-drawer-kol-val').textContent = p.is_kol ? (tr.contact_yes || 'Yes') : (tr.contact_no || 'No');
      const notesEl = document.getElementById('contact-drawer-notes');
      notesEl.value = (p.notes || '').trim();
      requestAnimationFrame(() => { const focusables = getContactDrawerFocusables(); if (focusables.length) focusables[0].focus(); });
    } catch (e) {
      closeContactDrawer();
      if (typeof window.toast === 'function') window.toast(tr.contact_load_error || 'Failed to load contact', 'error');
    }
  }
  document.getElementById('contact-drawer-notes-save').addEventListener('click', async () => {
    if (currentContactId == null) return;
    const notes = document.getElementById('contact-drawer-notes').value;
    try {
      const res = await fetch('/people/' + currentContactId, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ notes: notes || null }) });
      if (res.ok && typeof window.toast === 'function') window.toast(tr.contact_notes_saved || 'Notes saved', 'success');
    } catch (_) {}
  });
  document.getElementById('contact-drawer-edit').addEventListener('click', () => {
    if (currentContactId != null) { closeContactDrawer(); openFormDrawer(currentContactId); }
  });
  document.getElementById('contact-drawer-kebab').addEventListener('click', (e) => {
    e.stopPropagation();
    const menu = document.getElementById('contact-drawer-kebab-menu');
    const isOpen = !menu.hidden;
    menu.hidden = isOpen;
    document.getElementById('contact-drawer-kebab').setAttribute('aria-expanded', !isOpen);
  });
  document.querySelector('.btn-contact-drawer-delete').addEventListener('click', () => {
    document.getElementById('contact-drawer-kebab-menu').hidden = true;
    if (currentContactId != null) { deletePerson(currentContactId); closeContactDrawer(); }
  });

  let editingPersonId = null;
  const formDrawer = document.getElementById('person-form-drawer');
  const formDrawerBackdrop = document.getElementById('person-form-drawer-backdrop');
  const formDrawerTitle = document.getElementById('person-form-drawer-title');
  let formDrawerRestoreFocus = null;
  function getFormDrawerFocusables() {
    const panel = formDrawer ? formDrawer.querySelector('.contact-drawer-panel') : null;
    if (!panel) return [];
    return [].slice.call(panel.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), textarea, select, [tabindex]:not([tabindex="-1"])')).filter(el => !el.hidden && el.offsetParent !== null);
  }
  function trapFormDrawerFocus(e) {
    if (e.key !== 'Tab' || !formDrawer.classList.contains('is-open')) return;
    const focusables = getFormDrawerFocusables();
    if (focusables.length === 0) return;
    const first = focusables[0], last = focusables[focusables.length - 1];
    if (e.shiftKey) { if (document.activeElement === first) { e.preventDefault(); last.focus(); } }
    else { if (document.activeElement === last) { e.preventDefault(); first.focus(); } }
  }
  formDrawer.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { closeFormDrawer(); e.preventDefault(); }
    trapFormDrawerFocus(e);
  });
  function closeFormDrawer() {
    formDrawer.classList.remove('is-open');
    formDrawer.setAttribute('aria-hidden', 'true');
    document.getElementById('btn-toggle-add').setAttribute('aria-expanded', 'false');
    setTimeout(() => {
      formDrawer.style.display = 'none';
      if (formDrawerRestoreFocus && typeof formDrawerRestoreFocus.focus === 'function') formDrawerRestoreFocus.focus();
      formDrawerRestoreFocus = null;
    }, 300);
  }
  document.getElementById('person-form-drawer-close').addEventListener('click', closeFormDrawer);
  formDrawerBackdrop.addEventListener('click', closeFormDrawer);
  async function openFormDrawer(editId) {
    formDrawerRestoreFocus = document.activeElement;
    editingPersonId = editId || null;
    formDrawerTitle.textContent = editingPersonId ? (tr.person_form_edit || 'Edit contact') : (tr.person_form_add || 'Add contact');
    const form = document.getElementById('person-form');
    form.reset();
    personCompanyId.value = '';
    personCompanySearch.value = '';
    personCompanyList.hidden = true;
    if (editingPersonId) {
      try {
        const res = await fetch('/people/' + editingPersonId);
        if (!res.ok) { closeFormDrawer(); return; }
        const p = await res.json();
        document.getElementById('person-full-name').value = p.full_name || '';
        document.getElementById('person-title').value = p.title || '';
        personCompanyId.value = (p.company_id != null && p.company_id !== '') ? String(p.company_id) : '';
        const company = companiesList.find(c => c.id === p.company_id);
        personCompanySearch.value = company ? (company.name || '') : '';
        personLinkedinInput.value = p.linkedin_url || '';
        document.getElementById('person-is-kol').checked = !!p.is_kol;
      } catch (e) { closeFormDrawer(); return; }
    }
    validatePersonForm();
    formDrawer.style.display = 'block';
    formDrawer.setAttribute('aria-hidden', 'false');
    formDrawer.classList.add('is-open');
    document.getElementById('btn-toggle-add').setAttribute('aria-expanded', 'true');
    requestAnimationFrame(() => { const focusables = getFormDrawerFocusables(); if (focusables.length) focusables[0].focus(); });
  }
  document.getElementById('btn-toggle-add').addEventListener('click', () => {
    if (formDrawer.classList.contains('is-open')) closeFormDrawer();
    else openFormDrawer();
  });
  document.getElementById('btn-cancel-add').addEventListener('click', () => { editingPersonId = null; closeFormDrawer(); });

  async function deletePerson(id) {
    if (!confirm(tr.delete_contact_confirm || 'Delete this contact?')) return;
    try {
      const res = await fetch('/people/' + id, { method: 'DELETE' });
      if (res.ok) {
        if (typeof window.toast === 'function') window.toast(tr.contact_deleted || 'Contact deleted', 'success');
        loadPeople();
      } else {
        if (typeof window.toast === 'function') window.toast(await res.text(), 'error');
      }
    } catch (e) {
      if (typeof window.toast === 'function') window.toast(tr.delete_contact_error || 'Error deleting', 'error');
    }
  }
  function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  document.getElementById('person-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fullName = (document.getElementById('person-full-name') || {}).value;
    const title = (document.getElementById('person-title') || {}).value;
    const companyIdVal = personCompanyId.value;
    const linkedinUrl = (personLinkedinInput.value || '').trim() || null;
    const isKol = (document.getElementById('person-is-kol') || {}).checked;
    const isEdit = editingPersonId != null;
    const payload = {
      full_name: fullName.trim(),
      title: (title || '').trim() || null,
      company_id: companyIdVal ? parseInt(companyIdVal, 10) : null,
      linkedin_url: linkedinUrl,
      is_kol: isKol
    };
    const url = isEdit ? '/people/' + editingPersonId : '/people';
    const res = await fetch(url, {
      method: isEdit ? 'PATCH' : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      editingPersonId = null;
      e.target.reset();
      personCompanyId.value = '';
      personCompanySearch.value = '';
      if (typeof window.toast === 'function') window.toast(isEdit ? (tr.contact_updated || 'Contact updated') : (tr.contact_added || 'Contact added'), 'success');
      closeFormDrawer();
      loadPeople();
    } else {
      setPersonMsg(await res.text(), true);
    }
  });

  function setPersonMsg(text, isError) {
    const personFormMsg = document.getElementById('person-form-msg');
    if (!personFormMsg) return;
    personFormMsg.textContent = text || '';
    personFormMsg.style.color = isError ? 'var(--danger)' : 'var(--success)';
    personFormMsg.style.display = text ? 'block' : 'none';
    if (text) setTimeout(() => { personFormMsg.textContent = ''; personFormMsg.style.display = 'none'; }, 4000);
  }
</script>
<!--
  QA checklist (Contacts / people UI):
  - Keyboard: focus trap in Contact drawer and Form drawer; Esc closes; focus restored to opener (row or Add button).
  - Aria: icon buttons have aria-label and title; drawer role="dialog" aria-modal aria-labelledby; company combobox aria-expanded, aria-controls.
  - States: loading skeleton, empty (no contacts), no results (filters) with "Сбросить фильтры", error with "Повторить".
  - No API/route/business logic changes; no console errors.
-->
{% endblock %}
